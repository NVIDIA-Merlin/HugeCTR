<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hierarchical Parameter Server Demo &mdash; Merlin HugeCTR  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="canonical" href="https://nvidia-merlin.github.io/HugeCTR/main/notebooks/hps_demo.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script >let toggleHintShow = 'Click to show';</script>
        <script >let toggleHintHide = 'Click to hide';</script>
        <script >let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="HugeCTR Training and Inference with Remote File System Example" href="training_and_inference_with_remote_filesystem.html" />
    <link rel="prev" title="Multi-GPU Offline Inference" href="multi_gpu_offline_inference.html" /> 
</head>

<body class="wy-body-for-nav">
  <div class="banner">
    <p class="banner">
      Beginning in January 2023, versions for all NVIDIA Merlin projects
      will change from semantic versioning like <code>4.0</code>
      to calendar versioning like <code>23.01</code>.</p>
  </div>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Merlin HugeCTR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">HUGECTR</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hugectr_user_guide.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_core_features.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_embedding_training_cache.html">Embedding Training Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hierarchical_parameter_server/index.html">Hierarchical Parameter Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparse_operation_kit.html">Sparse Operation Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Example Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ecommerce-example.html">Merlin ETL, training, and inference with e-Commerce behavior data</a></li>
<li class="toctree-l2"><a class="reference internal" href="movie-lens-example.html">HugeCTR demo on Movie lens data</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr_criteo.html">Introduction to the HugeCTR Python Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr2onnx_demo.html">HugeCTR to ONNX Converter</a></li>
<li class="toctree-l2"><a class="reference internal" href="continuous_training.html">HugeCTR Continuous Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr_wdl_prediction.html">HugeCTR Wide and Deep Model with Criteo</a></li>
<li class="toctree-l2"><a class="reference internal" href="news-example.html">NVIDIA Merlin on Microsoft’s News Dataset (MIND)</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_gpu_offline_inference.html">Multi-GPU Offline Inference</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Hierarchical Parameter Server Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_and_inference_with_remote_filesystem.html">HugeCTR Training and Inference with Remote File System Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="embedding_training_cache_example.html">Embedding Training Cache Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="embedding_collection.html">HugeCTR Embedding Collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr_e2e_demo.html">HugeCTR End-end Example with NVTabular</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="multi-modal-data/index.html">Multi-modal Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional_resources.html">Additional Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_contributor_guide.html">Contributing to HugeCTR</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Merlin HugeCTR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">HugeCTR Example Notebooks</a></li>
      <li class="breadcrumb-item active">Hierarchical Parameter Server Demo</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <img alt="http://developer.download.nvidia.com/notebooks/dlsw-notebooks/merlin_hugectr_hps-demo/nvidia_logo.png" src="http://developer.download.nvidia.com/notebooks/dlsw-notebooks/merlin_hugectr_hps-demo/nvidia_logo.png" />
<div class="tex2jax_ignore mathjax_ignore section" id="hierarchical-parameter-server-demo">
<h1>Hierarchical Parameter Server Demo<a class="headerlink" href="#hierarchical-parameter-server-demo" title="Permalink to this headline"></a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>In HugeCTR version 3.5, we provide Python APIs for embedding table lookup with <a class="reference external" href="https://nvidia-merlin.github.io/HugeCTR/master/hugectr_core_features.html#hierarchical-parameter-server">HugeCTR Hierarchical Parameter Server (HPS)</a>
HPS supports different database backends and GPU embedding caches.</p>
<p>This notebook demonstrates how to use HPS with HugeCTR Python APIs. Without loss of generality, the HPS APIs are utilized together with the ONNX Runtime APIs to create an ensemble inference model, where HPS is responsible for embedding table lookup while the ONNX model takes charge of feed forward of dense neural networks.</p>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline"></a></h2>
<p>To setup the environment, refer to <a class="reference internal" href="index.html"><span class="xref myst">HugeCTR Example Notebooks</span></a> and follow the instructions there before running the following.</p>
</div>
<div class="section" id="data-generation">
<h2>Data Generation<a class="headerlink" href="#data-generation" title="Permalink to this headline"></a></h2>
<p>HugeCTR provides a tool to generate synthetic datasets. The <a class="reference external" href="https://nvidia-merlin.github.io/HugeCTR/master/api/python_interface.html#data-generator-api">Data Generator</a> is capable of generating datasets of different file formats and different distributions. We will generate one-hot Parquet datasets with power-law distribution for this notebook:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hugectr</span>
<span class="kn">from</span> <span class="nn">hugectr.tools</span> <span class="kn">import</span> <span class="n">DataGeneratorParams</span><span class="p">,</span> <span class="n">DataGenerator</span>

<span class="n">data_generator_params</span> <span class="o">=</span> <span class="n">DataGeneratorParams</span><span class="p">(</span>
  <span class="nb">format</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderType_t</span><span class="o">.</span><span class="n">Parquet</span><span class="p">,</span>
  <span class="n">label_dim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">dense_dim</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
  <span class="n">num_slot</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
  <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
  <span class="n">nnz_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;./data_parquet/file_list.txt&quot;</span><span class="p">,</span>
  <span class="n">eval_source</span> <span class="o">=</span> <span class="s2">&quot;./data_parquet/file_list_test.txt&quot;</span><span class="p">,</span>
  <span class="n">slot_size_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">],</span>
  <span class="n">check_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Check_t</span><span class="o">.</span><span class="n">Non</span><span class="p">,</span>
  <span class="n">dist_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Distribution_t</span><span class="o">.</span><span class="n">PowerLaw</span><span class="p">,</span>
  <span class="n">power_law_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">PowerLaw_t</span><span class="o">.</span><span class="n">Short</span><span class="p">,</span>
  <span class="n">num_files</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
  <span class="n">eval_num_files</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
  <span class="n">num_samples_per_file</span> <span class="o">=</span> <span class="mi">40960</span><span class="p">)</span>
<span class="n">data_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data_generator_params</span><span class="p">)</span>
<span class="n">data_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[HCTR][11:15:15][INFO][RK0][main]: Generate Parquet dataset
[HCTR][11:15:15][INFO][RK0][main]: train data folder: ./data_parquet, eval data folder: ./data_parquet, slot_size_array: 10000, 10000, 10000, 10000, nnz array: 1, 1, 1, 1, #files for train: 16, #files for eval: 4, #samples per file: 40960, Use power law distribution: 1, alpha of power law: 1.3
[HCTR][11:15:15][INFO][RK0][main]: ./data_parquet exist
[HCTR][11:15:15][INFO][RK0][main]: ./data_parquet exist
[HCTR][11:15:15][INFO][RK0][main]: ./data_parquet/train exist
[HCTR][11:15:15][INFO][RK0][main]: ./data_parquet/train/gen_0.parquet
[HCTR][11:15:17][INFO][RK0][main]: ./data_parquet/train/gen_1.parquet
[HCTR][11:15:17][INFO][RK0][main]: ./data_parquet/train/gen_2.parquet
[HCTR][11:15:17][INFO][RK0][main]: ./data_parquet/train/gen_3.parquet
[HCTR][11:15:17][INFO][RK0][main]: ./data_parquet/train/gen_4.parquet
[HCTR][11:15:18][INFO][RK0][main]: ./data_parquet/train/gen_5.parquet
[HCTR][11:15:18][INFO][RK0][main]: ./data_parquet/train/gen_6.parquet
[HCTR][11:15:18][INFO][RK0][main]: ./data_parquet/train/gen_7.parquet
[HCTR][11:15:18][INFO][RK0][main]: ./data_parquet/train/gen_8.parquet
[HCTR][11:15:18][INFO][RK0][main]: ./data_parquet/train/gen_9.parquet
[HCTR][11:15:19][INFO][RK0][main]: ./data_parquet/train/gen_10.parquet
[HCTR][11:15:19][INFO][RK0][main]: ./data_parquet/train/gen_11.parquet
[HCTR][11:15:19][INFO][RK0][main]: ./data_parquet/train/gen_12.parquet
[HCTR][11:15:19][INFO][RK0][main]: ./data_parquet/train/gen_13.parquet
[HCTR][11:15:19][INFO][RK0][main]: ./data_parquet/train/gen_14.parquet
[HCTR][11:15:20][INFO][RK0][main]: ./data_parquet/train/gen_15.parquet
[HCTR][11:15:20][INFO][RK0][main]: ./data_parquet/file_list.txt done!
[HCTR][11:15:20][INFO][RK0][main]: ./data_parquet/val exist
[HCTR][11:15:20][INFO][RK0][main]: ./data_parquet/val/gen_0.parquet
[HCTR][11:15:20][INFO][RK0][main]: ./data_parquet/val/gen_1.parquet
[HCTR][11:15:20][INFO][RK0][main]: ./data_parquet/val/gen_2.parquet
[HCTR][11:15:20][INFO][RK0][main]: ./data_parquet/val/gen_3.parquet
[HCTR][11:15:21][INFO][RK0][main]: ./data_parquet/file_list_test.txt done!
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="train-from-scratch">
<h2>Train from Scratch<a class="headerlink" href="#train-from-scratch" title="Permalink to this headline"></a></h2>
<p>We can train fom scratch by performing the following steps with Python APIs:</p>
<ol class="arabic simple">
<li><p>Create the solver, reader and optimizer, then initialize the model.</p></li>
<li><p>Construct the model graph by adding input, sparse embedding and dense layers in order.</p></li>
<li><p>Compile the model and have an overview of the model graph.</p></li>
<li><p>Dump the model graph to the JSON file.</p></li>
<li><p>Fit the model, save the model weights and optimizer states implicitly.</p></li>
<li><p>Dump one batch of evaluation results to files.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> train.py
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hugectr</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">CreateSolver</span><span class="p">(</span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span>
                              <span class="n">max_eval_batches</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">batchsize_eval</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
                              <span class="n">batchsize</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
                              <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
                              <span class="n">vvgpu</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]],</span>
                              <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">repeat_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">use_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderParams</span><span class="p">(</span><span class="n">data_reader_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderType_t</span><span class="o">.</span><span class="n">Parquet</span><span class="p">,</span>
                                  <span class="n">source</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;./data_parquet/file_list.txt&quot;</span><span class="p">],</span>
                                  <span class="n">eval_source</span> <span class="o">=</span> <span class="s2">&quot;./data_parquet/file_list_test.txt&quot;</span><span class="p">,</span>
                                  <span class="n">check_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Check_t</span><span class="o">.</span><span class="n">Non</span><span class="p">,</span>
                                  <span class="n">slot_size_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">CreateOptimizer</span><span class="p">(</span><span class="n">optimizer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Optimizer_t</span><span class="o">.</span><span class="n">Adam</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">label_dim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">label_name</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
                        <span class="n">dense_dim</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dense_name</span> <span class="o">=</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
                        <span class="n">data_reader_sparse_param_array</span> <span class="o">=</span> 
                        <span class="p">[</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderSparseParam</span><span class="p">(</span><span class="s2">&quot;data1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderSparseParam</span><span class="p">(</span><span class="s2">&quot;data2&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">SparseEmbedding</span><span class="p">(</span><span class="n">embedding_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Embedding_t</span><span class="o">.</span><span class="n">DistributedSlotSparseEmbeddingHash</span><span class="p">,</span> 
                            <span class="n">workspace_size_per_gpu_in_mb</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                            <span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                            <span class="n">combiner</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                            <span class="n">sparse_embedding_name</span> <span class="o">=</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
                            <span class="n">bottom_name</span> <span class="o">=</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
                            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">SparseEmbedding</span><span class="p">(</span><span class="n">embedding_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Embedding_t</span><span class="o">.</span><span class="n">DistributedSlotSparseEmbeddingHash</span><span class="p">,</span> 
                            <span class="n">workspace_size_per_gpu_in_mb</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                            <span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
                            <span class="n">combiner</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                            <span class="n">sparse_embedding_name</span> <span class="o">=</span> <span class="s2">&quot;sparse_embedding2&quot;</span><span class="p">,</span>
                            <span class="n">bottom_name</span> <span class="o">=</span> <span class="s2">&quot;data2&quot;</span><span class="p">,</span>
                            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Reshape</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reshape1&quot;</span><span class="p">],</span>
                            <span class="n">leading_dim</span><span class="o">=</span><span class="mi">32</span><span class="p">))</span>                            
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Reshape</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sparse_embedding2&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reshape2&quot;</span><span class="p">],</span>
                            <span class="n">leading_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span>                            
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Concat</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reshape1&quot;</span><span class="p">,</span> <span class="s2">&quot;reshape2&quot;</span><span class="p">,</span> <span class="s2">&quot;dense&quot;</span><span class="p">],</span> <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;concat1&quot;</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">InnerProduct</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;concat1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc1&quot;</span><span class="p">],</span>
                            <span class="n">num_output</span><span class="o">=</span><span class="mi">1024</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">ReLU</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;relu1&quot;</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">InnerProduct</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;relu1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc2&quot;</span><span class="p">],</span>
                            <span class="n">num_output</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">BinaryCrossEntropyLoss</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc2&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">graph_to_json</span><span class="p">(</span><span class="s2">&quot;hps_demo.json&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1100</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">eval_interval</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">snapshot</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">snapshot_prefix</span> <span class="o">=</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">)</span>

<span class="c1"># `model.export_predictions` will open files with `std::ios::out | std::ios::app`. In order to allow</span>
<span class="c1"># repeatedly executing the notebook without altering results, we delete the files here.</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hps_demo_pred_</span><span class="si">{</span><span class="mi">1000</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hps_demo_label_</span><span class="si">{</span><span class="mi">1000</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">export_predictions</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hps_demo_pred_</span><span class="si">{</span><span class="mi">1000</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;hps_demo_label_</span><span class="si">{</span><span class="mi">1000</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting train.py
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python3<span class="w"> </span>train.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HugeCTR Version: 3.4
====================================================Model Init=====================================================
[HCTR][11:15:26][INFO][RK0][main]: Initialize model: hps_demo
[HCTR][11:15:26][INFO][RK0][main]: Global seed is 156170895
[HCTR][11:15:26][INFO][RK0][main]: Device to NUMA mapping:
  GPU 0 -&gt;  node 0
[HCTR][11:15:27][WARNING][RK0][main]: Peer-to-peer access cannot be fully enabled.
[HCTR][11:15:27][INFO][RK0][main]: Start all2all warmup
[HCTR][11:15:27][INFO][RK0][main]: End all2all warmup
[HCTR][11:15:27][INFO][RK0][main]: Using All-reduce algorithm: NCCL
[HCTR][11:15:27][INFO][RK0][main]: Device 0: Tesla V100-SXM2-32GB
[HCTR][11:15:27][INFO][RK0][main]: num of DataReader workers: 1
[HCTR][11:15:27][INFO][RK0][main]: Vocabulary size: 40000
[HCTR][11:15:27][INFO][RK0][main]: max_vocabulary_size_per_gpu_=21845
[HCTR][11:15:27][INFO][RK0][main]: max_vocabulary_size_per_gpu_=21845
[HCTR][11:15:27][INFO][RK0][main]: Graph analysis to resolve tensor dependency
===================================================Model Compile===================================================
[HCTR][11:15:29][INFO][RK0][main]: gpu0 start to init embedding
[HCTR][11:15:29][INFO][RK0][main]: gpu0 init embedding done
[HCTR][11:15:29][INFO][RK0][main]: gpu0 start to init embedding
[HCTR][11:15:29][INFO][RK0][main]: gpu0 init embedding done
[HCTR][11:15:29][INFO][RK0][main]: Starting AUC NCCL warm-up
[HCTR][11:15:29][INFO][RK0][main]: Warm-up done
===================================================Model Summary===================================================
[HCTR][11:15:29][INFO][RK0][main]: label                                   Dense                         Sparse                        
label                                   dense                          data1,data2                   
(None, 1)                               (None, 10)                              
——————————————————————————————————————————————————————————————————————————————————————————————————————————————————
Layer Type                              Input Name                    Output Name                   Output Shape                  
——————————————————————————————————————————————————————————————————————————————————————————————————————————————————
DistributedSlotSparseEmbeddingHash      data1                         sparse_embedding1             (None, 2, 16)                 
------------------------------------------------------------------------------------------------------------------
DistributedSlotSparseEmbeddingHash      data2                         sparse_embedding2             (None, 2, 32)                 
------------------------------------------------------------------------------------------------------------------
Reshape                                 sparse_embedding1             reshape1                      (None, 32)                    
------------------------------------------------------------------------------------------------------------------
Reshape                                 sparse_embedding2             reshape2                      (None, 64)                    
------------------------------------------------------------------------------------------------------------------
Concat                                  reshape1                      concat1                       (None, 106)                   
                                        reshape2                                                                                  
                                        dense                                                                                     
------------------------------------------------------------------------------------------------------------------
InnerProduct                            concat1                       fc1                           (None, 1024)                  
------------------------------------------------------------------------------------------------------------------
ReLU                                    fc1                           relu1                         (None, 1024)                  
------------------------------------------------------------------------------------------------------------------
InnerProduct                            relu1                         fc2                           (None, 1)                     
------------------------------------------------------------------------------------------------------------------
BinaryCrossEntropyLoss                  fc2                           loss                                                        
                                        label                                                                                     
------------------------------------------------------------------------------------------------------------------
[HCTR][11:15:29][INFO][RK0][main]: Save the model graph to hps_demo.json successfully
=====================================================Model Fit=====================================================
[HCTR][11:15:29][INFO][RK0][main]: Use non-epoch mode with number of iterations: 1100
[HCTR][11:15:29][INFO][RK0][main]: Training batchsize: 1024, evaluation batchsize: 1024
[HCTR][11:15:29][INFO][RK0][main]: Evaluation interval: 1000, snapshot interval: 1000
[HCTR][11:15:29][INFO][RK0][main]: Dense network trainable: True
[HCTR][11:15:29][INFO][RK0][main]: Sparse embedding sparse_embedding1 trainable: True
[HCTR][11:15:29][INFO][RK0][main]: Sparse embedding sparse_embedding2 trainable: True
[HCTR][11:15:29][INFO][RK0][main]: Use mixed precision: False, scaler: 1.000000, use cuda graph: True
[HCTR][11:15:29][INFO][RK0][main]: lr: 0.001000, warmup_steps: 1, end_lr: 0.000000
[HCTR][11:15:29][INFO][RK0][main]: decay_start: 0, decay_steps: 1, decay_power: 2.000000
[HCTR][11:15:29][INFO][RK0][main]: Training source file: ./data_parquet/file_list.txt
[HCTR][11:15:29][INFO][RK0][main]: Evaluation source file: ./data_parquet/file_list_test.txt
[HCTR][11:15:29][INFO][RK0][main]: Iter: 200 Time(200 iters): 0.211451s Loss: 0.694128 lr:0.001
[HCTR][11:15:29][INFO][RK0][main]: Iter: 400 Time(200 iters): 0.267199s Loss: 0.689953 lr:0.001
[HCTR][11:15:29][INFO][RK0][main]: Iter: 600 Time(200 iters): 0.216242s Loss: 0.689657 lr:0.001
[HCTR][11:15:29][INFO][RK0][main]: Iter: 800 Time(200 iters): 0.215779s Loss: 0.677149 lr:0.001
[HCTR][11:15:30][INFO][RK0][main]: Iter: 1000 Time(200 iters): 0.219875s Loss: 0.681208 lr:0.001
[HCTR][11:15:30][INFO][RK0][main]: Evaluation, AUC: 0.49589
[HCTR][11:15:30][INFO][RK0][main]: Eval Time for 1 iters: 0.000359s
[HCTR][11:15:30][INFO][RK0][main]: Rank0: Write hash table to file
[HCTR][11:15:30][INFO][RK0][main]: Rank0: Write hash table to file
[HCTR][11:15:30][INFO][RK0][main]: Dumping sparse weights to files, successful
[HCTR][11:15:30][INFO][RK0][main]: Rank0: Write optimzer state to file
[HCTR][11:15:30][INFO][RK0][main]: Done
[HCTR][11:15:30][INFO][RK0][main]: Rank0: Write optimzer state to file
[HCTR][11:15:30][INFO][RK0][main]: Done
[HCTR][11:15:30][INFO][RK0][main]: Rank0: Write optimzer state to file
[HCTR][11:15:30][INFO][RK0][main]: Done
[HCTR][11:15:30][INFO][RK0][main]: Rank0: Write optimzer state to file
[HCTR][11:15:30][INFO][RK0][main]: Done
[HCTR][11:15:30][INFO][RK0][main]: Dumping sparse optimzer states to files, successful
[HCTR][11:15:30][INFO][RK0][main]: Dumping dense weights to file, successful
[HCTR][11:15:30][INFO][RK0][main]: Dumping dense optimizer states to file, successful
[HCTR][11:15:30][INFO][RK0][main]: Finish 1100 iterations with batchsize: 1024 in 1.53s.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="convert-hugectr-to-onnx">
<h2>Convert HugeCTR to ONNX<a class="headerlink" href="#convert-hugectr-to-onnx" title="Permalink to this headline"></a></h2>
<p>We will convert the saved HugeCTR models to ONNX using the HugeCTR to ONNX Converter. For more information about the converter, refer to the README in the <a class="reference external" href="https://github.com/NVIDIA-Merlin/HugeCTR/tree/master/onnx_converter">onnx_converter</a> directory of the repository.</p>
<p>For the sake of double checking the correctness, we will investigate both cases of conversion depending on whether or not to convert the sparse embedding models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hugectr2onnx</span>
<span class="n">hugectr2onnx</span><span class="o">.</span><span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">onnx_model_path</span> <span class="o">=</span> <span class="s2">&quot;hps_demo_with_embedding.onnx&quot;</span><span class="p">,</span>
                            <span class="n">graph_config</span> <span class="o">=</span> <span class="s2">&quot;hps_demo.json&quot;</span><span class="p">,</span>
                            <span class="n">dense_model</span> <span class="o">=</span> <span class="s2">&quot;hps_demo_dense_1000.model&quot;</span><span class="p">,</span>
                            <span class="n">convert_embedding</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">sparse_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hps_demo0_sparse_1000.model&quot;</span><span class="p">,</span> <span class="s2">&quot;hps_demo1_sparse_1000.model&quot;</span><span class="p">])</span>

<span class="n">hugectr2onnx</span><span class="o">.</span><span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">onnx_model_path</span> <span class="o">=</span> <span class="s2">&quot;hps_demo_without_embedding.onnx&quot;</span><span class="p">,</span>
                            <span class="n">graph_config</span> <span class="o">=</span> <span class="s2">&quot;hps_demo.json&quot;</span><span class="p">,</span>
                            <span class="n">dense_model</span> <span class="o">=</span> <span class="s2">&quot;hps_demo_dense_1000.model&quot;</span><span class="p">,</span>
                            <span class="n">convert_embedding</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[HUGECTR2ONNX][INFO]: Converting Data layer to ONNX
[HUGECTR2ONNX][INFO]: Converting DistributedSlotSparseEmbeddingHash layer to ONNX
[HUGECTR2ONNX][INFO]: Converting DistributedSlotSparseEmbeddingHash layer to ONNX
[HUGECTR2ONNX][INFO]: Converting Reshape layer to ONNX
[HUGECTR2ONNX][INFO]: Converting Reshape layer to ONNX
[HUGECTR2ONNX][INFO]: Converting Concat layer to ONNX
[HUGECTR2ONNX][INFO]: Converting InnerProduct layer to ONNX
[HUGECTR2ONNX][INFO]: Converting ReLU layer to ONNX
[HUGECTR2ONNX][INFO]: Converting InnerProduct layer to ONNX
[HUGECTR2ONNX][INFO]: Converting Sigmoid layer to ONNX
[HUGECTR2ONNX][INFO]: The model is checked!
[HUGECTR2ONNX][INFO]: The model is saved at hps_demo_with_embedding.onnx
[HUGECTR2ONNX][INFO]: Converting Data layer to ONNX
Skip sparse embedding layers in converted ONNX model
[HUGECTR2ONNX][INFO]: Converting DistributedSlotSparseEmbeddingHash layer to ONNX
Skip sparse embedding layers in converted ONNX model
[HUGECTR2ONNX][INFO]: Converting DistributedSlotSparseEmbeddingHash layer to ONNX
[HUGECTR2ONNX][INFO]: Converting Reshape layer to ONNX
[HUGECTR2ONNX][INFO]: Converting Reshape layer to ONNX
[HUGECTR2ONNX][INFO]: Converting Concat layer to ONNX
[HUGECTR2ONNX][INFO]: Converting InnerProduct layer to ONNX
[HUGECTR2ONNX][INFO]: Converting ReLU layer to ONNX
[HUGECTR2ONNX][INFO]: Converting InnerProduct layer to ONNX
[HUGECTR2ONNX][INFO]: Converting Sigmoid layer to ONNX
[HUGECTR2ONNX][INFO]: The model is checked!
[HUGECTR2ONNX][INFO]: The model is saved at hps_demo_without_embedding.onnx
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="inference-with-hps-onnx">
<h2>Inference with HPS &amp; ONNX<a class="headerlink" href="#inference-with-hps-onnx" title="Permalink to this headline"></a></h2>
<p>We will make inference by performing the following steps with Python APIs:</p>
<ol class="arabic simple">
<li><p>Configure the HPS hyperparameters. Please refer to <a class="reference external" href="https://nvidia-merlin.github.io/HugeCTR/main/hugectr_parameter_server.html#inference-parameters-and-embedding-cache-configuration">hps configuration</a> for detailed configurations.</p></li>
<li><p>Initialize the HPS object, which is responsible for embedding table lookup.</p></li>
<li><p>Loading the Parquet data.</p></li>
<li><p>Make inference with the HPS object and the ONNX inference session of <code class="docutils literal notranslate"><span class="pre">hps_demo_without_embedding.onnx</span></code>.</p></li>
<li><p>Check the correctness by comparing with dumped evaluation results.</p></li>
<li><p>Make inference with the ONNX inference session of <code class="docutils literal notranslate"><span class="pre">hps_demo_with_embedding.onnx</span></code> (double check).</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hugectr.inference</span> <span class="kn">import</span> <span class="n">HPS</span><span class="p">,</span> <span class="n">ParameterServerConfig</span><span class="p">,</span> <span class="n">InferenceParams</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="nn">ort</span>

<span class="n">slot_size_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="n">key_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">slot_size_array</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="c1"># 1. Configure the HPS hyperparameters</span>
<span class="n">ps_config</span> <span class="o">=</span> <span class="n">ParameterServerConfig</span><span class="p">(</span>
           <span class="n">emb_table_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hps_demo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span> <span class="s2">&quot;sparse_embedding2&quot;</span><span class="p">]},</span>
           <span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hps_demo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">]},</span>
           <span class="n">max_feature_num_per_sample_per_emb_table</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hps_demo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]},</span>
           <span class="n">inference_params_array</span> <span class="o">=</span> <span class="p">[</span>
              <span class="n">InferenceParams</span><span class="p">(</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span>
                <span class="n">max_batchsize</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="n">hit_rate_threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="n">dense_model_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">sparse_model_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hps_demo0_sparse_1000.model&quot;</span><span class="p">,</span> <span class="s2">&quot;hps_demo1_sparse_1000.model&quot;</span><span class="p">],</span>
                <span class="n">deployed_devices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">use_gpu_embedding_cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">cache_size_percentage</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
           <span class="p">])</span>

<span class="c1"># 2. Initialize the HPS object</span>
<span class="n">hps</span> <span class="o">=</span> <span class="n">HPS</span><span class="p">(</span><span class="n">ps_config</span><span class="p">)</span>

<span class="c1"># 3. Loading the Parquet data.</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;data_parquet/val/gen_0.parquet&quot;</span><span class="p">)</span>
<span class="n">dense_input_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
<span class="n">cat_input1_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
<span class="n">cat_input2_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span>
<span class="n">dense_input</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dense_input_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">cat_input1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat_input1_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">cat_input2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat_input2_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># 4. Make inference from the HPS object and the ONNX inference session of `hps_demo_without_embedding.onnx`.</span>
<span class="n">embedding1</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">embedding2</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="s2">&quot;hps_demo_without_embedding.onnx&quot;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">sess</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
               <span class="n">input_feed</span><span class="o">=</span><span class="p">{</span><span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dense_input</span><span class="p">,</span>
               <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">embedding1</span><span class="p">,</span>
               <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">embedding2</span><span class="p">})</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># 5. Check the correctness by comparing with dumped evaluation results.</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;hps_demo_pred_1000&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ground_truth: &quot;</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">-</span><span class="n">ground_truth</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span><span class="o">*</span><span class="n">diff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pred: &quot;</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mse between pred and ground_truth: &quot;</span><span class="p">,</span> <span class="n">mse</span><span class="p">)</span>

<span class="c1"># 6. Make inference with the ONNX inference session of `hps_demo_with_embedding.onnx` (double check).</span>
<span class="n">sess_ref</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="s2">&quot;hps_demo_with_embedding.onnx&quot;</span><span class="p">)</span>
<span class="n">res_ref</span> <span class="o">=</span> <span class="n">sess_ref</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">sess_ref</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                   <span class="n">input_feed</span><span class="o">=</span><span class="p">{</span><span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dense_input</span><span class="p">,</span>
                   <span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cat_input1</span><span class="p">,</span>
                   <span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cat_input2</span><span class="p">})</span>
<span class="n">pred_ref</span> <span class="o">=</span> <span class="n">res_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">diff_ref</span> <span class="o">=</span> <span class="n">pred_ref</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">-</span><span class="n">ground_truth</span>
<span class="n">mse_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_ref</span><span class="o">*</span><span class="n">diff_ref</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pred_ref: &quot;</span><span class="p">,</span> <span class="n">pred_ref</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mse between pred_ref and ground_truth: &quot;</span><span class="p">,</span> <span class="n">mse_ref</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[HCTR][14:09:02.398][WARNING][RK0][main]: default_value_for_each_table.size() is not equal to the number of embedding tables
====================================================HPS Create====================================================
[HCTR][14:09:02.399][INFO][RK0][main]: Creating HashMap CPU database backend...
[HCTR][14:09:02.399][DEBUG][RK0][main]: Created blank database backend in local memory!
[HCTR][14:09:02.399][INFO][RK0][main]: Volatile DB: initial cache rate = 1
[HCTR][14:09:02.399][INFO][RK0][main]: Volatile DB: cache missed embeddings = 0
[HCTR][14:09:02.399][DEBUG][RK0][main]: Created raw model loader in local memory!
[HCTR][14:09:02.399][INFO][RK0][main]: Using Local file system backend.
[HCTR][14:09:02.694][INFO][RK0][main]: Table: hps_et.hps_demo.sparse_embedding1; cached 18479 / 18479 embeddings in volatile database (HashMapBackend); load: 18479 / 18446744073709551615 (0.00%).
[HCTR][14:09:02.694][INFO][RK0][main]: Using Local file system backend.
[HCTR][14:09:02.961][INFO][RK0][main]: Table: hps_et.hps_demo.sparse_embedding2; cached 18466 / 18466 embeddings in volatile database (HashMapBackend); load: 18466 / 18446744073709551615 (0.00%).
[HCTR][14:09:02.961][DEBUG][RK0][main]: Real-time subscribers created!
[HCTR][14:09:02.961][INFO][RK0][main]: Creating embedding cache in device 0.
[HCTR][14:09:02.973][INFO][RK0][main]: Model name: hps_demo
[HCTR][14:09:02.973][INFO][RK0][main]: Max batch size: 1024
[HCTR][14:09:02.973][INFO][RK0][main]: Number of embedding tables: 2
[HCTR][14:09:02.973][INFO][RK0][main]: Use GPU embedding cache: True, cache size percentage: 0.500000
[HCTR][14:09:02.973][INFO][RK0][main]: Use static table: False
[HCTR][14:09:02.973][INFO][RK0][main]: Use I64 input key: True
[HCTR][14:09:02.973][INFO][RK0][main]: Configured cache hit rate threshold: 1.000000
[HCTR][14:09:02.973][INFO][RK0][main]: The size of thread pool: 256
[HCTR][14:09:02.973][INFO][RK0][main]: The size of worker memory pool: 2
[HCTR][14:09:02.973][INFO][RK0][main]: The size of refresh memory pool: 1
[HCTR][14:09:02.973][INFO][RK0][main]: The refresh percentage : 0.000000
[HCTR][14:09:02.998][INFO][RK0][main]: Creating lookup session for hps_demo on device: 0
ground_truth:  [0.542481 0.53327  0.5184   ... 0.509011 0.474065 0.535471]
pred:  [[0.54248124]
 [0.5332703 ]
 [0.5183997 ]
 ...
 [0.509011  ]
 [0.4740651 ]
 [0.53547084]]
mse between pred and ground_truth:  8.599451821747372e-14
pred_ref:  [[0.54248124]
 [0.5332703 ]
 [0.5183997 ]
 ...
 [0.509011  ]
 [0.4740651 ]
 [0.53547084]]
mse between pred_ref and ground_truth:  8.599451821747372e-14
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-01-18 14:09:03.115149162 [W:onnxruntime:, graph.cc:3559 CleanUnusedInitializersAndNodeArgs] Removing initializer &#39;key_to_indice_hash_all_tables&#39;. It is not used by any node and should be removed from the model.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="lookup-the-embedding-vector-from-dlpack">
<h2>Lookup the Embedding Vector from DLPack<a class="headerlink" href="#lookup-the-embedding-vector-from-dlpack" title="Permalink to this headline"></a></h2>
<p>We also provide a <code class="docutils literal notranslate"><span class="pre">lookup_fromdlpack</span></code> interface that could query embedding keys on the <code class="docutils literal notranslate"><span class="pre">CPU</span></code> and return the embedding vectors on the <code class="docutils literal notranslate"><span class="pre">GPU/CPU</span></code>.</p>
<ol class="arabic simple">
<li><p>Suppose you have created a Pytorch/Tensorflow tensor that stores the embedded keys.</p></li>
<li><p>Convert the embedding key tensor to DLPack capsule through the corresponding platform’s <code class="docutils literal notranslate"><span class="pre">to_dlpack</span></code> function.</p></li>
<li><p>Creates an empty tensor as a buffer to store embedding vectors.</p></li>
<li><p>Convert a buffer tensor to DLPack capsule.</p></li>
<li><p>Lookup the embedding vector of the corresponding embedding key directly through <code class="docutils literal notranslate"><span class="pre">lookup_fromdlpack</span></code> interface, and output it to the embedding vector buffer tensor</p></li>
<li><p>If the output capsule is allocated on the GPU, then a  <code class="docutils literal notranslate"><span class="pre">device_id</span></code> needs to be specified in <code class="docutils literal notranslate"><span class="pre">lookup_fromdlpack</span></code> interface for corresponding embedding cache. If not specified, the default value is device 0</p></li>
</ol>
<p>Note: Please make sure that tensorflow or pytorch have been installed correctly in the container</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">embedding1</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">embedding2</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

<span class="c1"># 1. Look up from dlpack for Pytorch tensor on CPU</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Look up from dlpack for Pytorch tensor&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">torch.utils.dlpack</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************Look up from pytorch dlpack on CPU&quot;</span><span class="p">)</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">key_capsule</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">to_dlpack</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The device type of embedding keys that lookup dlpack from hps interface for embedding table 0 of hps_demo: </span><span class="si">{}</span><span class="s2">, the keys: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
<span class="n">out_capsule</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">to_dlpack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="c1"># Lookup the embedding vectors from dlpack</span>
<span class="n">hps</span><span class="o">.</span><span class="n">lookup_fromdlpack</span><span class="p">(</span><span class="n">key_capsule</span><span class="p">,</span> <span class="n">out_capsule</span><span class="p">,</span><span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">out_put</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">from_dlpack</span><span class="p">(</span><span class="n">out_capsule</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[The device type of embedding vectors that lookup dlpack from hps interface for embedding table 0 of hps_demo: </span><span class="si">{}</span><span class="s2">, the vectors: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_put</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">out_put</span><span class="p">))</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">out_put</span><span class="o">-</span><span class="n">embedding1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
<span class="k">if</span> <span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Too large mse between pytorch dlpack on cpu and native HPS lookup api: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pytorch dlpack on cpu  results are consistent with native HPS lookup api, mse: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
    

<span class="c1"># 2. Look up from dlpack for Pytorch tensor on GPU</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************Look up from pytorch dlpack on GPU&quot;</span><span class="p">)</span>
<span class="n">cuda_device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">key_capsule</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">to_dlpack</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">cuda_device</span><span class="p">)</span>
<span class="n">out_capsule</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">to_dlpack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">hps</span><span class="o">.</span><span class="n">lookup_fromdlpack</span><span class="p">(</span><span class="n">key_capsule</span><span class="p">,</span> <span class="n">out_capsule</span><span class="p">,</span><span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">out_put</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">from_dlpack</span><span class="p">(</span><span class="n">out_capsule</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The device type of embedding vectors that lookup dlpack from hps interface for embedding table 0 of hps_demo: </span><span class="si">{}</span><span class="s2">, the vectors: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_put</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">out_put</span><span class="p">))</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">out_put</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">-</span><span class="n">embedding1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
<span class="k">if</span> <span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Too large mse between pytorch dlpack on cpu and native HPS lookup api: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pytorch dlpack on GPU results are consistent with native HPS lookup api, mse: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> Look up from dlpack for Pytorch tensor
************Look up from pytorch dlpack on CPU
The device type of embedding keys that lookup dlpack from hps interface for embedding table 0 of hps_demo: cpu, the keys: tensor([    4, 10000,    17,  ..., 10208,     5, 10012])
[The device type of embedding vectors that lookup dlpack from hps interface for embedding table 0 of hps_demo: cpu, the vectors: tensor([[ 0.0201,  0.0179,  0.0029,  ...,  0.0168, -0.0059,  0.0017]])

Pytorch dlpack on cpu  results are consistent with native HPS lookup api, mse: 0.0
************Look up from pytorch dlpack on GPU
The device type of embedding vectors that lookup dlpack from hps interface for embedding table 0 of hps_demo: cuda:0, the vectors: tensor([ 0.0201,  0.0179,  0.0029,  ...,  0.0168, -0.0059,  0.0017],
       device=&#39;cuda:0&#39;)


Pytorch dlpack on GPU results are consistent with native HPS lookup api, mse: 0.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3. Look up from dlpack for tensorflow tensor on CPU</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Look up from dlpack for Tensorflow tensor&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.dlpack</span> <span class="kn">import</span> <span class="n">dlpack</span>  
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.eager</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">dtypes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***************Look up from tensorflow dlpack on CPU**********&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/CPU:0&#39;</span><span class="p">):</span>
    <span class="n">key_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">out_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">32</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The device type of embedding keys that lookup dlpack from hps interface for embedding table 1 of hps_demo: </span><span class="si">{}</span><span class="s2">, the keys: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_tensor</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">key_tensor</span><span class="p">))</span>
    <span class="n">key_capsule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">to_dlpack</span><span class="p">(</span><span class="n">key_tensor</span><span class="p">)</span>
    <span class="n">out_dlcapsule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">to_dlpack</span><span class="p">(</span><span class="n">out_tensor</span><span class="p">)</span>
<span class="n">hps</span><span class="o">.</span><span class="n">lookup_fromdlpack</span><span class="p">(</span><span class="n">key_capsule</span><span class="p">,</span><span class="n">out_dlcapsule</span><span class="p">,</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">from_dlpack</span><span class="p">(</span><span class="n">out_dlcapsule</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The device type of embedding vectors that lookup dlpack from hps interface for embedding table 1 of hps_demo: </span><span class="si">{}</span><span class="s2">, the vectors: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">out</span><span class="o">-</span><span class="n">embedding2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">32</span><span class="p">)</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
<span class="k">if</span> <span class="n">mse</span><span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Too large mse between tensorflow dlpack on cpu and native HPS lookup api: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mse</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tensorflow dlpack on CPU results are consistent with native HPS lookup api, mse: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mse</span><span class="p">))</span>
    
<span class="c1"># 4. Look up from dlpack for tensorflow tensor on GPU</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***************Look up from tensorflow dlpack on GPU**********&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/GPU:0&#39;</span><span class="p">):</span>
    <span class="n">key_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">out_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">32</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">key_capsule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">to_dlpack</span><span class="p">(</span><span class="n">key_tensor</span><span class="p">)</span>
    <span class="n">out_dlcapsule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">to_dlpack</span><span class="p">(</span><span class="n">out_tensor</span><span class="p">)</span>
<span class="n">hps</span><span class="o">.</span><span class="n">lookup_fromdlpack</span><span class="p">(</span><span class="n">key_capsule</span><span class="p">,</span><span class="n">out_dlcapsule</span><span class="p">,</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">out</span><span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">dlpack</span><span class="o">.</span><span class="n">from_dlpack</span><span class="p">(</span><span class="n">out_dlcapsule</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[HUGECTR][INFO] The device type of embedding vectors that lookup dlpack from hps interface for embedding table 1 of wdl: </span><span class="si">{}</span><span class="s2">, the vectors: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">out</span><span class="o">-</span><span class="n">embedding2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">32</span><span class="p">)</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
<span class="k">if</span> <span class="n">mse</span><span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Too large mse between tensorflow dlpack on cpu and native HPS lookup api: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mse</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tensorflow dlpack on GPU results are consistent with native HPS lookup api, mse: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mse</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Look up from dlpack for Tensorflow tensor
***************Look up from tensorflow dlpack on CPU**********
The device type of embedding keys that lookup dlpack from hps interface for embedding table 1 of hps_demo: /job:localhost/replica:0/task:0/device:CPU:0, the keys: [20005 30347 20001 ... 30174 20000 30013]
The device type of embedding vectors that lookup dlpack from hps interface for embedding table 1 of hps_demo: /job:localhost/replica:0/task:0/device:CPU:0, the vectors: [[ 0.02120136  0.03807243 -0.04021286 ... -0.00556568  0.00462132
   0.01774719]]

tensorflow dlpack on CPU results are consistent with native HPS lookup api, mse: 0.0
***************Look up from tensorflow dlpack on GPU**********
[HUGECTR][INFO] The device type of embedding vectors that lookup dlpack from hps interface for embedding table 1 of wdl: /job:localhost/replica:0/task:0/device:GPU:0, the vectors: [ 0.02120136  0.03807243 -0.04021286 ... -0.00556568  0.00462132
  0.01774719]

tensorflow dlpack on GPU results are consistent with native HPS lookup api, mse: 0.0
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="multi-process-inference">
<h2>Multi-process inference<a class="headerlink" href="#multi-process-inference" title="Permalink to this headline"></a></h2>
<p>It is possible to share the a hashmap database between multiple processes. The followng example launches 3 processes which achieve this using the operating system’s shared memory, which is located at <code class="docutils literal notranslate"><span class="pre">/dev/shm</span></code> in most unix systems. In this example, we separate processes into a primary and multiple secondary processes, and only the primary process initializes the shared memory database. The secondary processes wait until the shared memory has been fully initialized. However, note that inter-process database access is guaranteed to be thread-safe. Therefore, it is also possible to implement more complicated initialization/refresh mechanisms for your use-case.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> multi_process_hps.py
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="nn">ort</span>
<span class="kn">from</span> <span class="nn">hugectr</span> <span class="kn">import</span> <span class="n">DatabaseType_t</span>
<span class="kn">from</span> <span class="nn">hugectr.inference</span> <span class="kn">import</span> <span class="n">HPS</span><span class="p">,</span> <span class="n">ParameterServerConfig</span><span class="p">,</span> <span class="n">InferenceParams</span><span class="p">,</span> <span class="n">VolatileDatabaseParams</span>

<span class="n">slot_size_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="n">key_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">slot_size_array</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="k">def</span> <span class="nf">create_hps</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">initialized</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">num_max_processes</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;subprocess：</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">（</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s1">）launch...&#39;</span><span class="p">)</span>
    
    <span class="c1"># 1. Let secondary processes wait until shared memory is initialized.</span>
    <span class="k">while</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;primary&#39;</span> <span class="ow">and</span> <span class="n">initialized</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> awaiting SHM initialization...&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 2. Configure the HPS hyperparameters</span>
    <span class="n">ps_config</span> <span class="o">=</span> <span class="n">ParameterServerConfig</span><span class="p">(</span>
           <span class="n">emb_table_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hps_demo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span> <span class="s2">&quot;sparse_embedding2&quot;</span><span class="p">]},</span>
           <span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hps_demo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">]},</span>
           <span class="n">max_feature_num_per_sample_per_emb_table</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hps_demo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]},</span>
           <span class="n">inference_params_array</span> <span class="o">=</span> <span class="p">[</span>
              <span class="n">InferenceParams</span><span class="p">(</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span>
                <span class="n">max_batchsize</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="n">hit_rate_threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="n">dense_model_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">sparse_model_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hps_demo0_sparse_1000.model&quot;</span><span class="p">,</span> <span class="s2">&quot;hps_demo1_sparse_1000.model&quot;</span><span class="p">],</span>
                <span class="n">device_id</span><span class="o">=</span><span class="n">device_id</span><span class="p">,</span>
                <span class="n">deployed_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">device_id</span><span class="p">],</span>
                <span class="n">use_gpu_embedding_cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">cache_size_percentage</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
           <span class="p">],</span>
           <span class="n">volatile_db</span> <span class="o">=</span> <span class="n">VolatileDatabaseParams</span><span class="p">(</span>
                <span class="n">DatabaseType_t</span><span class="o">.</span><span class="n">multi_process_hash_map</span><span class="p">,</span>  <span class="c1"># Use /dev/shm instead of normal memory for storage.</span>
                <span class="c1"># Skips initializing model. If we run HPS in multiple processes, only one needs to initialize.</span>
                <span class="n">initialize_after_startup</span> <span class="o">=</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;primary&#39;</span><span class="p">,</span>
           <span class="p">))</span>

    <span class="c1"># 3. Initialize the HPS object</span>
    <span class="n">hps</span> <span class="o">=</span> <span class="n">HPS</span><span class="p">(</span><span class="n">ps_config</span><span class="p">)</span>
    <span class="n">initialized</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> initialized&#39;</span><span class="p">)</span>
    
    <span class="c1"># 4. In (1) the secondary processes wait until the primary process has completed initializing</span>
    <span class="c1">#    the shared memory. If the last process disconnects, the shared memory is erased.</span>
    <span class="c1">#    Therefore, if threads that currently have attached to the shared memory manage to complete</span>
    <span class="c1">#    their program before another process has attached, the contents of the shared memory are</span>
    <span class="c1">#    lost and the new process will instead construct an empty shared memory. To avoid this</span>
    <span class="c1">#    situation, we have multiple options.</span>
    <span class="c1">#</span>
    <span class="c1">#   a) Setting `shared_memory_auto_remove = False` in the `VolatileDatabaseParams`</span>
    <span class="c1">#      configuration [default: True]. This will prevent the deletion of the shared memory when</span>
    <span class="c1">#      the last process disconnects. In other words, revoking this flag allows you to preserve</span>
    <span class="c1">#      and use the state of a shared memory across multiple program restarts. However, while</span>
    <span class="c1">#      desirable in some situations, this is not the behavior we need here, because this</span>
    <span class="c1">#      notebook cell should be allowed to be executed repeatedly without relying on risidual</span>
    <span class="c1">#      state.</span>
    <span class="c1">#</span>
    <span class="c1">#   b) Another approach is to ensure that the all other processes that should attach have</span>
    <span class="c1">#      attached. Here we achieve this by simply monitoring the `initialized` cross process</span>
    <span class="c1">#      counter variable that we used in (1). Once it hits `num_max_processes` we can be sure</span>
    <span class="c1">#      that each subprocess has properly connected.</span>
    <span class="k">while</span> <span class="n">initialized</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">num_max_processes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> await other processes...&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># 5. Load query data.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;data_parquet/val/gen_0.parquet&quot;</span><span class="p">)</span>
    <span class="n">dense_input_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
    <span class="n">cat_input1_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
    <span class="n">cat_input2_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span>
    <span class="n">dense_input</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dense_input_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">cat_input1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat_input1_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">cat_input2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat_input2_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># 6. Make inference from the HPS object and the ONNX inference session of `hps_demo_without_embedding.onnx`.</span>
    <span class="n">embedding1</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">device_id</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">embedding2</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s2">&quot;hps_demo&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">device_id</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="s2">&quot;hps_demo_without_embedding.onnx&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">sess</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                   <span class="n">input_feed</span><span class="o">=</span><span class="p">{</span><span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dense_input</span><span class="p">,</span>
                   <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">embedding1</span><span class="p">,</span>
                   <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">embedding2</span><span class="p">})</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># 7. Check the correctness by comparing with dumped evaluation results.</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;hps_demo_pred_1000&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">; ground_truth: </span><span class="si">{</span><span class="n">ground_truth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">-</span><span class="n">ground_truth</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span><span class="o">*</span><span class="n">diff</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">; pred: </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">; mse between pred and ground_truth: </span><span class="si">{</span><span class="n">mse</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># 8. Make inference with the ONNX inference session of `hps_demo_with_embedding.onnx` (double check).</span>
    <span class="n">sess_ref</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="s2">&quot;hps_demo_with_embedding.onnx&quot;</span><span class="p">)</span>
    <span class="n">res_ref</span> <span class="o">=</span> <span class="n">sess_ref</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">sess_ref</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                   <span class="n">input_feed</span><span class="o">=</span><span class="p">{</span><span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dense_input</span><span class="p">,</span>
                   <span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cat_input1</span><span class="p">,</span>
                   <span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cat_input2</span><span class="p">})</span>
    <span class="n">pred_ref</span> <span class="o">=</span> <span class="n">res_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">diff_ref</span> <span class="o">=</span> <span class="n">pred_ref</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">-</span><span class="n">ground_truth</span>
    <span class="n">mse_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_ref</span><span class="o">*</span><span class="n">diff_ref</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">; pred_ref: </span><span class="si">{</span><span class="n">pred_ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">; mse between pred_ref and ground_truth: </span><span class="si">{</span><span class="n">mse_ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subprocess </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> exiting...&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Destroy shared memory.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/dev/shm/hctr_mp_hash_map_database&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="n">initialized</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Create sub processes.</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">create_hps</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="n">initialized</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">create_hps</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;secondary&#39;</span><span class="p">,</span> <span class="n">initialized</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">create_hps</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;secondary&#39;</span><span class="p">,</span> <span class="n">initialized</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Go to sleep until subprocesses are initialized.</span>
    <span class="k">while</span> <span class="n">initialized</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Main process; awaiting subprocess initialization... So far </span><span class="si">{</span><span class="n">initialized</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1"> initialized...&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="c1"># Wait for subprocesses to exit.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Main process; awaiting subprocess </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> to exit...&#39;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Main process; exiting...&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting multi_process_hps.py
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python3<span class="w"> </span>multi_process_hps.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>subprocess：primary（29735）launch...
Main process; awaiting subprocess initialization... So far 0 initialized...
subprocess：secondary（29736）launch...
Subprocess secondary awaiting SHM initialization...
subprocess：secondary（29737）launch...
Subprocess secondary awaiting SHM initialization...
[HCTR][10:19:05.646][WARNING][RK0][main]: default_value_for_each_table.size() is not equal to the number of embedding tables
====================================================HPS Create====================================================
[HCTR][10:19:05.647][INFO][RK0][main]: Creating Multi-Process HashMap CPU database backend...
[HCTR][10:19:05.647][INFO][RK0][main]: Connecting to shared memory &#39;hctr_mp_hash_map_database&#39;...
Main process; awaiting subprocess initialization... So far 0 initialized...
Subprocess secondary awaiting SHM initialization...
Subprocess secondary awaiting SHM initialization...
[HCTR][10:19:06.147][INFO][RK0][main]: Connected to shared memory &#39;hctr_mp_hash_map_database&#39;; OS total = 274877906944 bytes, OS available = 274873581568 bytes, HCTR allocated = 17179869184 bytes, HCTR free = 17179868672 bytes; other processes connected = 0
[HCTR][10:19:06.147][INFO][RK0][main]: Volatile DB: initial cache rate = 1
[HCTR][10:19:06.147][INFO][RK0][main]: Volatile DB: cache missed embeddings = 0
[HCTR][10:19:06.147][DEBUG][RK0][main]: Created raw model loader in local memory!
Main process; awaiting subprocess initialization... So far 0 initialized...
Subprocess secondary awaiting SHM initialization...
Subprocess secondary awaiting SHM initialization...
[HCTR][10:19:06.834][INFO][RK0][main]: Table: hps_et.hps_demo.sparse_embedding1; cached 18479 / 18479 embeddings in volatile database (MultiProcessHashMapBackend); load: 18478 / 18446744073709551615 (0.00%).
[HCTR][10:19:07.503][INFO][RK0][main]: Table: hps_et.hps_demo.sparse_embedding2; cached 18466 / 18466 embeddings in volatile database (MultiProcessHashMapBackend); load: 18442 / 18446744073709551615 (0.00%).
[HCTR][10:19:07.503][DEBUG][RK0][main]: Real-time subscribers created!
[HCTR][10:19:07.503][INFO][RK0][main]: Creating embedding cache in device 0.
[HCTR][10:19:07.516][INFO][RK0][main]: Model name: hps_demo
[HCTR][10:19:07.516][INFO][RK0][main]: Max batch size: 1024
[HCTR][10:19:07.516][INFO][RK0][main]: Number of embedding tables: 2
[HCTR][10:19:07.516][INFO][RK0][main]: Use GPU embedding cache: True, cache size percentage: 0.500000
[HCTR][10:19:07.516][INFO][RK0][main]: Use static table: False
[HCTR][10:19:07.516][INFO][RK0][main]: Use I64 input key: True
[HCTR][10:19:07.516][INFO][RK0][main]: Configured cache hit rate threshold: 1.000000
[HCTR][10:19:07.516][INFO][RK0][main]: The size of thread pool: 256
[HCTR][10:19:07.516][INFO][RK0][main]: The size of worker memory pool: 2
[HCTR][10:19:07.516][INFO][RK0][main]: The size of refresh memory pool: 1
[HCTR][10:19:07.516][INFO][RK0][main]: The refresh percentage : 0.000000
Main process; awaiting subprocess initialization... So far 0 initialized...
Subprocess secondary awaiting SHM initialization...
Subprocess secondary awaiting SHM initialization...
[HCTR][10:19:08.215][INFO][RK0][main]: Creating lookup session for hps_demo on device: 0
Subprocess primary initialized
Subprocess primary await other processes...
Main process; awaiting subprocess initialization... So far 1 initialized...
Subprocess primary await other processes...
[HCTR][10:19:09.426][WARNING][RK0][main]: default_value_for_each_table.size() is not equal to the number of embedding tables
====================================================HPS Create====================================================
[HCTR][10:19:09.427][INFO][RK0][main]: Creating Multi-Process HashMap CPU database backend...
[HCTR][10:19:09.428][INFO][RK0][main]: Connecting to shared memory &#39;hctr_mp_hash_map_database&#39;...
[HCTR][10:19:09.445][WARNING][RK0][main]: default_value_for_each_table.size() is not equal to the number of embedding tables
====================================================HPS Create====================================================
[HCTR][10:19:09.446][INFO][RK0][main]: Creating Multi-Process HashMap CPU database backend...
[HCTR][10:19:09.447][INFO][RK0][main]: Connecting to shared memory &#39;hctr_mp_hash_map_database&#39;...
Main process; awaiting subprocess initialization... So far 1 initialized...
[HCTR][10:19:09.928][INFO][RK0][main]: Connected to shared memory &#39;hctr_mp_hash_map_database&#39;; OS total = 274877906944 bytes, OS available = 265468608512 bytes, HCTR allocated = 17179869184 bytes, HCTR free = 7783386512 bytes; other processes connected = 1
[HCTR][10:19:09.928][INFO][RK0][main]: Volatile DB: initial cache rate = 1
[HCTR][10:19:09.928][INFO][RK0][main]: Volatile DB: cache missed embeddings = 0
[HCTR][10:19:09.928][DEBUG][RK0][main]: Created raw model loader in local memory!
[HCTR][10:19:09.942][DEBUG][RK0][main]: Real-time subscribers created!
[HCTR][10:19:09.942][INFO][RK0][main]: Creating embedding cache in device 2.
[HCTR][10:19:09.958][INFO][RK0][main]: Model name: hps_demo
[HCTR][10:19:09.958][INFO][RK0][main]: Max batch size: 1024
[HCTR][10:19:09.958][INFO][RK0][main]: Number of embedding tables: 2
[HCTR][10:19:09.958][INFO][RK0][main]: Use GPU embedding cache: True, cache size percentage: 0.500000
[HCTR][10:19:09.958][INFO][RK0][main]: Use static table: False
[HCTR][10:19:09.958][INFO][RK0][main]: Use I64 input key: True
[HCTR][10:19:09.958][INFO][RK0][main]: Configured cache hit rate threshold: 1.000000
[HCTR][10:19:09.958][INFO][RK0][main]: The size of thread pool: 256
[HCTR][10:19:09.958][INFO][RK0][main]: The size of worker memory pool: 2
[HCTR][10:19:09.958][INFO][RK0][main]: The size of refresh memory pool: 1
[HCTR][10:19:09.958][INFO][RK0][main]: The refresh percentage : 0.000000
Subprocess primary await other processes...
[HCTR][10:19:10.428][INFO][RK0][main]: Connected to shared memory &#39;hctr_mp_hash_map_database&#39;; OS total = 274877906944 bytes, OS available = 265468608512 bytes, HCTR allocated = 17179869184 bytes, HCTR free = 7783386512 bytes; other processes connected = 1
[HCTR][10:19:10.428][INFO][RK0][main]: Volatile DB: initial cache rate = 1
[HCTR][10:19:10.429][INFO][RK0][main]: Volatile DB: cache missed embeddings = 0
[HCTR][10:19:10.429][DEBUG][RK0][main]: Created raw model loader in local memory!
[HCTR][10:19:10.442][DEBUG][RK0][main]: Real-time subscribers created!
[HCTR][10:19:10.442][INFO][RK0][main]: Creating embedding cache in device 1.
[HCTR][10:19:10.460][INFO][RK0][main]: Model name: hps_demo
[HCTR][10:19:10.460][INFO][RK0][main]: Max batch size: 1024
[HCTR][10:19:10.460][INFO][RK0][main]: Number of embedding tables: 2
[HCTR][10:19:10.460][INFO][RK0][main]: Use GPU embedding cache: True, cache size percentage: 0.500000
[HCTR][10:19:10.460][INFO][RK0][main]: Use static table: False
[HCTR][10:19:10.460][INFO][RK0][main]: Use I64 input key: True
[HCTR][10:19:10.460][INFO][RK0][main]: Configured cache hit rate threshold: 1.000000
[HCTR][10:19:10.460][INFO][RK0][main]: The size of thread pool: 256
[HCTR][10:19:10.460][INFO][RK0][main]: The size of worker memory pool: 2
[HCTR][10:19:10.460][INFO][RK0][main]: The size of refresh memory pool: 1
[HCTR][10:19:10.460][INFO][RK0][main]: The refresh percentage : 0.000000
Main process; awaiting subprocess initialization... So far 1 initialized...
Subprocess primary await other processes...
[HCTR][10:19:11.685][INFO][RK0][main]: Creating lookup session for hps_demo on device: 2
Subprocess secondary initialized
Subprocess secondary await other processes...
Main process; awaiting subprocess initialization... So far 2 initialized...
[HCTR][10:19:12.197][INFO][RK0][main]: Creating lookup session for hps_demo on device: 1
Subprocess secondary initialized
2023-02-22 10:19:12.342698621 [W:onnxruntime:, graph.cc:3559 CleanUnusedInitializersAndNodeArgs] Removing initializer &#39;key_to_indice_hash_all_tables&#39;. It is not used by any node and should be removed from the model.
Subprocess primary; ground_truth: [0.405464 0.454452 0.483003 ... 0.446739 0.519928 0.507307]
Subprocess primary; pred: [[0.40546432]
 [0.45445234]
 [0.4830035 ]
 ...
 [0.4467388 ]
 [0.5199275 ]
 [0.5073072 ]]
Subprocess primary; mse between pred and ground_truth: 8.743050589622307e-14
2023-02-22 10:19:12.384107377 [W:onnxruntime:, graph.cc:3559 CleanUnusedInitializersAndNodeArgs] Removing initializer &#39;key_to_indice_hash_all_tables&#39;. It is not used by any node and should be removed from the model.
Subprocess primary; pred_ref: [[0.40546432]
 [0.45445234]
 [0.4830035 ]
 ...
 [0.4467388 ]
 [0.5199275 ]
 [0.5073072 ]]
Subprocess primary; mse between pred_ref and ground_truth: 8.743050589622307e-14
Subprocess primary exiting...
Subprocess secondary; ground_truth: [0.405464 0.454452 0.483003 ... 0.446739 0.519928 0.507307]
Subprocess secondary; pred: [[0.40546432]
 [0.45445234]
 [0.4830035 ]
 ...
 [0.4467388 ]
 [0.5199275 ]
 [0.5073072 ]]
Subprocess secondary; mse between pred and ground_truth: 8.743050589622307e-14
[HCTR][10:19:12.512][INFO][RK0][main]: Disconnecting from shared memory &#39;hctr_mp_hash_map_database&#39;.
Subprocess secondary; pred_ref: [[0.40546432]
 [0.45445234]
 [0.4830035 ]
 ...
 [0.4467388 ]
 [0.5199275 ]
 [0.5073072 ]]
Subprocess secondary; mse between pred_ref and ground_truth: 8.743050589622307e-14
Subprocess secondary exiting...
[HCTR][10:19:12.558][INFO][RK0][main]: Disconnecting from shared memory &#39;hctr_mp_hash_map_database&#39;.
Main process; awaiting subprocess 0 to exit...
Main process; awaiting subprocess 1 to exit...
2023-02-22 10:19:13.682716723 [W:onnxruntime:, graph.cc:3559 CleanUnusedInitializersAndNodeArgs] Removing initializer &#39;key_to_indice_hash_all_tables&#39;. It is not used by any node and should be removed from the model.
Subprocess secondary; ground_truth: [0.405464 0.454452 0.483003 ... 0.446739 0.519928 0.507307]
Subprocess secondary; pred: [[0.40546432]
 [0.45445234]
 [0.4830035 ]
 ...
 [0.4467388 ]
 [0.5199275 ]
 [0.5073072 ]]
Subprocess secondary; mse between pred and ground_truth: 8.743050589622307e-14
Subprocess secondary; pred_ref: [[0.40546432]
 [0.45445234]
 [0.4830035 ]
 ...
 [0.4467388 ]
 [0.5199275 ]
 [0.5073072 ]]
Subprocess secondary; mse between pred_ref and ground_truth: 8.743050589622307e-14
Subprocess secondary exiting...
[HCTR][10:19:13.763][INFO][RK0][main]: Disconnecting from shared memory &#39;hctr_mp_hash_map_database&#39;.
Main process; awaiting subprocess 2 to exit...
[HCTR][10:19:14.338][INFO][RK0][main]: Detached last process from shared memory &#39;hctr_mp_hash_map_database&#39;. Auto remove in progress...
Main process; exiting...
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="redis-cluster-deployment-without-tls-ssl">
<h2>Redis Cluster deployment (without TLS/SSL)<a class="headerlink" href="#redis-cluster-deployment-without-tls-ssl" title="Permalink to this headline"></a></h2>
<p>HugeCTR can use Redis clusters as backing storage. In the following steps we show how to setup a mock Redis / HugeCTR deployment in a single machine. We assume that you have started this notebook in a HugeCTR docker container.</p>
<p><strong>Step 1: Get + build Redis</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>rm<span class="w"> </span>-f<span class="w"> </span><span class="m">7</span>.0.8.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/redis/redis/archive/7.0.8.tar.gz
<span class="o">!</span>rm<span class="w"> </span>-rf<span class="w"> </span>redis-7.0.8<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>tar<span class="w"> </span>-xf<span class="w"> </span><span class="m">7</span>.0.8.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-sf<span class="w"> </span>redis-7.0.8<span class="w"> </span>redis
<span class="o">!</span><span class="nb">cd</span><span class="w"> </span>redis<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2023-01-18 14:23:54--  https://github.com/redis/redis/archive/7.0.8.tar.gz
Resolving github.com (github.com)... 192.30.255.112
Connecting to github.com (github.com)|192.30.255.112|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://codeload.github.com/redis/redis/tar.gz/refs/tags/7.0.8 [following]
--2023-01-18 14:23:54--  https://codeload.github.com/redis/redis/tar.gz/refs/tags/7.0.8
Resolving codeload.github.com (codeload.github.com)... 192.30.255.121
Connecting to codeload.github.com (codeload.github.com)|192.30.255.121|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3011655 (2.9M) [application/x-gzip]
Saving to: ‘7.0.8.tar.gz’

7.0.8.tar.gz        100%[===================&gt;]   2.87M  17.6MB/s    in 0.2s    

2023-01-18 14:23:55 (17.6 MB/s) - ‘7.0.8.tar.gz’ saved [3011655/3011655]

cd src &amp;&amp; make all
make[1]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/src&#39;
./mkreleasehdr.sh: 1: echo: echo: I/O error
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">Makefile.dep</span>
./mkreleasehdr.sh: 1: echo: echo: I/O error
rm -rf redis-server redis-sentinel redis-cli redis-benchmark redis-check-rdb redis-check-aof *.o *.gcda *.gcno *.gcov redis.info lcov-html Makefile.dep
rm -f adlist.d quicklist.d ae.d anet.d dict.d server.d sds.d zmalloc.d lzf_c.d lzf_d.d pqsort.d zipmap.d sha1.d ziplist.d release.d networking.d util.d object.d db.d replication.d rdb.d t_string.d t_list.d t_set.d t_zset.d t_hash.d config.d aof.d pubsub.d multi.d debug.d sort.d intset.d syncio.d cluster.d crc16.d endianconv.d slowlog.d eval.d bio.d rio.d rand.d memtest.d syscheck.d crcspeed.d crc64.d bitops.d sentinel.d notify.d setproctitle.d blocked.d hyperloglog.d latency.d sparkline.d redis-check-rdb.d redis-check-aof.d geo.d lazyfree.d module.d evict.d expire.d geohash.d geohash_helper.d childinfo.d defrag.d siphash.d rax.d t_stream.d listpack.d localtime.d lolwut.d lolwut5.d lolwut6.d acl.d tracking.d connection.d tls.d sha256.d timeout.d setcpuaffinity.d monotonic.d mt19937-64.d resp_parser.d call_reply.d script_lua.d script.d functions.d function_lua.d commands.d anet.d adlist.d dict.d redis-cli.d zmalloc.d release.d ae.d redisassert.d crcspeed.d crc64.d siphash.d crc16.d monotonic.d cli_common.d mt19937-64.d ae.d anet.d redis-benchmark.d adlist.d dict.d zmalloc.d redisassert.d release.d crcspeed.d crc64.d siphash.d crc16.d monotonic.d cli_common.d mt19937-64.d
(cd ../deps &amp;&amp; make distclean)
make[2]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps&#39;
(cd hiredis &amp;&amp; make clean) &gt; /dev/null || true
(cd linenoise &amp;&amp; make clean) &gt; /dev/null || true
(cd lua &amp;&amp; make clean) &gt; /dev/null || true
(cd jemalloc &amp;&amp; [ -f Makefile ] &amp;&amp; make distclean) &gt; /dev/null || true
(cd hdr_histogram &amp;&amp; make clean) &gt; /dev/null || true
(rm -f .make-*)
make[2]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps&#39;
(cd modules &amp;&amp; make clean)
make[2]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/src/modules&#39;
rm -rf *.xo *.so
make[2]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/src/modules&#39;
(cd ../tests/modules &amp;&amp; make clean)
make[2]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/tests/modules&#39;
rm -f commandfilter.so basics.so testrdb.so fork.so infotest.so propagate.so misc.so hooks.so blockonkeys.so blockonbackground.so scan.so datatype.so datatype2.so auth.so keyspace_events.so blockedclient.so getkeys.so getchannels.so test_lazyfree.so timer.so defragtest.so keyspecs.so hash.so zset.so stream.so mallocsize.so aclcheck.so list.so subcommands.so reply.so cmdintrospection.so eventloop.so moduleconfigs.so moduleconfigstwo.so publish.so usercall.so commandfilter.xo basics.xo testrdb.xo fork.xo infotest.xo propagate.xo misc.xo hooks.xo blockonkeys.xo blockonbackground.xo scan.xo datatype.xo datatype2.xo auth.xo keyspace_events.xo blockedclient.xo getkeys.xo getchannels.xo test_lazyfree.xo timer.xo defragtest.xo keyspecs.xo hash.xo zset.xo stream.xo mallocsize.xo aclcheck.xo list.xo subcommands.xo reply.xo cmdintrospection.xo eventloop.xo moduleconfigs.xo moduleconfigstwo.xo publish.xo usercall.xo
make[2]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/tests/modules&#39;
(rm -f .make-*)
echo STD=-pedantic -DREDIS_STATIC=&#39;&#39; -std=c11 &gt;&gt; .make-settings
echo WARN=-Wall -W -Wno-missing-field-initializers &gt;&gt; .make-settings
echo OPT=-O2 &gt;&gt; .make-settings
echo MALLOC=jemalloc &gt;&gt; .make-settings
echo BUILD_TLS= &gt;&gt; .make-settings
echo USE_SYSTEMD= &gt;&gt; .make-settings
echo CFLAGS= &gt;&gt; .make-settings
echo LDFLAGS= &gt;&gt; .make-settings
echo REDIS_CFLAGS= &gt;&gt; .make-settings
echo REDIS_LDFLAGS= &gt;&gt; .make-settings
echo PREV_FINAL_CFLAGS=-pedantic -DREDIS_STATIC=&#39;&#39; -std=c11 -Wall -W -Wno-missing-field-initializers -O2 -g -ggdb   -I../deps/hiredis -I../deps/linenoise -I../deps/lua/src -I../deps/hdr_histogram -DUSE_JEMALLOC -I../deps/jemalloc/include &gt;&gt; .make-settings
echo PREV_FINAL_LDFLAGS=  -g -ggdb -rdynamic &gt;&gt; .make-settings
(cd ../deps &amp;&amp; make hiredis linenoise lua hdr_histogram jemalloc)
make[2]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps&#39;
(cd hiredis &amp;&amp; make clean) &gt; /dev/null || true
(cd linenoise &amp;&amp; make clean) &gt; /dev/null || true
(cd lua &amp;&amp; make clean) &gt; /dev/null || true
(cd jemalloc &amp;&amp; [ -f Makefile ] &amp;&amp; make distclean) &gt; /dev/null || true
(cd hdr_histogram &amp;&amp; make clean) &gt; /dev/null || true
(rm -f .make-*)
(echo &quot;&quot; &gt; .make-cflags)
(echo &quot;&quot; &gt; .make-ldflags)
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">hiredis</span>
cd hiredis &amp;&amp; make static 
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/hiredis&#39;
cc -std=c99 -c -O3 -fPIC   -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic alloc.c
cc -std=c99 -c -O3 -fPIC   -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic net.c
cc -std=c99 -c -O3 -fPIC   -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic hiredis.c
cc -std=c99 -c -O3 -fPIC   -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic sds.c
cc -std=c99 -c -O3 -fPIC   -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic async.c
cc -std=c99 -c -O3 -fPIC   -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic read.c
cc -std=c99 -c -O3 -fPIC   -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic sockcompat.c
ar rcs libhiredis.a alloc.o net.o hiredis.o sds.o async.o read.o sockcompat.o
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/hiredis&#39;
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">linenoise</span>
cd linenoise &amp;&amp; make
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/linenoise&#39;
cc  -Wall -Os -g  -c linenoise.c
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/linenoise&#39;
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">lua</span>
cd lua/src &amp;&amp; make all CFLAGS=&quot;-Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2 &quot; MYLDFLAGS=&quot;&quot; AR=&quot;ar rc&quot;
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/lua/src&#39;
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lapi.o lapi.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lcode.o lcode.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ldebug.o ldebug.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ldo.o ldo.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ldump.o ldump.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lfunc.o lfunc.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lgc.o lgc.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o llex.o llex.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lmem.o lmem.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lobject.o lobject.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lopcodes.o lopcodes.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lparser.o lparser.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lstate.o lstate.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lstring.o lstring.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ltable.o ltable.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ltm.o ltm.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lundump.o lundump.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lvm.o lvm.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lzio.o lzio.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o strbuf.o strbuf.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o fpconv.o fpconv.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lauxlib.o lauxlib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lbaselib.o lbaselib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ldblib.o ldblib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o liolib.o liolib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lmathlib.o lmathlib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o loslib.o loslib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ltablib.o ltablib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lstrlib.o lstrlib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o loadlib.o loadlib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o linit.o linit.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua_cjson.o lua_cjson.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua_struct.o lua_struct.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua_cmsgpack.o lua_cmsgpack.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua_bit.o lua_bit.c
ar rc liblua.a lapi.o lcode.o ldebug.o ldo.o ldump.o lfunc.o lgc.o llex.o lmem.o lobject.o lopcodes.o lparser.o lstate.o lstring.o ltable.o ltm.o lundump.o lvm.o lzio.o strbuf.o fpconv.o lauxlib.o lbaselib.o ldblib.o liolib.o lmathlib.o loslib.o ltablib.o lstrlib.o loadlib.o linit.o lua_cjson.o lua_struct.o lua_cmsgpack.o lua_bit.o	# DLL needs all object files
ranlib liblua.a
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua.o lua.c
cc -o lua  lua.o liblua.a -lm 
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o luac.o luac.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o print.o print.c
cc -o luac  luac.o print.o liblua.a -lm 
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/lua/src&#39;
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">hdr_histogram</span>
cd hdr_histogram &amp;&amp; make
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/hdr_histogram&#39;
cc -std=c99 -Wall -Os -g  -DHDR_MALLOC_INCLUDE=\&quot;hdr_redis_malloc.h\&quot; -c  hdr_histogram.c 
ar rcs libhdrhistogram.a hdr_histogram.o
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/hdr_histogram&#39;
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">jemalloc</span>
cd jemalloc &amp;&amp; ./configure --with-version=5.2.1-0-g0 --with-lg-quantum=3 --with-jemalloc-prefix=je_ CFLAGS=&quot;-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops &quot; LDFLAGS=&quot;&quot; 
checking for xsltproc... false
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether gcc accepts -g... yes
checking for gcc option to accept ISO C89... none needed
checking whether compiler is cray... no
checking whether compiler supports -std=gnu11... yes
checking whether compiler supports -Wall... yes
checking whether compiler supports -Wextra... yes
checking whether compiler supports -Wshorten-64-to-32... no
checking whether compiler supports -Wsign-compare... yes
checking whether compiler supports -Wundef... yes
checking whether compiler supports -Wno-format-zero-length... yes
checking whether compiler supports -pipe... yes
checking whether compiler supports -g3... yes
checking how to run the C preprocessor... gcc -E
checking for g++... g++
checking whether we are using the GNU C++ compiler... yes
checking whether g++ accepts -g... yes
checking whether g++ supports C++14 features by default... yes
checking whether compiler supports -Wall... yes
checking whether compiler supports -Wextra... yes
checking whether compiler supports -g3... yes
checking whether libstdc++ linkage is compilable... yes
checking for grep that handles long lines and -e... /usr/bin/grep
checking for egrep... /usr/bin/grep -E
checking for ANSI C header files... yes
checking for sys/types.h... yes
checking for sys/stat.h... yes
checking for stdlib.h... yes
checking for string.h... yes
checking for memory.h... yes
checking for strings.h... yes
checking for inttypes.h... yes
checking for stdint.h... yes
checking for unistd.h... yes
checking whether byte ordering is bigendian... no
checking size of void *... 8
checking size of int... 4
checking size of long... 8
checking size of long long... 8
checking size of intmax_t... 8
checking build system type... x86_64-pc-linux-gnu
checking host system type... x86_64-pc-linux-gnu
checking whether pause instruction is compilable... yes
checking number of significant virtual address bits... 48
checking for ar... ar
checking for nm... nm
checking for gawk... no
checking for mawk... mawk
checking malloc.h usability... yes
checking malloc.h presence... yes
checking for malloc.h... yes
checking whether malloc_usable_size definition can use const argument... no
checking for library containing log... -lm
checking whether __attribute__ syntax is compilable... yes
checking whether compiler supports -fvisibility=hidden... yes
checking whether compiler supports -fvisibility=hidden... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether tls_model attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether alloc_size attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether format(gnu_printf, ...) attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether format(printf, ...) attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether format(printf, ...) attribute is compilable... yes
checking for a BSD-compatible install... /usr/bin/install -c
checking for ranlib... ranlib
checking for ld... /usr/bin/ld
checking for autoconf... /usr/bin/autoconf
checking for memalign... yes
checking for valloc... yes
checking whether compiler supports -O3... yes
checking whether compiler supports -O3... yes
checking whether compiler supports -funroll-loops... yes
checking configured backtracing method... N/A
checking for sbrk... yes
checking whether utrace(2) is compilable... no
checking whether a program using __builtin_unreachable is compilable... yes
checking whether a program using __builtin_ffsl is compilable... yes
checking whether a program using __builtin_popcountl is compilable... yes
checking LG_PAGE... 12
checking pthread.h usability... yes
checking pthread.h presence... yes
checking for pthread.h... yes
checking for pthread_create in -lpthread... yes
checking dlfcn.h usability... yes
checking dlfcn.h presence... yes
checking for dlfcn.h... yes
checking for dlsym... no
checking for dlsym in -ldl... yes
checking whether pthread_atfork(3) is compilable... yes
checking whether pthread_setname_np(3) is compilable... yes
checking for library containing clock_gettime... none required
checking whether clock_gettime(CLOCK_MONOTONIC_COARSE, ...) is compilable... yes
checking whether clock_gettime(CLOCK_MONOTONIC, ...) is compilable... yes
checking whether mach_absolute_time() is compilable... no
checking whether compiler supports -Werror... yes
checking whether syscall(2) is compilable... yes
checking for secure_getenv... yes
checking for sched_getcpu... yes
checking for sched_setaffinity... yes
checking for issetugid... no
checking for _malloc_thread_cleanup... no
checking for _pthread_mutex_init_calloc_cb... no
checking for TLS... yes
checking whether C11 atomics is compilable... no
checking whether GCC __atomic atomics is compilable... yes
checking whether GCC 8-bit __atomic atomics is compilable... yes
checking whether GCC __sync atomics is compilable... yes
checking whether GCC 8-bit __sync atomics is compilable... yes
checking whether Darwin OSAtomic*() is compilable... no
checking whether madvise(2) is compilable... yes
checking whether madvise(..., MADV_FREE) is compilable... yes
checking whether madvise(..., MADV_DONTNEED) is compilable... yes
checking whether madvise(..., MADV_DO[NT]DUMP) is compilable... yes
checking whether madvise(..., MADV_[NO]HUGEPAGE) is compilable... yes
checking for __builtin_clz... yes
checking whether Darwin os_unfair_lock_*() is compilable... no
checking whether glibc malloc hook is compilable... yes
checking whether glibc memalign hook is compilable... yes
checking whether pthreads adaptive mutexes is compilable... yes
checking whether compiler supports -D_GNU_SOURCE... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether strerror_r returns char with gnu source is compilable... yes
checking for stdbool.h that conforms to C99... yes
checking for _Bool... yes
configure: creating ./config.status
config.status: creating Makefile
config.status: creating jemalloc.pc
config.status: creating doc/html.xsl
config.status: creating doc/manpages.xsl
config.status: creating doc/jemalloc.xml
config.status: creating include/jemalloc/jemalloc_macros.h
config.status: creating include/jemalloc/jemalloc_protos.h
config.status: creating include/jemalloc/jemalloc_typedefs.h
config.status: creating include/jemalloc/internal/jemalloc_preamble.h
config.status: creating test/test.sh
config.status: creating test/include/test/jemalloc_test.h
config.status: creating config.stamp
config.status: creating bin/jemalloc-config
config.status: creating bin/jemalloc.sh
config.status: creating bin/jeprof
config.status: creating include/jemalloc/jemalloc_defs.h
config.status: creating include/jemalloc/internal/jemalloc_internal_defs.h
config.status: creating test/include/test/jemalloc_test_defs.h
config.status: executing include/jemalloc/internal/public_symbols.txt commands
config.status: executing include/jemalloc/internal/private_symbols.awk commands
config.status: executing include/jemalloc/internal/private_symbols_jet.awk commands
config.status: executing include/jemalloc/internal/public_namespace.h commands
config.status: executing include/jemalloc/internal/public_unnamespace.h commands
config.status: executing include/jemalloc/jemalloc_protos_jet.h commands
config.status: executing include/jemalloc/jemalloc_rename.h commands
config.status: executing include/jemalloc/jemalloc_mangle.h commands
config.status: executing include/jemalloc/jemalloc_mangle_jet.h commands
config.status: executing include/jemalloc/jemalloc.h commands
===============================================================================
jemalloc version   : 5.2.1-0-g0
library revision   : 2

CONFIG             : --with-version=5.2.1-0-g0 --with-lg-quantum=3 --with-jemalloc-prefix=je_ &#39;CFLAGS=-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops &#39; LDFLAGS=
CC                 : gcc
CONFIGURE_CFLAGS   : -std=gnu11 -Wall -Wextra -Wsign-compare -Wundef -Wno-format-zero-length -pipe -g3 -fvisibility=hidden -O3 -funroll-loops
SPECIFIED_CFLAGS   : -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops 
EXTRA_CFLAGS       : 
CPPFLAGS           : -D_GNU_SOURCE -D_REENTRANT
CXX                : g++
CONFIGURE_CXXFLAGS : -Wall -Wextra -g3 -fvisibility=hidden -O3
SPECIFIED_CXXFLAGS : 
EXTRA_CXXFLAGS     : 
LDFLAGS            : 
EXTRA_LDFLAGS      : 
DSO_LDFLAGS        : -shared -Wl,-soname,$(@F)
LIBS               : -lm -lstdc++ -pthread -ldl
RPATH_EXTRA        : 

XSLTPROC           : false
XSLROOT            : 

PREFIX             : /usr/local
BINDIR             : /usr/local/bin
DATADIR            : /usr/local/share
INCLUDEDIR         : /usr/local/include
LIBDIR             : /usr/local/lib
MANDIR             : /usr/local/share/man

srcroot            : 
abs_srcroot        : /scratch/proj/hugectr/notebooks/redis/deps/jemalloc/
objroot            : 
abs_objroot        : /scratch/proj/hugectr/notebooks/redis/deps/jemalloc/

JEMALLOC_PREFIX    : je_
JEMALLOC_PRIVATE_NAMESPACE
                   : je_
install_suffix     : 
malloc_conf        : 
documentation      : 1
shared libs        : 1
static libs        : 1
autogen            : 0
debug              : 0
stats              : 1
experimetal_smallocx : 0
prof               : 0
prof-libunwind     : 0
prof-libgcc        : 0
prof-gcc           : 0
fill               : 1
utrace             : 0
xmalloc            : 0
log                : 0
lazy_lock          : 0
cache-oblivious    : 1
cxx                : 1
===============================================================================
cd jemalloc &amp;&amp; make CFLAGS=&quot;-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops &quot; LDFLAGS=&quot;&quot; lib/libjemalloc.a
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/jemalloc&#39;
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/jemalloc.sym.o src/jemalloc.c
nm -a src/jemalloc.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/jemalloc.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/arena.sym.o src/arena.c
nm -a src/arena.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/arena.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/background_thread.sym.o src/background_thread.c
nm -a src/background_thread.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/background_thread.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/base.sym.o src/base.c
nm -a src/base.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/base.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/bin.sym.o src/bin.c
nm -a src/bin.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/bin.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/bitmap.sym.o src/bitmap.c
nm -a src/bitmap.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/bitmap.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/ckh.sym.o src/ckh.c
nm -a src/ckh.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/ckh.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/ctl.sym.o src/ctl.c
nm -a src/ctl.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/ctl.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/div.sym.o src/div.c
nm -a src/div.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/div.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/extent.sym.o src/extent.c
nm -a src/extent.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/extent.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/extent_dss.sym.o src/extent_dss.c
nm -a src/extent_dss.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/extent_dss.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/extent_mmap.sym.o src/extent_mmap.c
nm -a src/extent_mmap.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/extent_mmap.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/hash.sym.o src/hash.c
nm -a src/hash.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/hash.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/hook.sym.o src/hook.c
nm -a src/hook.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/hook.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/large.sym.o src/large.c
nm -a src/large.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/large.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/log.sym.o src/log.c
nm -a src/log.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/log.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/malloc_io.sym.o src/malloc_io.c
nm -a src/malloc_io.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/malloc_io.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/mutex.sym.o src/mutex.c
nm -a src/mutex.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/mutex.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/mutex_pool.sym.o src/mutex_pool.c
nm -a src/mutex_pool.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/mutex_pool.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/nstime.sym.o src/nstime.c
nm -a src/nstime.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/nstime.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/pages.sym.o src/pages.c
nm -a src/pages.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/pages.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/prng.sym.o src/prng.c
nm -a src/prng.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/prng.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/prof.sym.o src/prof.c
nm -a src/prof.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/prof.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/rtree.sym.o src/rtree.c
nm -a src/rtree.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/rtree.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/safety_check.sym.o src/safety_check.c
nm -a src/safety_check.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/safety_check.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/stats.sym.o src/stats.c
nm -a src/stats.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/stats.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/sc.sym.o src/sc.c
nm -a src/sc.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/sc.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/sz.sym.o src/sz.c
nm -a src/sz.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/sz.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/tcache.sym.o src/tcache.c
nm -a src/tcache.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/tcache.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/test_hooks.sym.o src/test_hooks.c
nm -a src/test_hooks.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/test_hooks.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/ticker.sym.o src/ticker.c
nm -a src/ticker.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/ticker.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/tsd.sym.o src/tsd.c
nm -a src/tsd.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/tsd.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/witness.sym.o src/witness.c
nm -a src/witness.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/witness.sym
/bin/sh include/jemalloc/internal/private_namespace.sh src/jemalloc.sym src/arena.sym src/background_thread.sym src/base.sym src/bin.sym src/bitmap.sym src/ckh.sym src/ctl.sym src/div.sym src/extent.sym src/extent_dss.sym src/extent_mmap.sym src/hash.sym src/hook.sym src/large.sym src/log.sym src/malloc_io.sym src/mutex.sym src/mutex_pool.sym src/nstime.sym src/pages.sym src/prng.sym src/prof.sym src/rtree.sym src/safety_check.sym src/stats.sym src/sc.sym src/sz.sym src/tcache.sym src/test_hooks.sym src/ticker.sym src/tsd.sym src/witness.sym &gt; include/jemalloc/internal/private_namespace.gen.h
cp include/jemalloc/internal/private_namespace.gen.h include/jemalloc/internal/private_namespace.gen.h
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/jemalloc.o src/jemalloc.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/arena.o src/arena.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/background_thread.o src/background_thread.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/base.o src/base.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/bin.o src/bin.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/bitmap.o src/bitmap.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ckh.o src/ckh.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ctl.o src/ctl.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/div.o src/div.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent.o src/extent.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent_dss.o src/extent_dss.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent_mmap.o src/extent_mmap.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/hash.o src/hash.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/hook.o src/hook.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/large.o src/large.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/log.o src/log.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/malloc_io.o src/malloc_io.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mutex.o src/mutex.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mutex_pool.o src/mutex_pool.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/nstime.o src/nstime.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/pages.o src/pages.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/prng.o src/prng.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/prof.o src/prof.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/rtree.o src/rtree.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/safety_check.o src/safety_check.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/stats.o src/stats.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/sc.o src/sc.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/sz.o src/sz.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tcache.o src/tcache.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/test_hooks.o src/test_hooks.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ticker.o src/ticker.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tsd.o src/tsd.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/witness.o src/witness.c
g++ -Wall -Wextra -g3 -fvisibility=hidden -O3 -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/jemalloc_cpp.o src/jemalloc_cpp.cpp
ar crus lib/libjemalloc.a src/jemalloc.o src/arena.o src/background_thread.o src/base.o src/bin.o src/bitmap.o src/ckh.o src/ctl.o src/div.o src/extent.o src/extent_dss.o src/extent_mmap.o src/hash.o src/hook.o src/large.o src/log.o src/malloc_io.o src/mutex.o src/mutex_pool.o src/nstime.o src/pages.o src/prng.o src/prof.o src/rtree.o src/safety_check.o src/stats.o src/sc.o src/sz.o src/tcache.o src/test_hooks.o src/ticker.o src/tsd.o src/witness.o src/jemalloc_cpp.o
ar: `u&#39; modifier ignored since `D&#39; is the default (see `U&#39;)
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/jemalloc&#39;
make[2]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps&#39;
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">adlist.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">quicklist.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">ae.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">anet.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">dict.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">server.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sds.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">zmalloc.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lzf_c.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lzf_d.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">pqsort.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">zipmap.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sha1.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">ziplist.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">release.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">networking.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">util.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">object.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">db.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">replication.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">rdb.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_string.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_list.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_set.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_zset.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_hash.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">config.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">aof.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">pubsub.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">multi.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">debug.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sort.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">intset.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">syncio.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">cluster.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">crc16.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">endianconv.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">slowlog.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">eval.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">bio.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">rio.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">rand.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">memtest.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">syscheck.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">crcspeed.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">crc64.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">bitops.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sentinel.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">notify.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">setproctitle.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">blocked.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">hyperloglog.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">latency.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sparkline.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redis-check-rdb.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redis-check-aof.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">geo.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lazyfree.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">module.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">evict.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">expire.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">geohash.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">geohash_helper.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">childinfo.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">defrag.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">siphash.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">rax.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_stream.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">listpack.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">localtime.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lolwut.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lolwut5.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lolwut6.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">acl.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">tracking.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">connection.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">tls.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sha256.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">timeout.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">setcpuaffinity.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">monotonic.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">mt19937-64.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">resp_parser.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">call_reply.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">script_lua.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">script.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">functions.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">function_lua.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">commands.o</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">LINK</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-server</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">INSTALL</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-sentinel</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redis-cli.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redisassert.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">cli_common.o</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">LINK</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-cli</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redis-benchmark.o</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">LINK</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-benchmark</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">INSTALL</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-check-rdb</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">INSTALL</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-check-aof</span>

Hint: It&#39;s a good idea to run &#39;make test&#39; ;)

make[1]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/src&#39;
</pre></div>
</div>
</div>
</div>
<p>If you see the message <code class="docutils literal notranslate"><span class="pre">Hint:</span> <span class="pre">It's</span> <span class="pre">a</span> <span class="pre">good</span> <span class="pre">idea</span> <span class="pre">to</span> <span class="pre">run</span> <span class="pre">'make</span> <span class="pre">test'</span> <span class="pre">;)</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make[1]:</span> <span class="pre">Leaving</span> <span class="pre">directory</span> <span class="pre">...</span></code>, the compilation should have completed successfully.</p>
<p><strong>Step 2: Configure a mock Redis cluster</strong></p>
<p><em>WARNING: The following commands will erase the all contents in the following directories: <code class="docutils literal notranslate"><span class="pre">redis-server-1</span></code>, <code class="docutils literal notranslate"><span class="pre">redis-server-2</span></code> and <code class="docutils literal notranslate"><span class="pre">redis-server-3</span></code>.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>redis-server-1<span class="w"> </span>redis-server-2<span class="w"> </span>redis-server-3
<span class="o">!</span>rm<span class="w"> </span>-f<span class="w"> </span>redis-server-1/*<span class="w"> </span>redis-server-2/*<span class="w"> </span>redis-server-3/*

<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/redis/src/redis-server<span class="w"> </span>redis-server-1/redis-server
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/redis/src/redis-server<span class="w"> </span>redis-server-2/redis-server
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/redis/src/redis-server<span class="w"> </span>redis-server-3/redis-server
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> redis-server-1/redis.conf
<span class="n">daemonize</span> <span class="n">yes</span>
<span class="n">port</span> <span class="mi">7000</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">enabled</span> <span class="n">yes</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">file</span> <span class="n">nodes</span><span class="o">.</span><span class="n">conf</span>
<span class="n">appendonly</span> <span class="n">no</span>
<span class="n">save</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing redis-server-1/redis.conf
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> redis-server-2/redis.conf
<span class="n">daemonize</span> <span class="n">yes</span>
<span class="n">port</span> <span class="mi">7001</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">enabled</span> <span class="n">yes</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">file</span> <span class="n">nodes</span><span class="o">.</span><span class="n">conf</span>
<span class="n">appendonly</span> <span class="n">no</span>
<span class="n">save</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing redis-server-2/redis.conf
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> redis-server-3/redis.conf
<span class="n">daemonize</span> <span class="n">yes</span>
<span class="n">port</span> <span class="mi">7002</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">enabled</span> <span class="n">yes</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">file</span> <span class="n">nodes</span><span class="o">.</span><span class="n">conf</span>
<span class="n">appendonly</span> <span class="n">no</span>
<span class="n">save</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing redis-server-3/redis.conf
</pre></div>
</div>
</div>
</div>
<p><strong>Step 3: Form Redis cluster</strong></p>
<p><em>WARNING: The following command will shutdown any processes called <code class="docutils literal notranslate"><span class="pre">redis-cluster</span></code> in the current system!</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Shutdown existing cluster (if any).
!pkill redis-server

# Reset configuration and start 3 Redis servers.
!cd redis-server-1 &amp;&amp; rm -f nodes.conf &amp;&amp; ./redis-server redis.conf
!cd redis-server-2 &amp;&amp; rm -f nodes.conf &amp;&amp; ./redis-server redis.conf
!cd redis-server-3 &amp;&amp; rm -f nodes.conf &amp;&amp; ./redis-server redis.conf

# Form the cluster.
!redis/src/redis-cli \
    --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
    --cluster-yes
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">&gt;&gt;&gt; Performing hash slots allocation on 3 nodes...</span>
Master[0] -&gt; Slots 0 - 5460
Master[1] -&gt; Slots 5461 - 10922
Master[2] -&gt; Slots 10923 - 16383
M: c9f4cf21be51d0e7f42aa860eefeec3fe51b2c48 127.0.0.1:7000
   slots:[0-5460] (5461 slots) master
M: fe4fe8147f6dc521559bbb5f7bf185370da0fab1 127.0.0.1:7001
   slots:[5461-10922] (5462 slots) master
M: aca91565fb9dce044e8c1bffd280aa029a11951e 127.0.0.1:7002
   slots:[10923-16383] (5461 slots) master
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Nodes configuration updated</span>
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Assign a different config epoch to each node</span>
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span>
Waiting for the cluster to join
..
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span>
M: c9f4cf21be51d0e7f42aa860eefeec3fe51b2c48 127.0.0.1:7000
   slots:[0-5460] (5461 slots) master
M: aca91565fb9dce044e8c1bffd280aa029a11951e 127.0.0.1:7002
   slots:[10923-16383] (5461 slots) master
M: fe4fe8147f6dc521559bbb5f7bf185370da0fab1 127.0.0.1:7001
   slots:[5461-10922] (5462 slots) master
<span class=" -Color -Color-Bold -Color-Bold-Green">[OK] All nodes agree about slots configuration.</span>
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Check for open slots...</span>
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Check slots coverage...</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">[OK] All 16384 slots covered.</span>

</pre></div>
</div>
</div>
</div>
<p><strong>Step 4: Run HugeCTR</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="nn">ort</span>
<span class="kn">from</span> <span class="nn">hugectr</span> <span class="kn">import</span> <span class="n">DatabaseType_t</span>
<span class="kn">from</span> <span class="nn">hugectr.inference</span> <span class="kn">import</span> <span class="n">HPS</span><span class="p">,</span> <span class="n">ParameterServerConfig</span><span class="p">,</span> <span class="n">InferenceParams</span><span class="p">,</span> <span class="n">VolatileDatabaseParams</span>

<span class="n">slot_size_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="n">key_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">slot_size_array</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Launching...&#39;</span><span class="p">)</span>

<span class="c1"># 1. Configure the HPS hyperparameters.</span>
<span class="n">ps_config</span> <span class="o">=</span> <span class="n">ParameterServerConfig</span><span class="p">(</span>
       <span class="n">emb_table_name</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hps_demo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sparse_embedding1&#39;</span><span class="p">,</span> <span class="s1">&#39;sparse_embedding2&#39;</span><span class="p">]},</span>
       <span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hps_demo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">]},</span>
       <span class="n">max_feature_num_per_sample_per_emb_table</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hps_demo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]},</span>
       <span class="n">inference_params_array</span> <span class="o">=</span> <span class="p">[</span>
          <span class="n">InferenceParams</span><span class="p">(</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;hps_demo&#39;</span><span class="p">,</span>
            <span class="n">max_batchsize</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">hit_rate_threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">dense_model_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">sparse_model_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hps_demo0_sparse_1000.model&#39;</span><span class="p">,</span> <span class="s1">&#39;hps_demo1_sparse_1000.model&#39;</span><span class="p">],</span>
            <span class="n">deployed_devices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">use_gpu_embedding_cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">cache_size_percentage</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
       <span class="p">],</span>
       <span class="n">volatile_db</span> <span class="o">=</span> <span class="n">VolatileDatabaseParams</span><span class="p">(</span>
            <span class="n">DatabaseType_t</span><span class="o">.</span><span class="n">redis_cluster</span><span class="p">,</span>
            <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1:7000&#39;</span><span class="p">,</span>
            <span class="n">num_partitions</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
            <span class="n">num_node_connections</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
       <span class="p">))</span>

<span class="c1"># 2. Initialize the HPS object.</span>
<span class="n">hps</span> <span class="o">=</span> <span class="n">HPS</span><span class="p">(</span><span class="n">ps_config</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;HPS initialized&#39;</span><span class="p">)</span>

<span class="c1"># 3. Load query data.</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s1">&#39;data_parquet/val/gen_0.parquet&#39;</span><span class="p">)</span>
<span class="n">dense_input_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
<span class="n">cat_input1_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
<span class="n">cat_input2_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span>
<span class="n">dense_input</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dense_input_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">cat_input1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat_input1_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">cat_input2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat_input2_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># 4. Make inference from the HPS object and the ONNX inference session of `hps_demo_without_embedding.onnx`.</span>
<span class="n">embedding1</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s1">&#39;hps_demo&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">embedding2</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s1">&#39;hps_demo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="s1">&#39;hps_demo_without_embedding.onnx&#39;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">sess</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
               <span class="n">input_feed</span><span class="o">=</span><span class="p">{</span><span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dense_input</span><span class="p">,</span>
               <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">embedding1</span><span class="p">,</span>
               <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">embedding2</span><span class="p">})</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># 5. Check the correctness by comparing with dumped evaluation results.</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;hps_demo_pred_1000&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                         HPS demo without embedding                            &#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ground truth: </span><span class="si">{</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">ground_truth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prediction without embedding: </span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">-</span> <span class="n">ground_truth</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE between prediction and ground_truth: </span><span class="si">{</span><span class="n">mse</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 6. Make inference with the ONNX inference session of `hps_demo_with_embedding.onnx` (double check).</span>
<span class="n">sess_ref</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="s1">&#39;hps_demo_with_embedding.onnx&#39;</span><span class="p">)</span>
<span class="n">res_ref</span> <span class="o">=</span> <span class="n">sess_ref</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">sess_ref</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
               <span class="n">input_feed</span><span class="o">=</span><span class="p">{</span><span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dense_input</span><span class="p">,</span>
               <span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cat_input1</span><span class="p">,</span>
               <span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cat_input2</span><span class="p">})</span>
<span class="n">pred_ref</span> <span class="o">=</span> <span class="n">res_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                           HPS demo with embedding                             &#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ground truth: </span><span class="si">{</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">ground_truth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prediction with embedding: </span><span class="si">{</span><span class="n">pred_ref</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">pred_ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">diff_ref</span> <span class="o">=</span> <span class="n">pred_ref</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">ground_truth</span>
<span class="n">mse_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_ref</span> <span class="o">*</span> <span class="n">diff_ref</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE between prediction and ground_truth: </span><span class="si">{</span><span class="n">mse_ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Launching...
[HCTR][14:27:09.527][WARNING][RK0][main]: default_value_for_each_table.size() is not equal to the number of embedding tables
HPS initialized
====================================================HPS Create====================================================
[HCTR][14:27:09.528][INFO][RK0][main]: Creating RedisCluster backend...
[HCTR][14:27:09.529][INFO][RK0][main]: RedisCluster: Connecting via 127.0.0.1:7000...
[HCTR][14:27:09.530][INFO][RK0][main]: Volatile DB: initial cache rate = 1
[HCTR][14:27:09.530][INFO][RK0][main]: Volatile DB: cache missed embeddings = 0
[HCTR][14:27:09.530][DEBUG][RK0][main]: Created raw model loader in local memory!
[HCTR][14:27:09.530][INFO][RK0][main]: Using Local file system backend.
[HCTR][14:27:09.618][INFO][RK0][main]: Table: hps_et.hps_demo.sparse_embedding1; cached 18479 / 18479 embeddings in volatile database (RedisCluster); load: 18479 / 18446744073709551615 (0.00%).
[HCTR][14:27:09.618][INFO][RK0][main]: Using Local file system backend.
[HCTR][14:27:09.646][INFO][RK0][main]: Table: hps_et.hps_demo.sparse_embedding2; cached 18466 / 18466 embeddings in volatile database (RedisCluster); load: 18466 / 18446744073709551615 (0.00%).
[HCTR][14:27:09.646][DEBUG][RK0][main]: Real-time subscribers created!
[HCTR][14:27:09.646][INFO][RK0][main]: Creating embedding cache in device 0.
[HCTR][14:27:09.662][INFO][RK0][main]: Model name: hps_demo
[HCTR][14:27:09.662][INFO][RK0][main]: Max batch size: 1024
[HCTR][14:27:09.662][INFO][RK0][main]: Number of embedding tables: 2
[HCTR][14:27:09.662][INFO][RK0][main]: Use GPU embedding cache: True, cache size percentage: 0.500000
[HCTR][14:27:09.662][INFO][RK0][main]: Use static table: False
[HCTR][14:27:09.662][INFO][RK0][main]: Use I64 input key: True
[HCTR][14:27:09.662][INFO][RK0][main]: Configured cache hit rate threshold: 1.000000
[HCTR][14:27:09.662][INFO][RK0][main]: The size of thread pool: 256
[HCTR][14:27:09.662][INFO][RK0][main]: The size of worker memory pool: 2
[HCTR][14:27:09.662][INFO][RK0][main]: The size of refresh memory pool: 1
[HCTR][14:27:09.662][INFO][RK0][main]: The refresh percentage : 0.000000
[HCTR][14:27:11.048][INFO][RK0][main]: Creating lookup session for hps_demo on device: 0
-------------------------------------------------------------------------------
                         HPS demo without embedding                            
-------------------------------------------------------------------------------
Ground truth: (1024,) = [0.542481 0.53327  0.5184   ... 0.509011 0.474065 0.535471]
-------------------------------------------------------------------------------
Prediction without embedding: (1024,) = [0.54248124 0.5332703  0.5183997  ... 0.509011   0.4740651  0.53547084]
MSE between prediction and ground_truth: 8.599451821747372e-14
-------------------------------------------------------------------------------
                           HPS demo with embedding                             
-------------------------------------------------------------------------------
Ground truth: (1024,) = [0.542481 0.53327  0.5184   ... 0.509011 0.474065 0.535471]
-------------------------------------------------------------------------------
Prediction with embedding: (1024,) = [0.54248124 0.5332703  0.5183997  ... 0.509011   0.4740651  0.53547084]
MSE between prediction and ground_truth: 8.599451821747372e-14
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-01-18 14:27:11.167366091 [W:onnxruntime:, graph.cc:3559 CleanUnusedInitializersAndNodeArgs] Removing initializer &#39;key_to_indice_hash_all_tables&#39;. It is not used by any node and should be removed from the model.
</pre></div>
</div>
</div>
</div>
<p><strong>Step 5: Shutdown Redis cluster</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pkill<span class="w"> </span>redis-server
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="redis-cluster-deployment-with-tls-ssl">
<h2>Redis Cluster deployment (with TLS/SSL)<a class="headerlink" href="#redis-cluster-deployment-with-tls-ssl" title="Permalink to this headline"></a></h2>
<p>When using Redis as backing storage, HugeCTR can use make use of TLS/SSL to encrypt data transfers. In the following steps we setupt a small Redis cluster and enable SSL for it.</p>
<p><strong>Step 1: Build a TLS/SSL capable distribution of Redis</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>rm<span class="w"> </span>-f<span class="w"> </span><span class="m">7</span>.0.8.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/redis/redis/archive/7.0.8.tar.gz
<span class="o">!</span>rm<span class="w"> </span>-rf<span class="w"> </span>redis-7.0.8<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>tar<span class="w"> </span>-xf<span class="w"> </span><span class="m">7</span>.0.8.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-sf<span class="w"> </span>redis-7.0.8<span class="w"> </span>redis
<span class="o">!</span><span class="nb">cd</span><span class="w"> </span>redis<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span><span class="nv">BUILD_TLS</span><span class="o">=</span>yes
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2023-01-18 14:27:23--  https://github.com/redis/redis/archive/7.0.8.tar.gz
Resolving github.com (github.com)... 192.30.255.113
Connecting to github.com (github.com)|192.30.255.113|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://codeload.github.com/redis/redis/tar.gz/refs/tags/7.0.8 [following]
--2023-01-18 14:27:23--  https://codeload.github.com/redis/redis/tar.gz/refs/tags/7.0.8
Resolving codeload.github.com (codeload.github.com)... 192.30.255.121
Connecting to codeload.github.com (codeload.github.com)|192.30.255.121|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [application/x-gzip]
Saving to: ‘7.0.8.tar.gz’

7.0.8.tar.gz            [   &lt;=&gt;              ]   2.87M  5.39MB/s    in 0.5s    

2023-01-18 14:27:24 (5.39 MB/s) - ‘7.0.8.tar.gz’ saved [3011655]

cd src &amp;&amp; make all
make[1]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/src&#39;
./mkreleasehdr.sh: 1: echo: echo: I/O error
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">Makefile.dep</span>
./mkreleasehdr.sh: 1: echo: echo: I/O error
rm -rf redis-server redis-sentinel redis-cli redis-benchmark redis-check-rdb redis-check-aof *.o *.gcda *.gcno *.gcov redis.info lcov-html Makefile.dep
rm -f adlist.d quicklist.d ae.d anet.d dict.d server.d sds.d zmalloc.d lzf_c.d lzf_d.d pqsort.d zipmap.d sha1.d ziplist.d release.d networking.d util.d object.d db.d replication.d rdb.d t_string.d t_list.d t_set.d t_zset.d t_hash.d config.d aof.d pubsub.d multi.d debug.d sort.d intset.d syncio.d cluster.d crc16.d endianconv.d slowlog.d eval.d bio.d rio.d rand.d memtest.d syscheck.d crcspeed.d crc64.d bitops.d sentinel.d notify.d setproctitle.d blocked.d hyperloglog.d latency.d sparkline.d redis-check-rdb.d redis-check-aof.d geo.d lazyfree.d module.d evict.d expire.d geohash.d geohash_helper.d childinfo.d defrag.d siphash.d rax.d t_stream.d listpack.d localtime.d lolwut.d lolwut5.d lolwut6.d acl.d tracking.d connection.d tls.d sha256.d timeout.d setcpuaffinity.d monotonic.d mt19937-64.d resp_parser.d call_reply.d script_lua.d script.d functions.d function_lua.d commands.d anet.d adlist.d dict.d redis-cli.d zmalloc.d release.d ae.d redisassert.d crcspeed.d crc64.d siphash.d crc16.d monotonic.d cli_common.d mt19937-64.d ae.d anet.d redis-benchmark.d adlist.d dict.d zmalloc.d redisassert.d release.d crcspeed.d crc64.d siphash.d crc16.d monotonic.d cli_common.d mt19937-64.d
(cd ../deps &amp;&amp; make distclean)
make[2]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps&#39;
(cd hiredis &amp;&amp; make clean) &gt; /dev/null || true
(cd linenoise &amp;&amp; make clean) &gt; /dev/null || true
(cd lua &amp;&amp; make clean) &gt; /dev/null || true
(cd jemalloc &amp;&amp; [ -f Makefile ] &amp;&amp; make distclean) &gt; /dev/null || true
(cd hdr_histogram &amp;&amp; make clean) &gt; /dev/null || true
(rm -f .make-*)
make[2]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps&#39;
(cd modules &amp;&amp; make clean)
make[2]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/src/modules&#39;
rm -rf *.xo *.so
make[2]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/src/modules&#39;
(cd ../tests/modules &amp;&amp; make clean)
make[2]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/tests/modules&#39;
rm -f commandfilter.so basics.so testrdb.so fork.so infotest.so propagate.so misc.so hooks.so blockonkeys.so blockonbackground.so scan.so datatype.so datatype2.so auth.so keyspace_events.so blockedclient.so getkeys.so getchannels.so test_lazyfree.so timer.so defragtest.so keyspecs.so hash.so zset.so stream.so mallocsize.so aclcheck.so list.so subcommands.so reply.so cmdintrospection.so eventloop.so moduleconfigs.so moduleconfigstwo.so publish.so usercall.so commandfilter.xo basics.xo testrdb.xo fork.xo infotest.xo propagate.xo misc.xo hooks.xo blockonkeys.xo blockonbackground.xo scan.xo datatype.xo datatype2.xo auth.xo keyspace_events.xo blockedclient.xo getkeys.xo getchannels.xo test_lazyfree.xo timer.xo defragtest.xo keyspecs.xo hash.xo zset.xo stream.xo mallocsize.xo aclcheck.xo list.xo subcommands.xo reply.xo cmdintrospection.xo eventloop.xo moduleconfigs.xo moduleconfigstwo.xo publish.xo usercall.xo
make[2]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/tests/modules&#39;
(rm -f .make-*)
echo STD=-pedantic -DREDIS_STATIC=&#39;&#39; -std=c11 &gt;&gt; .make-settings
echo WARN=-Wall -W -Wno-missing-field-initializers &gt;&gt; .make-settings
echo OPT=-O2 &gt;&gt; .make-settings
echo MALLOC=jemalloc &gt;&gt; .make-settings
echo BUILD_TLS=yes &gt;&gt; .make-settings
echo USE_SYSTEMD= &gt;&gt; .make-settings
echo CFLAGS= &gt;&gt; .make-settings
echo LDFLAGS= &gt;&gt; .make-settings
echo REDIS_CFLAGS= &gt;&gt; .make-settings
echo REDIS_LDFLAGS= &gt;&gt; .make-settings
echo PREV_FINAL_CFLAGS=-pedantic -DREDIS_STATIC=&#39;&#39; -std=c11 -Wall -W -Wno-missing-field-initializers -O2 -g -ggdb   -I../deps/hiredis -I../deps/linenoise -I../deps/lua/src -I../deps/hdr_histogram -DUSE_JEMALLOC -I../deps/jemalloc/include -DUSE_OPENSSL  &gt;&gt; .make-settings
echo PREV_FINAL_LDFLAGS=  -g -ggdb -rdynamic  &gt;&gt; .make-settings
(cd ../deps &amp;&amp; make hiredis linenoise lua hdr_histogram jemalloc)
make[2]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps&#39;
(cd hiredis &amp;&amp; make clean) &gt; /dev/null || true
(cd linenoise &amp;&amp; make clean) &gt; /dev/null || true
(cd lua &amp;&amp; make clean) &gt; /dev/null || true
(cd jemalloc &amp;&amp; [ -f Makefile ] &amp;&amp; make distclean) &gt; /dev/null || true
(cd hdr_histogram &amp;&amp; make clean) &gt; /dev/null || true
(rm -f .make-*)
(echo &quot;&quot; &gt; .make-cflags)
(echo &quot;&quot; &gt; .make-ldflags)
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">hiredis</span>
cd hiredis &amp;&amp; make static USE_SSL=1
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/hiredis&#39;
cc -std=c99 -c -O3 -fPIC  -DHIREDIS_TEST_SSL -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic alloc.c
cc -std=c99 -c -O3 -fPIC  -DHIREDIS_TEST_SSL -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic net.c
cc -std=c99 -c -O3 -fPIC  -DHIREDIS_TEST_SSL -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic hiredis.c
cc -std=c99 -c -O3 -fPIC  -DHIREDIS_TEST_SSL -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic sds.c
cc -std=c99 -c -O3 -fPIC  -DHIREDIS_TEST_SSL -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic async.c
cc -std=c99 -c -O3 -fPIC  -DHIREDIS_TEST_SSL -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic read.c
cc -std=c99 -c -O3 -fPIC  -DHIREDIS_TEST_SSL -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic sockcompat.c
ar rcs libhiredis.a alloc.o net.o hiredis.o sds.o async.o read.o sockcompat.o
cc -std=c99 -c -O3 -fPIC  -DHIREDIS_TEST_SSL -Wall -W -Wstrict-prototypes -Wwrite-strings -Wno-missing-field-initializers -g -ggdb -pedantic ssl.c
ar rcs libhiredis_ssl.a ssl.o
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/hiredis&#39;
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">linenoise</span>
cd linenoise &amp;&amp; make
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/linenoise&#39;
cc  -Wall -Os -g  -c linenoise.c
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/linenoise&#39;
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">lua</span>
cd lua/src &amp;&amp; make all CFLAGS=&quot;-Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2 &quot; MYLDFLAGS=&quot;&quot; AR=&quot;ar rc&quot;
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/lua/src&#39;
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lapi.o lapi.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lcode.o lcode.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ldebug.o ldebug.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ldo.o ldo.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ldump.o ldump.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lfunc.o lfunc.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lgc.o lgc.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o llex.o llex.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lmem.o lmem.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lobject.o lobject.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lopcodes.o lopcodes.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lparser.o lparser.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lstate.o lstate.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lstring.o lstring.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ltable.o ltable.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ltm.o ltm.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lundump.o lundump.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lvm.o lvm.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lzio.o lzio.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o strbuf.o strbuf.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o fpconv.o fpconv.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lauxlib.o lauxlib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lbaselib.o lbaselib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ldblib.o ldblib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o liolib.o liolib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lmathlib.o lmathlib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o loslib.o loslib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o ltablib.o ltablib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lstrlib.o lstrlib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o loadlib.o loadlib.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o linit.o linit.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua_cjson.o lua_cjson.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua_struct.o lua_struct.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua_cmsgpack.o lua_cmsgpack.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua_bit.o lua_bit.c
ar rc liblua.a lapi.o lcode.o ldebug.o ldo.o ldump.o lfunc.o lgc.o llex.o lmem.o lobject.o lopcodes.o lparser.o lstate.o lstring.o ltable.o ltm.o lundump.o lvm.o lzio.o strbuf.o fpconv.o lauxlib.o lbaselib.o ldblib.o liolib.o lmathlib.o loslib.o ltablib.o lstrlib.o loadlib.o linit.o lua_cjson.o lua_struct.o lua_cmsgpack.o lua_bit.o	# DLL needs all object files
ranlib liblua.a
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o lua.o lua.c
cc -o lua  lua.o liblua.a -lm 
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o luac.o luac.c
cc -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=&#39;&#39; -DLUA_USE_MKSTEMP  -O2    -c -o print.o print.c
cc -o luac  luac.o print.o liblua.a -lm 
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/lua/src&#39;
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">hdr_histogram</span>
cd hdr_histogram &amp;&amp; make
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/hdr_histogram&#39;
cc -std=c99 -Wall -Os -g  -DHDR_MALLOC_INCLUDE=\&quot;hdr_redis_malloc.h\&quot; -c  hdr_histogram.c 
ar rcs libhdrhistogram.a hdr_histogram.o
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/hdr_histogram&#39;
<span class=" -Color -Color-Bold -Color-Bold-Green">MAKE</span> <span class=" -Color -Color-Bold -Color-Bold-White">jemalloc</span>
cd jemalloc &amp;&amp; ./configure --with-version=5.2.1-0-g0 --with-lg-quantum=3 --with-jemalloc-prefix=je_ CFLAGS=&quot;-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops &quot; LDFLAGS=&quot;&quot; 
checking for xsltproc... false
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether gcc accepts -g... yes
checking for gcc option to accept ISO C89... none needed
checking whether compiler is cray... no
checking whether compiler supports -std=gnu11... yes
checking whether compiler supports -Wall... yes
checking whether compiler supports -Wextra... yes
checking whether compiler supports -Wshorten-64-to-32... no
checking whether compiler supports -Wsign-compare... yes
checking whether compiler supports -Wundef... yes
checking whether compiler supports -Wno-format-zero-length... yes
checking whether compiler supports -pipe... yes
checking whether compiler supports -g3... yes
checking how to run the C preprocessor... gcc -E
checking for g++... g++
checking whether we are using the GNU C++ compiler... yes
checking whether g++ accepts -g... yes
checking whether g++ supports C++14 features by default... yes
checking whether compiler supports -Wall... yes
checking whether compiler supports -Wextra... yes
checking whether compiler supports -g3... yes
checking whether libstdc++ linkage is compilable... yes
checking for grep that handles long lines and -e... /usr/bin/grep
checking for egrep... /usr/bin/grep -E
checking for ANSI C header files... yes
checking for sys/types.h... yes
checking for sys/stat.h... yes
checking for stdlib.h... yes
checking for string.h... yes
checking for memory.h... yes
checking for strings.h... yes
checking for inttypes.h... yes
checking for stdint.h... yes
checking for unistd.h... yes
checking whether byte ordering is bigendian... no
checking size of void *... 8
checking size of int... 4
checking size of long... 8
checking size of long long... 8
checking size of intmax_t... 8
checking build system type... x86_64-pc-linux-gnu
checking host system type... x86_64-pc-linux-gnu
checking whether pause instruction is compilable... yes
checking number of significant virtual address bits... 48
checking for ar... ar
checking for nm... nm
checking for gawk... no
checking for mawk... mawk
checking malloc.h usability... yes
checking malloc.h presence... yes
checking for malloc.h... yes
checking whether malloc_usable_size definition can use const argument... no
checking for library containing log... -lm
checking whether __attribute__ syntax is compilable... yes
checking whether compiler supports -fvisibility=hidden... yes
checking whether compiler supports -fvisibility=hidden... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether tls_model attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether alloc_size attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether format(gnu_printf, ...) attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether format(printf, ...) attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether format(printf, ...) attribute is compilable... yes
checking for a BSD-compatible install... /usr/bin/install -c
checking for ranlib... ranlib
checking for ld... /usr/bin/ld
checking for autoconf... /usr/bin/autoconf
checking for memalign... yes
checking for valloc... yes
checking whether compiler supports -O3... yes
checking whether compiler supports -O3... yes
checking whether compiler supports -funroll-loops... yes
checking configured backtracing method... N/A
checking for sbrk... yes
checking whether utrace(2) is compilable... no
checking whether a program using __builtin_unreachable is compilable... yes
checking whether a program using __builtin_ffsl is compilable... yes
checking whether a program using __builtin_popcountl is compilable... yes
checking LG_PAGE... 12
checking pthread.h usability... yes
checking pthread.h presence... yes
checking for pthread.h... yes
checking for pthread_create in -lpthread... yes
checking dlfcn.h usability... yes
checking dlfcn.h presence... yes
checking for dlfcn.h... yes
checking for dlsym... no
checking for dlsym in -ldl... yes
checking whether pthread_atfork(3) is compilable... yes
checking whether pthread_setname_np(3) is compilable... yes
checking for library containing clock_gettime... none required
checking whether clock_gettime(CLOCK_MONOTONIC_COARSE, ...) is compilable... yes
checking whether clock_gettime(CLOCK_MONOTONIC, ...) is compilable... yes
checking whether mach_absolute_time() is compilable... no
checking whether compiler supports -Werror... yes
checking whether syscall(2) is compilable... yes
checking for secure_getenv... yes
checking for sched_getcpu... yes
checking for sched_setaffinity... yes
checking for issetugid... no
checking for _malloc_thread_cleanup... no
checking for _pthread_mutex_init_calloc_cb... no
checking for TLS... yes
checking whether C11 atomics is compilable... no
checking whether GCC __atomic atomics is compilable... yes
checking whether GCC 8-bit __atomic atomics is compilable... yes
checking whether GCC __sync atomics is compilable... yes
checking whether GCC 8-bit __sync atomics is compilable... yes
checking whether Darwin OSAtomic*() is compilable... no
checking whether madvise(2) is compilable... yes
checking whether madvise(..., MADV_FREE) is compilable... yes
checking whether madvise(..., MADV_DONTNEED) is compilable... yes
checking whether madvise(..., MADV_DO[NT]DUMP) is compilable... yes
checking whether madvise(..., MADV_[NO]HUGEPAGE) is compilable... yes
checking for __builtin_clz... yes
checking whether Darwin os_unfair_lock_*() is compilable... no
checking whether glibc malloc hook is compilable... yes
checking whether glibc memalign hook is compilable... yes
checking whether pthreads adaptive mutexes is compilable... yes
checking whether compiler supports -D_GNU_SOURCE... yes
checking whether compiler supports -Werror... yes
checking whether compiler supports -herror_on_warning... no
checking whether strerror_r returns char with gnu source is compilable... yes
checking for stdbool.h that conforms to C99... yes
checking for _Bool... yes
configure: creating ./config.status
config.status: creating Makefile
config.status: creating jemalloc.pc
config.status: creating doc/html.xsl
config.status: creating doc/manpages.xsl
config.status: creating doc/jemalloc.xml
config.status: creating include/jemalloc/jemalloc_macros.h
config.status: creating include/jemalloc/jemalloc_protos.h
config.status: creating include/jemalloc/jemalloc_typedefs.h
config.status: creating include/jemalloc/internal/jemalloc_preamble.h
config.status: creating test/test.sh
config.status: creating test/include/test/jemalloc_test.h
config.status: creating config.stamp
config.status: creating bin/jemalloc-config
config.status: creating bin/jemalloc.sh
config.status: creating bin/jeprof
config.status: creating include/jemalloc/jemalloc_defs.h
config.status: creating include/jemalloc/internal/jemalloc_internal_defs.h
config.status: creating test/include/test/jemalloc_test_defs.h
config.status: executing include/jemalloc/internal/public_symbols.txt commands
config.status: executing include/jemalloc/internal/private_symbols.awk commands
config.status: executing include/jemalloc/internal/private_symbols_jet.awk commands
config.status: executing include/jemalloc/internal/public_namespace.h commands
config.status: executing include/jemalloc/internal/public_unnamespace.h commands
config.status: executing include/jemalloc/jemalloc_protos_jet.h commands
config.status: executing include/jemalloc/jemalloc_rename.h commands
config.status: executing include/jemalloc/jemalloc_mangle.h commands
config.status: executing include/jemalloc/jemalloc_mangle_jet.h commands
config.status: executing include/jemalloc/jemalloc.h commands
===============================================================================
jemalloc version   : 5.2.1-0-g0
library revision   : 2

CONFIG             : --with-version=5.2.1-0-g0 --with-lg-quantum=3 --with-jemalloc-prefix=je_ &#39;CFLAGS=-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops &#39; LDFLAGS=
CC                 : gcc
CONFIGURE_CFLAGS   : -std=gnu11 -Wall -Wextra -Wsign-compare -Wundef -Wno-format-zero-length -pipe -g3 -fvisibility=hidden -O3 -funroll-loops
SPECIFIED_CFLAGS   : -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops 
EXTRA_CFLAGS       : 
CPPFLAGS           : -D_GNU_SOURCE -D_REENTRANT
CXX                : g++
CONFIGURE_CXXFLAGS : -Wall -Wextra -g3 -fvisibility=hidden -O3
SPECIFIED_CXXFLAGS : 
EXTRA_CXXFLAGS     : 
LDFLAGS            : 
EXTRA_LDFLAGS      : 
DSO_LDFLAGS        : -shared -Wl,-soname,$(@F)
LIBS               : -lm -lstdc++ -pthread -ldl
RPATH_EXTRA        : 

XSLTPROC           : false
XSLROOT            : 

PREFIX             : /usr/local
BINDIR             : /usr/local/bin
DATADIR            : /usr/local/share
INCLUDEDIR         : /usr/local/include
LIBDIR             : /usr/local/lib
MANDIR             : /usr/local/share/man

srcroot            : 
abs_srcroot        : /scratch/proj/hugectr/notebooks/redis/deps/jemalloc/
objroot            : 
abs_objroot        : /scratch/proj/hugectr/notebooks/redis/deps/jemalloc/

JEMALLOC_PREFIX    : je_
JEMALLOC_PRIVATE_NAMESPACE
                   : je_
install_suffix     : 
malloc_conf        : 
documentation      : 1
shared libs        : 1
static libs        : 1
autogen            : 0
debug              : 0
stats              : 1
experimetal_smallocx : 0
prof               : 0
prof-libunwind     : 0
prof-libgcc        : 0
prof-gcc           : 0
fill               : 1
utrace             : 0
xmalloc            : 0
log                : 0
lazy_lock          : 0
cache-oblivious    : 1
cxx                : 1
===============================================================================
cd jemalloc &amp;&amp; make CFLAGS=&quot;-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops &quot; LDFLAGS=&quot;&quot; lib/libjemalloc.a
make[3]: Entering directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/jemalloc&#39;
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/jemalloc.sym.o src/jemalloc.c
nm -a src/jemalloc.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/jemalloc.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/arena.sym.o src/arena.c
nm -a src/arena.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/arena.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/background_thread.sym.o src/background_thread.c
nm -a src/background_thread.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/background_thread.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/base.sym.o src/base.c
nm -a src/base.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/base.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/bin.sym.o src/bin.c
nm -a src/bin.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/bin.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/bitmap.sym.o src/bitmap.c
nm -a src/bitmap.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/bitmap.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/ckh.sym.o src/ckh.c
nm -a src/ckh.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/ckh.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/ctl.sym.o src/ctl.c
nm -a src/ctl.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/ctl.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/div.sym.o src/div.c
nm -a src/div.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/div.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/extent.sym.o src/extent.c
nm -a src/extent.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/extent.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/extent_dss.sym.o src/extent_dss.c
nm -a src/extent_dss.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/extent_dss.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/extent_mmap.sym.o src/extent_mmap.c
nm -a src/extent_mmap.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/extent_mmap.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/hash.sym.o src/hash.c
nm -a src/hash.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/hash.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/hook.sym.o src/hook.c
nm -a src/hook.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/hook.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/large.sym.o src/large.c
nm -a src/large.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/large.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/log.sym.o src/log.c
nm -a src/log.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/log.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/malloc_io.sym.o src/malloc_io.c
nm -a src/malloc_io.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/malloc_io.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/mutex.sym.o src/mutex.c
nm -a src/mutex.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/mutex.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/mutex_pool.sym.o src/mutex_pool.c
nm -a src/mutex_pool.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/mutex_pool.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/nstime.sym.o src/nstime.c
nm -a src/nstime.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/nstime.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/pages.sym.o src/pages.c
nm -a src/pages.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/pages.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/prng.sym.o src/prng.c
nm -a src/prng.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/prng.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/prof.sym.o src/prof.c
nm -a src/prof.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/prof.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/rtree.sym.o src/rtree.c
nm -a src/rtree.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/rtree.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/safety_check.sym.o src/safety_check.c
nm -a src/safety_check.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/safety_check.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/stats.sym.o src/stats.c
nm -a src/stats.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/stats.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/sc.sym.o src/sc.c
nm -a src/sc.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/sc.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/sz.sym.o src/sz.c
nm -a src/sz.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/sz.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/tcache.sym.o src/tcache.c
nm -a src/tcache.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/tcache.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/test_hooks.sym.o src/test_hooks.c
nm -a src/test_hooks.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/test_hooks.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/ticker.sym.o src/ticker.c
nm -a src/ticker.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/ticker.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/tsd.sym.o src/tsd.c
nm -a src/tsd.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/tsd.sym
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -DJEMALLOC_NO_PRIVATE_NAMESPACE -o src/witness.sym.o src/witness.c
nm -a src/witness.sym.o | mawk -f include/jemalloc/internal/private_symbols.awk &gt; src/witness.sym
/bin/sh include/jemalloc/internal/private_namespace.sh src/jemalloc.sym src/arena.sym src/background_thread.sym src/base.sym src/bin.sym src/bitmap.sym src/ckh.sym src/ctl.sym src/div.sym src/extent.sym src/extent_dss.sym src/extent_mmap.sym src/hash.sym src/hook.sym src/large.sym src/log.sym src/malloc_io.sym src/mutex.sym src/mutex_pool.sym src/nstime.sym src/pages.sym src/prng.sym src/prof.sym src/rtree.sym src/safety_check.sym src/stats.sym src/sc.sym src/sz.sym src/tcache.sym src/test_hooks.sym src/ticker.sym src/tsd.sym src/witness.sym &gt; include/jemalloc/internal/private_namespace.gen.h
cp include/jemalloc/internal/private_namespace.gen.h include/jemalloc/internal/private_namespace.gen.h
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/jemalloc.o src/jemalloc.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/arena.o src/arena.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/background_thread.o src/background_thread.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/base.o src/base.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/bin.o src/bin.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/bitmap.o src/bitmap.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ckh.o src/ckh.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ctl.o src/ctl.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/div.o src/div.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent.o src/extent.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent_dss.o src/extent_dss.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent_mmap.o src/extent_mmap.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/hash.o src/hash.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/hook.o src/hook.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/large.o src/large.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/log.o src/log.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/malloc_io.o src/malloc_io.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mutex.o src/mutex.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mutex_pool.o src/mutex_pool.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/nstime.o src/nstime.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/pages.o src/pages.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/prng.o src/prng.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/prof.o src/prof.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/rtree.o src/rtree.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/safety_check.o src/safety_check.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/stats.o src/stats.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/sc.o src/sc.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/sz.o src/sz.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tcache.o src/tcache.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/test_hooks.o src/test_hooks.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ticker.o src/ticker.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tsd.o src/tsd.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/witness.o src/witness.c
g++ -Wall -Wextra -g3 -fvisibility=hidden -O3 -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/jemalloc_cpp.o src/jemalloc_cpp.cpp
ar crus lib/libjemalloc.a src/jemalloc.o src/arena.o src/background_thread.o src/base.o src/bin.o src/bitmap.o src/ckh.o src/ctl.o src/div.o src/extent.o src/extent_dss.o src/extent_mmap.o src/hash.o src/hook.o src/large.o src/log.o src/malloc_io.o src/mutex.o src/mutex_pool.o src/nstime.o src/pages.o src/prng.o src/prof.o src/rtree.o src/safety_check.o src/stats.o src/sc.o src/sz.o src/tcache.o src/test_hooks.o src/ticker.o src/tsd.o src/witness.o src/jemalloc_cpp.o
ar: `u&#39; modifier ignored since `D&#39; is the default (see `U&#39;)
make[3]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps/jemalloc&#39;
make[2]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/deps&#39;
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">adlist.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">quicklist.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">ae.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">anet.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">dict.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">server.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sds.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">zmalloc.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lzf_c.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lzf_d.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">pqsort.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">zipmap.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sha1.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">ziplist.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">release.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">networking.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">util.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">object.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">db.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">replication.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">rdb.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_string.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_list.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_set.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_zset.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_hash.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">config.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">aof.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">pubsub.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">multi.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">debug.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sort.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">intset.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">syncio.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">cluster.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">crc16.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">endianconv.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">slowlog.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">eval.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">bio.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">rio.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">rand.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">memtest.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">syscheck.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">crcspeed.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">crc64.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">bitops.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sentinel.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">notify.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">setproctitle.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">blocked.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">hyperloglog.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">latency.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sparkline.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redis-check-rdb.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redis-check-aof.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">geo.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lazyfree.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">module.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">evict.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">expire.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">geohash.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">geohash_helper.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">childinfo.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">defrag.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">siphash.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">rax.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">t_stream.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">listpack.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">localtime.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lolwut.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lolwut5.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">lolwut6.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">acl.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">tracking.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">connection.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">tls.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">sha256.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">timeout.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">setcpuaffinity.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">monotonic.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">mt19937-64.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">resp_parser.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">call_reply.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">script_lua.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">script.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">functions.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">function_lua.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">commands.o</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">LINK</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-server</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">INSTALL</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-sentinel</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redis-cli.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redisassert.o</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">cli_common.o</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">LINK</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-cli</span>
    <span class=" -Color -Color-Blue">CC</span> <span class=" -Color -Color-Yellow">redis-benchmark.o</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">LINK</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-benchmark</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">INSTALL</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-check-rdb</span>
    <span class=" -Color -Color-Bold -Color-Bold-Blue">INSTALL</span> <span class=" -Color -Color-Bold -Color-Bold-White">redis-check-aof</span>

Hint: It&#39;s a good idea to run &#39;make test&#39; ;)

make[1]: Leaving directory &#39;/scratch/proj/hugectr/notebooks/redis-7.0.8/src&#39;
</pre></div>
</div>
</div>
</div>
<p>If you see the message <code class="docutils literal notranslate"><span class="pre">Hint:</span> <span class="pre">It's</span> <span class="pre">a</span> <span class="pre">good</span> <span class="pre">idea</span> <span class="pre">to</span> <span class="pre">run</span> <span class="pre">'make</span> <span class="pre">test'</span> <span class="pre">;)</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make[1]:</span> <span class="pre">Leaving</span> <span class="pre">directory</span> <span class="pre">...</span></code>, the compilation should have completed successfully.</p>
<p><strong>Step 2: Configure a mock Redis cluster</strong></p>
<p>Setup TLS/SSL certificates. Can skip if encyryption is not needed.</p>
<p><em>WARNING: The following commands will erase the all contents in the following directories: <code class="docutils literal notranslate"><span class="pre">test_certs</span></code>, <code class="docutils literal notranslate"><span class="pre">redis-server-1</span></code>, <code class="docutils literal notranslate"><span class="pre">redis-server-2</span></code> and <code class="docutils literal notranslate"><span class="pre">redis-server-3</span></code>.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!mkdir -p test_certs
!rm -f test_certs/*

with open(&quot;test_certs/openssl.conf&quot;, &quot;w&quot;) as f:
    f.write(&quot;&quot;&quot;[ redis_server ]
keyUsage = digitalSignature, keyEncipherment

[ hugectr_client ]
keyUsage = digitalSignature, keyEncipherment
nsCertType = client&quot;&quot;&quot;)
    
# Create private keys for CA, Redis server and HugeCTR client.
!openssl genrsa -out test_certs/ca-private.pem 4096
!openssl genrsa -out test_certs/redis-private.pem 4096
!openssl genrsa -out test_certs/hugectr-private.pem 4096

# Create public keys for CA, Redis server and HugeCTR client.
#!openssl rsa -pubout -in test_certs/ca-private.pem -out test_certs/ca-public.pem
#!openssl rsa -pubout -in test_certs/redis-private.pem -out test_certs/redis-public.pem
#!openssl rsa -pubout -in test_certs/hugectr-private.pem -out test_certs/hugectr-public.pem

# Form dummy CA.
!openssl req -new -nodes -sha256 -x509 -subj &#39;/O=NVIDIA Merlin/CN=Certificate Authority&#39; -days 365 \
    -key test_certs/ca-private.pem \
    -out test_certs/ca.crt
    
# Generate certificate for Redis server.
!openssl req -new -sha256 -subj &quot;/O=NVIDIA Merlin/CN=Redis Server&quot; \
    -key test_certs/redis-private.pem | \
        openssl x509 -req -sha256 \
            -CA test_certs/ca.crt \
            -CAkey test_certs/ca-private.pem \
            -CAserial test_certs/redis.ser \
            -CAcreateserial \
            -days 365 \
            -extfile test_certs/openssl.conf -extensions redis_server \
            -out test_certs/redis.crt

# Generate certificate for HugeCTR client.
!openssl req -new -sha256 -subj &quot;/O=NVIDIA Merlin/CN=HugeCTR Redis Client&quot; \
        -key test_certs/hugectr-private.pem | \
        openssl x509 \
            -req -sha256 \
            -CA test_certs/ca.crt \
            -CAkey test_certs/ca-private.pem \
            -CAserial test_certs/hugectr.ser \
            -CAcreateserial \
            -days 365 \
            -extfile test_certs/openssl.conf -extensions hugectr_client \
            -out test_certs/hugectr.crt
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generating RSA private key, 4096 bit long modulus (2 primes)
...............................................................................................++++
.........................++++
e is 65537 (0x010001)
Generating RSA private key, 4096 bit long modulus (2 primes)
....................................................++++
...................................................................................................................................................................................++++
e is 65537 (0x010001)
Generating RSA private key, 4096 bit long modulus (2 primes)
........................................................................................................++++
..............................................................................++++
e is 65537 (0x010001)
Signature ok
subject=O = NVIDIA Merlin, CN = Redis Server
Getting CA Private Key
Signature ok
subject=O = NVIDIA Merlin, CN = HugeCTR Redis Client
Getting CA Private Key
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>redis-server-1<span class="w"> </span>redis-server-2<span class="w"> </span>redis-server-3
<span class="o">!</span>rm<span class="w"> </span>-f<span class="w"> </span>redis-server-1/*<span class="w"> </span>redis-server-2/*<span class="w"> </span>redis-server-3/*

<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/redis/src/redis-server<span class="w"> </span>redis-server-1/redis-server
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/redis/src/redis-server<span class="w"> </span>redis-server-2/redis-server
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/redis/src/redis-server<span class="w"> </span>redis-server-3/redis-server

<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/ca.crt<span class="w"> </span>redis-server-1/ca.crt
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/ca.crt<span class="w"> </span>redis-server-2/ca.crt
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/ca.crt<span class="w"> </span>redis-server-3/ca.crt

<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/redis-private.pem<span class="w"> </span>redis-server-1/private.pem
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/redis-private.pem<span class="w"> </span>redis-server-2/private.pem
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/redis-private.pem<span class="w"> </span>redis-server-3/private.pem

<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/redis.crt<span class="w"> </span>redis-server-1/redis.crt
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/redis.crt<span class="w"> </span>redis-server-2/redis.crt
<span class="o">!</span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$PWD</span>/test_certs/redis.crt<span class="w"> </span>redis-server-3/redis.crt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> redis-server-1/redis.conf
<span class="n">daemonize</span> <span class="n">yes</span>
<span class="n">port</span> <span class="mi">0</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">enabled</span> <span class="n">yes</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">file</span> <span class="n">nodes</span><span class="o">.</span><span class="n">conf</span>
<span class="n">tls</span><span class="o">-</span><span class="n">port</span> <span class="mi">7000</span>
<span class="n">tls</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span> <span class="n">ca</span><span class="o">.</span><span class="n">crt</span>
<span class="n">tls</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span> <span class="n">redis</span><span class="o">.</span><span class="n">crt</span>
<span class="n">tls</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span> <span class="n">private</span><span class="o">.</span><span class="n">pem</span>
<span class="n">tls</span><span class="o">-</span><span class="n">cluster</span> <span class="n">yes</span>
<span class="n">appendonly</span> <span class="n">no</span>
<span class="n">save</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing redis-server-1/redis.conf
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> redis-server-2/redis.conf
<span class="n">daemonize</span> <span class="n">yes</span>
<span class="n">port</span> <span class="mi">0</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">enabled</span> <span class="n">yes</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">file</span> <span class="n">nodes</span><span class="o">.</span><span class="n">conf</span>
<span class="n">tls</span><span class="o">-</span><span class="n">port</span> <span class="mi">7001</span>
<span class="n">tls</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span> <span class="n">ca</span><span class="o">.</span><span class="n">crt</span>
<span class="n">tls</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span> <span class="n">redis</span><span class="o">.</span><span class="n">crt</span>
<span class="n">tls</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span> <span class="n">private</span><span class="o">.</span><span class="n">pem</span>
<span class="n">tls</span><span class="o">-</span><span class="n">cluster</span> <span class="n">yes</span>
<span class="n">appendonly</span> <span class="n">no</span>
<span class="n">save</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing redis-server-2/redis.conf
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> redis-server-3/redis.conf
<span class="n">daemonize</span> <span class="n">yes</span>
<span class="n">port</span> <span class="mi">0</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">enabled</span> <span class="n">yes</span>
<span class="n">cluster</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">file</span> <span class="n">nodes</span><span class="o">.</span><span class="n">conf</span>
<span class="n">tls</span><span class="o">-</span><span class="n">port</span> <span class="mi">7002</span>
<span class="n">tls</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span> <span class="n">ca</span><span class="o">.</span><span class="n">crt</span>
<span class="n">tls</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span> <span class="n">redis</span><span class="o">.</span><span class="n">crt</span>
<span class="n">tls</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span> <span class="n">private</span><span class="o">.</span><span class="n">pem</span>
<span class="n">tls</span><span class="o">-</span><span class="n">cluster</span> <span class="n">yes</span>
<span class="n">appendonly</span> <span class="n">no</span>
<span class="n">save</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing redis-server-3/redis.conf
</pre></div>
</div>
</div>
</div>
<p><strong>Step 3: Form Redis cluster</strong></p>
<p><em>WARNING: The following command will shutdown any processes called <code class="docutils literal notranslate"><span class="pre">redis-cluster</span></code> in the current system!</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Shutdown existing cluster (if any).
!pkill redis-server

# Reset configuration and start 3 Redis servers.
!cd redis-server-1 &amp;&amp; rm -f nodes.conf &amp;&amp; ./redis-server redis.conf
!cd redis-server-2 &amp;&amp; rm -f nodes.conf &amp;&amp; ./redis-server redis.conf
!cd redis-server-3 &amp;&amp; rm -f nodes.conf &amp;&amp; ./redis-server redis.conf

# Form the cluster.
!redis/src/redis-cli \
    --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
    --cluster-yes \
    --tls \
    --cacert test_certs/ca.crt \
    --cert test_certs/hugectr.crt \
    --key test_certs/hugectr-private.pem
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">&gt;&gt;&gt; Performing hash slots allocation on 3 nodes...</span>
Master[0] -&gt; Slots 0 - 5460
Master[1] -&gt; Slots 5461 - 10922
Master[2] -&gt; Slots 10923 - 16383
M: fce52c4a357c6ee1f44fa5783b02ece4a4cf4852 127.0.0.1:7000
   slots:[0-5460] (5461 slots) master
M: cdbe1e10eed8fabeecc84cead004967440d3927a 127.0.0.1:7001
   slots:[5461-10922] (5462 slots) master
M: 66682c9272b63ac7373ee0030648279fe3ac73e1 127.0.0.1:7002
   slots:[10923-16383] (5461 slots) master
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Nodes configuration updated</span>
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Assign a different config epoch to each node</span>
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span>
Waiting for the cluster to join
.
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span>
M: fce52c4a357c6ee1f44fa5783b02ece4a4cf4852 127.0.0.1:7000
   slots:[0-5460] (5461 slots) master
M: 66682c9272b63ac7373ee0030648279fe3ac73e1 127.0.0.1:7002
   slots:[10923-16383] (5461 slots) master
M: cdbe1e10eed8fabeecc84cead004967440d3927a 127.0.0.1:7001
   slots:[5461-10922] (5462 slots) master
<span class=" -Color -Color-Bold -Color-Bold-Green">[OK] All nodes agree about slots configuration.</span>
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Check for open slots...</span>
<span class=" -Color -Color-Bold">&gt;&gt;&gt; Check slots coverage...</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">[OK] All 16384 slots covered.</span>

</pre></div>
</div>
</div>
</div>
<p><strong>Step 4: Run HugeCTR</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="nn">ort</span>
<span class="kn">from</span> <span class="nn">hugectr</span> <span class="kn">import</span> <span class="n">DatabaseType_t</span>
<span class="kn">from</span> <span class="nn">hugectr.inference</span> <span class="kn">import</span> <span class="n">HPS</span><span class="p">,</span> <span class="n">ParameterServerConfig</span><span class="p">,</span> <span class="n">InferenceParams</span><span class="p">,</span> <span class="n">VolatileDatabaseParams</span>

<span class="n">slot_size_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="n">key_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">slot_size_array</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Launching...&#39;</span><span class="p">)</span>

<span class="c1"># 1. Configure the HPS hyperparameters.</span>
<span class="n">ps_config</span> <span class="o">=</span> <span class="n">ParameterServerConfig</span><span class="p">(</span>
       <span class="n">emb_table_name</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hps_demo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sparse_embedding1&#39;</span><span class="p">,</span> <span class="s1">&#39;sparse_embedding2&#39;</span><span class="p">]},</span>
       <span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hps_demo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">]},</span>
       <span class="n">max_feature_num_per_sample_per_emb_table</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hps_demo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]},</span>
       <span class="n">inference_params_array</span> <span class="o">=</span> <span class="p">[</span>
          <span class="n">InferenceParams</span><span class="p">(</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;hps_demo&#39;</span><span class="p">,</span>
            <span class="n">max_batchsize</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">hit_rate_threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">dense_model_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">sparse_model_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hps_demo0_sparse_1000.model&#39;</span><span class="p">,</span> <span class="s1">&#39;hps_demo1_sparse_1000.model&#39;</span><span class="p">],</span>
            <span class="n">deployed_devices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">use_gpu_embedding_cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">cache_size_percentage</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
       <span class="p">],</span>
       <span class="n">volatile_db</span> <span class="o">=</span> <span class="n">VolatileDatabaseParams</span><span class="p">(</span>
            <span class="n">DatabaseType_t</span><span class="o">.</span><span class="n">redis_cluster</span><span class="p">,</span>
            <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1:7000&#39;</span><span class="p">,</span>
            <span class="n">num_partitions</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
            <span class="n">num_node_connections</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">enable_tls</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">tls_ca_certificate</span> <span class="o">=</span> <span class="s1">&#39;test_certs/ca.crt&#39;</span><span class="p">,</span>
            <span class="n">tls_client_certificate</span> <span class="o">=</span> <span class="s1">&#39;test_certs/hugectr.crt&#39;</span><span class="p">,</span>
            <span class="n">tls_client_key</span> <span class="o">=</span> <span class="s1">&#39;test_certs/hugectr-private.pem&#39;</span><span class="p">,</span>
            <span class="n">tls_server_name_identification</span> <span class="o">=</span> <span class="s1">&#39;redis.localhost&#39;</span><span class="p">,</span>
       <span class="p">))</span>

<span class="c1"># 2. Initialize the HPS object.</span>
<span class="n">hps</span> <span class="o">=</span> <span class="n">HPS</span><span class="p">(</span><span class="n">ps_config</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;HPS initialized&#39;</span><span class="p">)</span>

<span class="c1"># 3. Load query data.</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s1">&#39;data_parquet/val/gen_0.parquet&#39;</span><span class="p">)</span>
<span class="n">dense_input_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
<span class="n">cat_input1_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
<span class="n">cat_input2_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span>
<span class="n">dense_input</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dense_input_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">cat_input1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat_input1_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">cat_input2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat_input2_columns</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># 4. Make inference from the HPS object and the ONNX inference session of `hps_demo_without_embedding.onnx`.</span>
<span class="n">embedding1</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s1">&#39;hps_demo&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">embedding2</span> <span class="o">=</span> <span class="n">hps</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">cat_input2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s1">&#39;hps_demo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="s1">&#39;hps_demo_without_embedding.onnx&#39;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">sess</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
               <span class="n">input_feed</span><span class="o">=</span><span class="p">{</span><span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dense_input</span><span class="p">,</span>
               <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">embedding1</span><span class="p">,</span>
               <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">embedding2</span><span class="p">})</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># 5. Check the correctness by comparing with dumped evaluation results.</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;hps_demo_pred_1000&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                         HPS demo without embedding                            &#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ground truth: </span><span class="si">{</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">ground_truth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prediction without embedding: </span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">-</span> <span class="n">ground_truth</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE between prediction and ground_truth: </span><span class="si">{</span><span class="n">mse</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 6. Make inference with the ONNX inference session of `hps_demo_with_embedding.onnx` (double check).</span>
<span class="n">sess_ref</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="s1">&#39;hps_demo_with_embedding.onnx&#39;</span><span class="p">)</span>
<span class="n">res_ref</span> <span class="o">=</span> <span class="n">sess_ref</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">sess_ref</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
               <span class="n">input_feed</span><span class="o">=</span><span class="p">{</span><span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dense_input</span><span class="p">,</span>
               <span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cat_input1</span><span class="p">,</span>
               <span class="n">sess_ref</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cat_input2</span><span class="p">})</span>
<span class="n">pred_ref</span> <span class="o">=</span> <span class="n">res_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                           HPS demo with embedding                             &#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ground truth: </span><span class="si">{</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">ground_truth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prediction with embedding: </span><span class="si">{</span><span class="n">pred_ref</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">pred_ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">diff_ref</span> <span class="o">=</span> <span class="n">pred_ref</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">ground_truth</span>
<span class="n">mse_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_ref</span> <span class="o">*</span> <span class="n">diff_ref</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE between prediction and ground_truth: </span><span class="si">{</span><span class="n">mse_ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Launching...
[HCTR][14:30:37.659][WARNING][RK0][main]: default_value_for_each_table.size() is not equal to the number of embedding tables
HPS initialized
====================================================HPS Create====================================================
[HCTR][14:30:37.660][INFO][RK0][main]: Creating RedisCluster backend...
[HCTR][14:30:37.661][INFO][RK0][main]: RedisCluster: Connecting via 127.0.0.1:7000...
[HCTR][14:30:37.688][INFO][RK0][main]: Volatile DB: initial cache rate = 1
[HCTR][14:30:37.688][INFO][RK0][main]: Volatile DB: cache missed embeddings = 0
[HCTR][14:30:37.688][DEBUG][RK0][main]: Created raw model loader in local memory!
[HCTR][14:30:37.688][INFO][RK0][main]: Using Local file system backend.
[HCTR][14:30:37.850][INFO][RK0][main]: Table: hps_et.hps_demo.sparse_embedding1; cached 18479 / 18479 embeddings in volatile database (RedisCluster); load: 18479 / 18446744073709551615 (0.00%).
[HCTR][14:30:37.850][INFO][RK0][main]: Using Local file system backend.
[HCTR][14:30:37.918][INFO][RK0][main]: Table: hps_et.hps_demo.sparse_embedding2; cached 18466 / 18466 embeddings in volatile database (RedisCluster); load: 18466 / 18446744073709551615 (0.00%).
[HCTR][14:30:37.918][DEBUG][RK0][main]: Real-time subscribers created!
[HCTR][14:30:37.918][INFO][RK0][main]: Creating embedding cache in device 0.
[HCTR][14:30:37.936][INFO][RK0][main]: Model name: hps_demo
[HCTR][14:30:37.936][INFO][RK0][main]: Max batch size: 1024
[HCTR][14:30:37.936][INFO][RK0][main]: Number of embedding tables: 2
[HCTR][14:30:37.936][INFO][RK0][main]: Use GPU embedding cache: True, cache size percentage: 0.500000
[HCTR][14:30:37.936][INFO][RK0][main]: Use static table: False
[HCTR][14:30:37.936][INFO][RK0][main]: Use I64 input key: True
[HCTR][14:30:37.936][INFO][RK0][main]: Configured cache hit rate threshold: 1.000000
[HCTR][14:30:37.936][INFO][RK0][main]: The size of thread pool: 256
[HCTR][14:30:37.936][INFO][RK0][main]: The size of worker memory pool: 2
[HCTR][14:30:37.936][INFO][RK0][main]: The size of refresh memory pool: 1
[HCTR][14:30:37.936][INFO][RK0][main]: The refresh percentage : 0.000000
[HCTR][14:30:37.938][INFO][RK0][main]: Creating lookup session for hps_demo on device: 0
[HCTR][14:30:37.944][INFO][RK0][main]: RedisCluster: Awaiting background worker to conclude...
[HCTR][14:30:37.944][INFO][RK0][main]: RedisCluster: Disconnecting...
-------------------------------------------------------------------------------
                         HPS demo without embedding                            
-------------------------------------------------------------------------------
Ground truth: (1024,) = [0.542481 0.53327  0.5184   ... 0.509011 0.474065 0.535471]
-------------------------------------------------------------------------------
Prediction without embedding: (1024,) = [0.54248124 0.5332703  0.5183997  ... 0.509011   0.4740651  0.53547084]
MSE between prediction and ground_truth: 8.599451821747372e-14
-------------------------------------------------------------------------------
                           HPS demo with embedding                             
-------------------------------------------------------------------------------
Ground truth: (1024,) = [0.542481 0.53327  0.5184   ... 0.509011 0.474065 0.535471]
-------------------------------------------------------------------------------
Prediction with embedding: (1024,) = [0.54248124 0.5332703  0.5183997  ... 0.509011   0.4740651  0.53547084]
MSE between prediction and ground_truth: 8.599451821747372e-14
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-01-18 14:30:37.996529728 [W:onnxruntime:, graph.cc:3559 CleanUnusedInitializersAndNodeArgs] Removing initializer &#39;key_to_indice_hash_all_tables&#39;. It is not used by any node and should be removed from the model.
</pre></div>
</div>
</div>
</div>
<p><strong>Step 5: Shutdown Redis cluster</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pkill<span class="w"> </span>redis-server
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="multi_gpu_offline_inference.html" class="btn btn-neutral float-left" title="Multi-GPU Offline Inference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="training_and_inference_with_remote_filesystem.html" class="btn btn-neutral float-right" title="HugeCTR Training and Inference with Remote File System Example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: main
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../v23.02.00/index.html">v23.02.00</a></dd>
      <dd><a href="../../v4.1/index.html">v4.1</a></dd>
      <dd><a href="../../v4.1.1/index.html">v4.1.1</a></dd>
      <dd><a href="../../v4.2/index.html">v4.2</a></dd>
      <dd><a href="../../v4.3/index.html">v4.3</a></dd>
      <dd><a href="../../v4.3.1/index.html">v4.3.1</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="hps_demo.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NVJ1Y1YJHK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NVJ1Y1YJHK', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>