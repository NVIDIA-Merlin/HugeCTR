{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "924efc61",
   "metadata": {},
   "source": [
    "<img src=\"http://developer.download.nvidia.com/notebooks/dlsw-notebooks/merlin_hugectr_embedding-collection/nvidia_logo.png\" style=\"width: 90px; float: right;\">\n",
    "\n",
    "# HugeCTR Embedding Collection\n",
    "\n",
    "## About this Notebook\n",
    "\n",
    "This notebook demonstrates the following:\n",
    "\n",
    "- Introduces the API of the embedding collection.\n",
    "- Introduces the embedding table placement strategy (ETPS) and how to configure ETPS in embedding collection.\n",
    "- Shows how to use an embedding collection in a DLRM model with the Criteo dataset for training and evaluation.\n",
    "  The notebook shows two different ETPS as reference.\n",
    "\n",
    "## Concepts and API Reference\n",
    "\n",
    "The following key classes and configuration file are used in this notebook:\n",
    "\n",
    "- `hugectr.EmbeddingTableConfig`\n",
    "- `hugectr.EmbeddingPlanner`\n",
    "- JSON plan file for the ETPS\n",
    "\n",
    "For the concepts and API reference information about the classes and file, see the [Overview of Using the HugeCTR Embedding Collection](https://nvidia-merlin.github.io/HugeCTR/master/api/hugectr_layer_book.html#overview-of-using-the-hugectr-embedding-collection) in the HugeCTR Layer Classes and Methods information."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "234a8a29",
   "metadata": {},
   "source": [
    "## Use an Embedding Collection with a DLRM Model\n",
    "\n",
    "### Prepare the Data\n",
    "\n",
    "Follow the instructions under heading \"Preprocess the Dataset through NVTabular\" from the README in the [samples/deepfm](https://github.com/NVIDIA-Merlin/HugeCTR/tree/master/samples/deepfm) directory of the repository to prepare data.\n",
    "\n",
    "### Prepare the Training Script\n",
    "\n",
    "This notebook was developed with on single DGX-1 to run the DLRM model in this notebook. The GPU info in DGX-1 is as follows. It consists of 8 V100-SXM2 GPUs.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "cf29e05b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Thu Jun 23 00:14:56 2022       \n",
      "+-----------------------------------------------------------------------------+\n",
      "| NVIDIA-SMI 460.32.03    Driver Version: 460.32.03    CUDA Version: 11.6     |\n",
      "|-------------------------------+----------------------+----------------------+\n",
      "| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n",
      "| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n",
      "|                               |                      |               MIG M. |\n",
      "|===============================+======================+======================|\n",
      "|   0  Tesla V100-SXM2...  On   | 00000000:06:00.0 Off |                    0 |\n",
      "| N/A   33C    P0    42W / 300W |      0MiB / 16160MiB |      0%      Default |\n",
      "|                               |                      |                  N/A |\n",
      "+-------------------------------+----------------------+----------------------+\n",
      "|   1  Tesla V100-SXM2...  On   | 00000000:07:00.0 Off |                    0 |\n",
      "| N/A   35C    P0    45W / 300W |      0MiB / 16160MiB |      0%      Default |\n",
      "|                               |                      |                  N/A |\n",
      "+-------------------------------+----------------------+----------------------+\n",
      "|   2  Tesla V100-SXM2...  On   | 00000000:0A:00.0 Off |                    0 |\n",
      "| N/A   36C    P0    44W / 300W |      0MiB / 16160MiB |      0%      Default |\n",
      "|                               |                      |                  N/A |\n",
      "+-------------------------------+----------------------+----------------------+\n",
      "|   3  Tesla V100-SXM2...  On   | 00000000:0B:00.0 Off |                    0 |\n",
      "| N/A   33C    P0    42W / 300W |      0MiB / 16160MiB |      0%      Default |\n",
      "|                               |                      |                  N/A |\n",
      "+-------------------------------+----------------------+----------------------+\n",
      "|   4  Tesla V100-SXM2...  On   | 00000000:85:00.0 Off |                    0 |\n",
      "| N/A   36C    P0    44W / 300W |      0MiB / 16160MiB |      0%      Default |\n",
      "|                               |                      |                  N/A |\n",
      "+-------------------------------+----------------------+----------------------+\n",
      "|   5  Tesla V100-SXM2...  On   | 00000000:86:00.0 Off |                    0 |\n",
      "| N/A   35C    P0    42W / 300W |      0MiB / 16160MiB |      0%      Default |\n",
      "|                               |                      |                  N/A |\n",
      "+-------------------------------+----------------------+----------------------+\n",
      "|   6  Tesla V100-SXM2...  On   | 00000000:89:00.0 Off |                    0 |\n",
      "| N/A   36C    P0    44W / 300W |      0MiB / 16160MiB |      0%      Default |\n",
      "|                               |                      |                  N/A |\n",
      "+-------------------------------+----------------------+----------------------+\n",
      "|   7  Tesla V100-SXM2...  On   | 00000000:8A:00.0 Off |                    0 |\n",
      "| N/A   34C    P0    41W / 300W |      0MiB / 16160MiB |      0%      Default |\n",
      "|                               |                      |                  N/A |\n",
      "+-------------------------------+----------------------+----------------------+\n",
      "                                                                               \n",
      "+-----------------------------------------------------------------------------+\n",
      "| Processes:                                                                  |\n",
      "|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |\n",
      "|        ID   ID                                                   Usage      |\n",
      "|=============================================================================|\n",
      "|  No running processes found                                                 |\n",
      "+-----------------------------------------------------------------------------+\n"
     ]
    }
   ],
   "source": [
    "! nvidia-smi"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "eb0996e7",
   "metadata": {},
   "source": [
    "The training script, `dlrm_train.py`, uses the the embedding collection API.\n",
    "The script accepts one command-line argument that specifies the plan file so we can run the script several times and evaluate different ETPS:\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "b1ddb6af",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Overwriting dlrm_train.py\n"
     ]
    }
   ],
   "source": [
    "%%writefile dlrm_train.py\n",
    "import sys\n",
    "import hugectr\n",
    "\n",
    "plan_file = sys.argv[1]\n",
    "slot_size_array = [203931, 18598, 14092, 7012, 18977, 4, 6385, 1245, 49,\n",
    "                   186213, 71328, 67288, 11, 2168, 7338, 61, 4, 932, 15,\n",
    "                   204515, 141526, 199433, 60919, 9137, 71, 34]\n",
    "\n",
    "solver = hugectr.CreateSolver(\n",
    "    max_eval_batches=70,\n",
    "    batchsize_eval=65536,\n",
    "    batchsize=65536,\n",
    "    lr=0.5,\n",
    "    warmup_steps=300,\n",
    "    vvgpu=[[0, 1, 2, 3, 4, 5, 6, 7]],\n",
    "    repeat_dataset=True,\n",
    "    i64_input_key=True,\n",
    "    metrics_spec={hugectr.MetricsType.AverageLoss: 0.0},\n",
    "    use_embedding_collection=True,\n",
    ")\n",
    "\n",
    "reader = hugectr.DataReaderParams(\n",
    "    data_reader_type=hugectr.DataReaderType_t.Parquet,\n",
    "    source=[\"./deepfm_data_nvt/train/_file_list.txt\"],\n",
    "    eval_source=\"./deepfm_data_nvt/val/_file_list.txt\",\n",
    "    check_type=hugectr.Check_t.Non,\n",
    "    slot_size_array=slot_size_array\n",
    ")\n",
    "\n",
    "optimizer = hugectr.CreateOptimizer(\n",
    "    optimizer_type=hugectr.Optimizer_t.SGD,\n",
    "    update_type=hugectr.Update_t.Local,\n",
    "    atomic_update=True\n",
    ")\n",
    "\n",
    "model = hugectr.Model(solver, reader, optimizer)\n",
    "\n",
    "model.add(\n",
    "    hugectr.Input(\n",
    "        label_dim=1,\n",
    "        label_name=\"label\",\n",
    "        dense_dim=13,\n",
    "        dense_name=\"dense\",\n",
    "        data_reader_sparse_param_array=[\n",
    "            hugectr.DataReaderSparseParam(\"data{}\".format(i), 1, False, 1)\n",
    "            for i in range(len(slot_size_array))\n",
    "        ],\n",
    "    )\n",
    ")\n",
    "\n",
    "# Create the embedding table.\n",
    "embedding_table_list = []\n",
    "for i in range(len(slot_size_array)):\n",
    "    embedding_table_list.append(\n",
    "        hugectr.EmbeddingTableConfig(\n",
    "            table_id=i,\n",
    "            max_vocabulary_size=slot_size_array[i],\n",
    "            ev_size=128,\n",
    "            min_key=0,\n",
    "            max_key=slot_size_array[i],\n",
    "        )\n",
    "    )\n",
    "\n",
    "# Create the embedding planner and embedding collection.\n",
    "embedding_planner = hugectr.EmbeddingPlanner()\n",
    "emb_vec_list = []\n",
    "for i in range(len(slot_size_array)):\n",
    "    embedding_planner.embedding_lookup(\n",
    "        table_config=embedding_table_list[i],\n",
    "        bottom_name=\"data{}\".format(i),\n",
    "        top_name=\"emb_vec{}\".format(i),\n",
    "        combiner=\"sum\"\n",
    "    )\n",
    "\n",
    "embedding_collection = embedding_planner.create_embedding_collection(plan_file)\n",
    "\n",
    "model.add(embedding_collection)\n",
    "# need concat\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.Concat,\n",
    "        bottom_names=[\"emb_vec{}\".format(i) for i in range(len(slot_size_array))],\n",
    "        top_names=[\"sparse_embedding1\"],\n",
    "        axis=1\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.InnerProduct,\n",
    "        bottom_names=[\"dense\"],\n",
    "        top_names=[\"fc1\"],\n",
    "        num_output=512\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.ReLU, bottom_names=[\"fc1\"], top_names=[\"relu1\"]\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.InnerProduct,\n",
    "        bottom_names=[\"relu1\"],\n",
    "        top_names=[\"fc2\"],\n",
    "        num_output=256\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.ReLU, bottom_names=[\"fc2\"], top_names=[\"relu2\"]\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.InnerProduct,\n",
    "        bottom_names=[\"relu2\"],\n",
    "        top_names=[\"fc3\"],\n",
    "        num_output=128\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.ReLU, bottom_names=[\"fc3\"], top_names=[\"relu3\"]\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.Interaction,  # interaction only support 3-D input\n",
    "        bottom_names=[\"relu3\", \"sparse_embedding1\"],\n",
    "        top_names=[\"interaction1\"],\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.InnerProduct,\n",
    "        bottom_names=[\"interaction1\"],\n",
    "        top_names=[\"fc4\"],\n",
    "        num_output=1024,\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.ReLU, bottom_names=[\"fc4\"], top_names=[\"relu4\"]\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.InnerProduct,\n",
    "        bottom_names=[\"relu4\"],\n",
    "        top_names=[\"fc5\"],\n",
    "        num_output=1024,\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.ReLU, bottom_names=[\"fc5\"], top_names=[\"relu5\"]\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.InnerProduct,\n",
    "        bottom_names=[\"relu5\"],\n",
    "        top_names=[\"fc6\"],\n",
    "        num_output=512,\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.ReLU, bottom_names=[\"fc6\"], top_names=[\"relu6\"]\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.InnerProduct,\n",
    "        bottom_names=[\"relu6\"],\n",
    "        top_names=[\"fc7\"],\n",
    "        num_output=256,\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.ReLU, bottom_names=[\"fc7\"], top_names=[\"relu7\"]\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.InnerProduct,\n",
    "        bottom_names=[\"relu7\"],\n",
    "        top_names=[\"fc8\"],\n",
    "        num_output=1,\n",
    "    )\n",
    ")\n",
    "\n",
    "model.add(\n",
    "    hugectr.DenseLayer(\n",
    "        layer_type=hugectr.Layer_t.BinaryCrossEntropyLoss,\n",
    "        bottom_names=[\"fc8\", \"label\"],\n",
    "        top_names=[\"loss\"],\n",
    "    )\n",
    ")\n",
    "\n",
    "model.compile()\n",
    "model.summary()\n",
    "model.fit(\n",
    "    max_iter=1000,\n",
    "    display=100,\n",
    "    eval_interval=100,\n",
    "    snapshot=10000000,\n",
    "    snapshot_prefix=\"dlrm\",\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "de0d6f22",
   "metadata": {},
   "source": [
    "### Embedding Table Placement Strategy: Data Parallel and Model Parallel\n",
    "\n",
    "The following `generate_plan()` function shows how to configure small tables as data parallel and use model parallel for larger tables.\n",
    "Each table is on single GPU and different GPU will hold different table&mdash;the same way we work with data in `hugectr.LocalizedHashEmbedding`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "5f53e0a5",
   "metadata": {},
   "outputs": [],
   "source": [
    "def print_plan(plan):\n",
    "    for id, single_gpu_plan in enumerate(plan):\n",
    "        print(\"single_gpu_plan index = {}\".format(id))\n",
    "        for plan_attr in single_gpu_plan:\n",
    "            for key in plan_attr:\n",
    "                if key != \"global_embedding_list\":\n",
    "                    print(\"\\t{}:{}\".format(key, plan_attr[key]))\n",
    "                else:\n",
    "                    prefix_len = len(key)\n",
    "                    left_space_fill = \" \" * prefix_len\n",
    "                    print(\"\\t{}:{}\".format(key, plan_attr[key][0]))\n",
    "                    for index in range(1, len(plan_attr[key])):\n",
    "                        print(\"\\t{}:{}\".format(left_space_fill, plan_attr[key][index]))\n",
    "\n",
    "\n",
    "def generate_plan(slot_size_array, gpu_count, plan_file):\n",
    "\n",
    "    mp_table = [i for i in range(len(slot_size_array)) if slot_size_array[i] > 6000]\n",
    "    dp_table = [i for i in range(len(slot_size_array)) if slot_size_array[i] <= 6000]\n",
    "\n",
    "    # Place the table across all GPUs.\n",
    "    plan = []\n",
    "    for gpu_id in range(gpu_count):\n",
    "        single_gpu_plan = []\n",
    "        mp_plan = {\n",
    "            \"local_embedding_list\": [\n",
    "                table_id\n",
    "                for i, table_id in enumerate(mp_table)\n",
    "                if i % gpu_count == gpu_id\n",
    "            ],\n",
    "            \"table_placement_strategy\": \"mp\",\n",
    "        }\n",
    "        dp_plan = {\"local_embedding_list\": dp_table, \"table_placement_strategy\": \"dp\"}\n",
    "        single_gpu_plan.append(mp_plan)\n",
    "        single_gpu_plan.append(dp_plan)\n",
    "        plan.append(single_gpu_plan)\n",
    "\n",
    "    # Generate the global view of table placement.\n",
    "    mp_global_embedding_list = []\n",
    "    dp_global_embedding_list = []\n",
    "    for single_gpu_plan in plan:\n",
    "        mp_global_embedding_list.append(single_gpu_plan[0][\"local_embedding_list\"])\n",
    "        dp_global_embedding_list.append(single_gpu_plan[1][\"local_embedding_list\"])\n",
    "    for single_gpu_plan in plan:\n",
    "        single_gpu_plan[0][\"global_embedding_list\"] = mp_global_embedding_list\n",
    "        single_gpu_plan[1][\"global_embedding_list\"] = dp_global_embedding_list\n",
    "    print_plan(plan)\n",
    "\n",
    "    # Write the plan file to disk.\n",
    "    import json\n",
    "    with open(plan_file, \"w\") as f:\n",
    "        json.dump(plan, f, indent=4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "8bec0981",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "single_gpu_plan index = 0\n",
      "\tlocal_embedding_list:[0, 11]\n",
      "\ttable_placement_strategy:mp\n",
      "\tglobal_embedding_list:[0, 11]\n",
      "\t                     :[1, 14]\n",
      "\t                     :[2, 19]\n",
      "\t                     :[3, 20]\n",
      "\t                     :[4, 21]\n",
      "\t                     :[6, 22]\n",
      "\t                     :[9, 23]\n",
      "\t                     :[10]\n",
      "\tlocal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\ttable_placement_strategy:dp\n",
      "\tglobal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "single_gpu_plan index = 1\n",
      "\tlocal_embedding_list:[1, 14]\n",
      "\ttable_placement_strategy:mp\n",
      "\tglobal_embedding_list:[0, 11]\n",
      "\t                     :[1, 14]\n",
      "\t                     :[2, 19]\n",
      "\t                     :[3, 20]\n",
      "\t                     :[4, 21]\n",
      "\t                     :[6, 22]\n",
      "\t                     :[9, 23]\n",
      "\t                     :[10]\n",
      "\tlocal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\ttable_placement_strategy:dp\n",
      "\tglobal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "single_gpu_plan index = 2\n",
      "\tlocal_embedding_list:[2, 19]\n",
      "\ttable_placement_strategy:mp\n",
      "\tglobal_embedding_list:[0, 11]\n",
      "\t                     :[1, 14]\n",
      "\t                     :[2, 19]\n",
      "\t                     :[3, 20]\n",
      "\t                     :[4, 21]\n",
      "\t                     :[6, 22]\n",
      "\t                     :[9, 23]\n",
      "\t                     :[10]\n",
      "\tlocal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\ttable_placement_strategy:dp\n",
      "\tglobal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "single_gpu_plan index = 3\n",
      "\tlocal_embedding_list:[3, 20]\n",
      "\ttable_placement_strategy:mp\n",
      "\tglobal_embedding_list:[0, 11]\n",
      "\t                     :[1, 14]\n",
      "\t                     :[2, 19]\n",
      "\t                     :[3, 20]\n",
      "\t                     :[4, 21]\n",
      "\t                     :[6, 22]\n",
      "\t                     :[9, 23]\n",
      "\t                     :[10]\n",
      "\tlocal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\ttable_placement_strategy:dp\n",
      "\tglobal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "single_gpu_plan index = 4\n",
      "\tlocal_embedding_list:[4, 21]\n",
      "\ttable_placement_strategy:mp\n",
      "\tglobal_embedding_list:[0, 11]\n",
      "\t                     :[1, 14]\n",
      "\t                     :[2, 19]\n",
      "\t                     :[3, 20]\n",
      "\t                     :[4, 21]\n",
      "\t                     :[6, 22]\n",
      "\t                     :[9, 23]\n",
      "\t                     :[10]\n",
      "\tlocal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\ttable_placement_strategy:dp\n",
      "\tglobal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "single_gpu_plan index = 5\n",
      "\tlocal_embedding_list:[6, 22]\n",
      "\ttable_placement_strategy:mp\n",
      "\tglobal_embedding_list:[0, 11]\n",
      "\t                     :[1, 14]\n",
      "\t                     :[2, 19]\n",
      "\t                     :[3, 20]\n",
      "\t                     :[4, 21]\n",
      "\t                     :[6, 22]\n",
      "\t                     :[9, 23]\n",
      "\t                     :[10]\n",
      "\tlocal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\ttable_placement_strategy:dp\n",
      "\tglobal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "single_gpu_plan index = 6\n",
      "\tlocal_embedding_list:[9, 23]\n",
      "\ttable_placement_strategy:mp\n",
      "\tglobal_embedding_list:[0, 11]\n",
      "\t                     :[1, 14]\n",
      "\t                     :[2, 19]\n",
      "\t                     :[3, 20]\n",
      "\t                     :[4, 21]\n",
      "\t                     :[6, 22]\n",
      "\t                     :[9, 23]\n",
      "\t                     :[10]\n",
      "\tlocal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\ttable_placement_strategy:dp\n",
      "\tglobal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "single_gpu_plan index = 7\n",
      "\tlocal_embedding_list:[10]\n",
      "\ttable_placement_strategy:mp\n",
      "\tglobal_embedding_list:[0, 11]\n",
      "\t                     :[1, 14]\n",
      "\t                     :[2, 19]\n",
      "\t                     :[3, 20]\n",
      "\t                     :[4, 21]\n",
      "\t                     :[6, 22]\n",
      "\t                     :[9, 23]\n",
      "\t                     :[10]\n",
      "\tlocal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\ttable_placement_strategy:dp\n",
      "\tglobal_embedding_list:[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n",
      "\t                     :[5, 7, 8, 12, 13, 15, 16, 17, 18, 24, 25]\n"
     ]
    }
   ],
   "source": [
    "slot_size_array = [\n",
    "    203931,\n",
    "    18598,\n",
    "    14092,\n",
    "    7012,\n",
    "    18977,\n",
    "    4,\n",
    "    6385,\n",
    "    1245,\n",
    "    49,\n",
    "    186213,\n",
    "    71328,\n",
    "    67288,\n",
    "    11,\n",
    "    2168,\n",
    "    7338,\n",
    "    61,\n",
    "    4,\n",
    "    932,\n",
    "    15,\n",
    "    204515,\n",
    "    141526,\n",
    "    199433,\n",
    "    60919,\n",
    "    9137,\n",
    "    71,\n",
    "    34,\n",
    "]\n",
    "\n",
    "generate_plan(\n",
    "    slot_size_array=slot_size_array,\n",
    "    gpu_count=8,\n",
    "    plan_file=\"./dp_and_localized_plan.json\",\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "24015e15",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "HugeCTR Version: 3.7\n",
      "====================================================Model Init=====================================================\n",
      "[HCTR][08:41:17.942][WARNING][RK0][main]: The model name is not specified when creating the solver.\n",
      "[HCTR][08:41:17.942][INFO][RK0][main]: Global seed is 1323844045\n",
      "[HCTR][08:41:18.400][INFO][RK0][main]: Device to NUMA mapping:\n",
      "  GPU 0 ->  node 0\n",
      "  GPU 1 ->  node 0\n",
      "  GPU 2 ->  node 0\n",
      "  GPU 3 ->  node 0\n",
      "  GPU 4 ->  node 1\n",
      "  GPU 5 ->  node 1\n",
      "  GPU 6 ->  node 1\n",
      "  GPU 7 ->  node 1\n",
      "[HCTR][08:41:29.902][WARNING][RK0][main]: Peer-to-peer access cannot be fully enabled.\n",
      "[HCTR][08:41:29.903][INFO][RK0][main]: Start all2all warmup\n",
      "[HCTR][08:41:30.083][INFO][RK0][main]: End all2all warmup\n",
      "[HCTR][08:41:30.095][INFO][RK0][main]: Using All-reduce algorithm: NCCL\n",
      "[HCTR][08:41:30.097][INFO][RK0][main]: Device 0: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:41:30.097][INFO][RK0][main]: Device 1: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:41:30.098][INFO][RK0][main]: Device 2: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:41:30.099][INFO][RK0][main]: Device 3: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:41:30.100][INFO][RK0][main]: Device 4: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:41:30.100][INFO][RK0][main]: Device 5: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:41:30.101][INFO][RK0][main]: Device 6: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:41:30.102][INFO][RK0][main]: Device 7: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:41:30.103][INFO][RK0][main]: num of DataReader workers: 8\n",
      "[HCTR][08:41:30.133][DEBUG][RK0][tid #140397011531520]: file_name_ deepfm_data_nvt/train/1.c7b6f2423fec47ff97a09ec95f6346f9.parquet file_total_rows_ 4585117\n",
      "[HCTR][08:41:30.133][DEBUG][RK0][tid #140397774890752]: file_name_ deepfm_data_nvt/train/5.c5b89db1e82d4842998d560796eab838.parquet file_total_rows_ 4583901\n",
      "[HCTR][08:41:30.140][DEBUG][RK0][tid #140397783283456]: file_name_ deepfm_data_nvt/train/4.4f7e95ed8f9b4bcc9b63c5f3278e6905.parquet file_total_rows_ 4580476\n",
      "[HCTR][08:41:30.140][DEBUG][RK0][tid #140394788546304]: file_name_ deepfm_data_nvt/train/6.92133f3ee3664684854969202958122f.parquet file_total_rows_ 4581782\n",
      "[HCTR][08:41:30.140][DEBUG][RK0][tid #140406197053184]: file_name_ deepfm_data_nvt/train/2.6b134d3f8f0a4f0d9453f1d7c08f74d5.parquet file_total_rows_ 4584304\n",
      "[HCTR][08:41:30.140][DEBUG][RK0][tid #140397829383936]: file_name_ deepfm_data_nvt/train/3.4b192542e2ad4cc8b745feb142d1878a.parquet file_total_rows_ 4581022\n",
      "[HCTR][08:41:30.140][DEBUG][RK0][tid #140394780153600]: file_name_ deepfm_data_nvt/train/7.9345ade3421b40a5803f518c48ae436f.parquet file_total_rows_ 4589169\n",
      "[HCTR][08:41:30.141][DEBUG][RK0][tid #140397003138816]: file_name_ deepfm_data_nvt/train/0.1738817c5c5c47dba75a428d0837cbc3.parquet file_total_rows_ 4586722\n",
      "[HCTR][08:41:30.155][INFO][RK0][main]: Vocabulary size: 1221286\n",
      "[HCTR][08:41:30.156][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:41:30.156][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:41:30.156][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:41:30.156][DEBUG][RK0][tid #140394528503552]: [HCTR][08:41:30.156][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:41:30.156][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:41:30.174][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:41:30.179][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:41:30.767][INFO][RK0][main]: Graph analysis to resolve tensor dependency\n",
      "===================================================Model Compile===================================================\n",
      "===================================================Model Summary===================================================\n",
      "[HCTR][08:42:08.060][INFO][RK0][main]: label                                   Dense                         Sparse                        \n",
      "label                                   dense                          data0,data1,data2,data3,data4,data5,data6,data7,data8,data9,data10,data11,data12,data13,data14,data15,data16,data17,data18,data19,data20,data21,data22,data23,data24,data25\n",
      "(None, 1)                               (None, 13)                              \n",
      "——————————————————————————————————————————————————————————————————————————————————————————————————————————————————\n",
      "Layer Type                              Input Name                    Output Name                   Output Shape                  \n",
      "——————————————————————————————————————————————————————————————————————————————————————————————————————————————————\n",
      "EmbeddingCollection                     data0                         emb_vec0                      (None, 1, 128)                \n",
      "                                        data1                         emb_vec1                      (None, 1, 128)                \n",
      "                                        data2                         emb_vec2                      (None, 1, 128)                \n",
      "                                        data3                         emb_vec3                      (None, 1, 128)                \n",
      "                                        data4                         emb_vec4                      (None, 1, 128)                \n",
      "                                        data5                         emb_vec5                      (None, 1, 128)                \n",
      "                                        data6                         emb_vec6                      (None, 1, 128)                \n",
      "                                        data7                         emb_vec7                      (None, 1, 128)                \n",
      "                                        data8                         emb_vec8                      (None, 1, 128)                \n",
      "                                        data9                         emb_vec9                      (None, 1, 128)                \n",
      "                                        data10                        emb_vec10                     (None, 1, 128)                \n",
      "                                        data11                        emb_vec11                     (None, 1, 128)                \n",
      "                                        data12                        emb_vec12                     (None, 1, 128)                \n",
      "                                        data13                        emb_vec13                     (None, 1, 128)                \n",
      "                                        data14                        emb_vec14                     (None, 1, 128)                \n",
      "                                        data15                        emb_vec15                     (None, 1, 128)                \n",
      "                                        data16                        emb_vec16                     (None, 1, 128)                \n",
      "                                        data17                        emb_vec17                     (None, 1, 128)                \n",
      "                                        data18                        emb_vec18                     (None, 1, 128)                \n",
      "                                        data19                        emb_vec19                     (None, 1, 128)                \n",
      "                                        data20                        emb_vec20                     (None, 1, 128)                \n",
      "                                        data21                        emb_vec21                     (None, 1, 128)                \n",
      "                                        data22                        emb_vec22                     (None, 1, 128)                \n",
      "                                        data23                        emb_vec23                     (None, 1, 128)                \n",
      "                                        data24                        emb_vec24                     (None, 1, 128)                \n",
      "                                        data25                        emb_vec25                     (None, 1, 128)                \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "Concat                                  emb_vec0                      sparse_embedding1             (None, 26, 128)               \n",
      "                                        emb_vec1                                                                                  \n",
      "                                        emb_vec2                                                                                  \n",
      "                                        emb_vec3                                                                                  \n",
      "                                        emb_vec4                                                                                  \n",
      "                                        emb_vec5                                                                                  \n",
      "                                        emb_vec6                                                                                  \n",
      "                                        emb_vec7                                                                                  \n",
      "                                        emb_vec8                                                                                  \n",
      "                                        emb_vec9                                                                                  \n",
      "                                        emb_vec10                                                                                 \n",
      "                                        emb_vec11                                                                                 \n",
      "                                        emb_vec12                                                                                 \n",
      "                                        emb_vec13                                                                                 \n",
      "                                        emb_vec14                                                                                 \n",
      "                                        emb_vec15                                                                                 \n",
      "                                        emb_vec16                                                                                 \n",
      "                                        emb_vec17                                                                                 \n",
      "                                        emb_vec18                                                                                 \n",
      "                                        emb_vec19                                                                                 \n",
      "                                        emb_vec20                                                                                 \n",
      "                                        emb_vec21                                                                                 \n",
      "                                        emb_vec22                                                                                 \n",
      "                                        emb_vec23                                                                                 \n",
      "                                        emb_vec24                                                                                 \n",
      "                                        emb_vec25                                                                                 \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            dense                         fc1                           (None, 512)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc1                           relu1                         (None, 512)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu1                         fc2                           (None, 256)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc2                           relu2                         (None, 256)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu2                         fc3                           (None, 128)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc3                           relu3                         (None, 128)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "Interaction                             relu3                         interaction1                  (None, 480)                   \n",
      "                                        sparse_embedding1                                                                         \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            interaction1                  fc4                           (None, 1024)                  \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc4                           relu4                         (None, 1024)                  \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu4                         fc5                           (None, 1024)                  \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc5                           relu5                         (None, 1024)                  \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu5                         fc6                           (None, 512)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc6                           relu6                         (None, 512)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu6                         fc7                           (None, 256)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc7                           relu7                         (None, 256)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu7                         fc8                           (None, 1)                     \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "BinaryCrossEntropyLoss                  fc8                           loss                                                        \n",
      "                                        label                                                                                     \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "=====================================================Model Fit=====================================================\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: Use non-epoch mode with number of iterations: 1000\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: Training batchsize: 65536, evaluation batchsize: 65536\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: Evaluation interval: 100, snapshot interval: 10000000\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: Dense network trainable: True\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: Use mixed precision: False, scaler: 1.000000, use cuda graph: True\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: lr: 0.500000, warmup_steps: 300, end_lr: 0.000000\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: decay_start: 0, decay_steps: 1, decay_power: 2.000000\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: Training source file: ./deepfm_data_nvt/train/_file_list.txt\n",
      "[HCTR][08:42:08.061][INFO][RK0][main]: Evaluation source file: ./deepfm_data_nvt/val/_file_list.txt\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[HCTR][08:42:16.322][INFO][RK0][main]: Iter: 100 Time(100 iters): 8.19237s Loss: 0.140113 lr:0.168333\n",
      "[HCTR][08:42:18.453][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:42:18.491][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:42:18.534][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:42:18.572][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:42:18.610][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:42:18.651][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:42:18.684][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:42:18.720][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:42:18.957][INFO][RK0][main]: Evaluation, AverageLoss: 0.141261\n",
      "[HCTR][08:42:18.957][INFO][RK0][main]: Eval Time for 70 iters: 2.63429s\n",
      "[HCTR][08:42:27.041][INFO][RK0][main]: Iter: 200 Time(100 iters): 10.6496s Loss: 0.142313 lr:0.335\n",
      "[HCTR][08:42:29.077][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:42:29.115][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:42:29.157][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:42:29.195][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:42:29.237][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:42:29.275][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:42:29.312][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:42:29.351][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:42:29.532][INFO][RK0][main]: Evaluation, AverageLoss: 0.141891\n",
      "[HCTR][08:42:29.532][INFO][RK0][main]: Eval Time for 70 iters: 2.4907s\n",
      "[HCTR][08:42:37.639][INFO][RK0][main]: Iter: 300 Time(100 iters): 10.5395s Loss: 0.154403 lr:0.5\n",
      "[HCTR][08:42:39.748][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:42:39.785][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:42:39.824][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:42:39.862][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:42:39.905][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:42:39.952][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:42:39.987][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:42:40.021][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:42:40.125][INFO][RK0][main]: Evaluation, AverageLoss: 0.147726\n",
      "[HCTR][08:42:40.125][INFO][RK0][main]: Eval Time for 70 iters: 2.48534s\n",
      "[HCTR][08:42:48.262][INFO][RK0][main]: Iter: 400 Time(100 iters): 10.5647s Loss: 0.141461 lr:0.5\n",
      "[HCTR][08:42:50.199][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:42:50.274][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:42:50.311][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:42:50.462][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:42:50.533][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:42:50.638][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:42:50.675][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:42:50.714][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:42:50.788][INFO][RK0][main]: Evaluation, AverageLoss: 0.140187\n",
      "[HCTR][08:42:50.788][INFO][RK0][main]: Eval Time for 70 iters: 2.52533s\n",
      "[HCTR][08:42:58.948][INFO][RK0][main]: Iter: 500 Time(100 iters): 10.605s Loss: 0.142035 lr:0.5\n",
      "[HCTR][08:43:00.914][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:43:00.951][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:43:00.990][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:43:01.023][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:43:01.057][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:43:01.094][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:43:01.127][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:43:01.163][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:43:01.403][INFO][RK0][main]: Evaluation, AverageLoss: 0.140354\n",
      "[HCTR][08:43:01.403][INFO][RK0][main]: Eval Time for 70 iters: 2.45442s\n",
      "[HCTR][08:43:04.871][DEBUG][RK0][tid #140397003138816]: file_name_ deepfm_data_nvt/train/0.1738817c5c5c47dba75a428d0837cbc3.parquet file_total_rows_ 4586722\n",
      "[HCTR][08:43:04.951][DEBUG][RK0][tid #140397011531520]: file_name_ deepfm_data_nvt/train/1.c7b6f2423fec47ff97a09ec95f6346f9.parquet file_total_rows_ 4585117\n",
      "[HCTR][08:43:05.031][DEBUG][RK0][tid #140406197053184]: file_name_ deepfm_data_nvt/train/2.6b134d3f8f0a4f0d9453f1d7c08f74d5.parquet file_total_rows_ 4584304\n",
      "[HCTR][08:43:05.111][DEBUG][RK0][tid #140397829383936]: file_name_ deepfm_data_nvt/train/3.4b192542e2ad4cc8b745feb142d1878a.parquet file_total_rows_ 4581022\n",
      "[HCTR][08:43:05.192][DEBUG][RK0][tid #140397783283456]: file_name_ deepfm_data_nvt/train/4.4f7e95ed8f9b4bcc9b63c5f3278e6905.parquet file_total_rows_ 4580476\n",
      "[HCTR][08:43:05.274][DEBUG][RK0][tid #140397774890752]: file_name_ deepfm_data_nvt/train/5.c5b89db1e82d4842998d560796eab838.parquet file_total_rows_ 4583901\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[HCTR][08:43:05.354][DEBUG][RK0][tid #140394788546304]: file_name_ deepfm_data_nvt/train/6.92133f3ee3664684854969202958122f.parquet file_total_rows_ 4581782\n",
      "[HCTR][08:43:06.072][DEBUG][RK0][tid #140394780153600]: file_name_ deepfm_data_nvt/train/7.9345ade3421b40a5803f518c48ae436f.parquet file_total_rows_ 4589169\n",
      "[HCTR][08:43:09.539][INFO][RK0][main]: Iter: 600 Time(100 iters): 10.5255s Loss: 0.140006 lr:0.5\n",
      "[HCTR][08:43:11.577][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:43:11.615][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:43:11.653][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:43:11.690][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:43:11.734][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:43:11.780][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:43:11.813][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:43:11.851][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:43:12.020][INFO][RK0][main]: Evaluation, AverageLoss: 0.141187\n",
      "[HCTR][08:43:12.020][INFO][RK0][main]: Eval Time for 70 iters: 2.4811s\n",
      "[HCTR][08:43:20.138][INFO][RK0][main]: Iter: 700 Time(100 iters): 10.5241s Loss: 0.143169 lr:0.5\n",
      "[HCTR][08:43:22.305][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:43:22.343][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:43:22.382][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:43:22.420][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:43:22.463][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:43:22.507][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:43:22.551][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:43:22.588][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:43:22.694][INFO][RK0][main]: Evaluation, AverageLoss: 0.140917\n",
      "[HCTR][08:43:22.694][INFO][RK0][main]: Eval Time for 70 iters: 2.55575s\n",
      "[HCTR][08:43:30.768][INFO][RK0][main]: Iter: 800 Time(100 iters): 10.5603s Loss: 0.143395 lr:0.5\n",
      "[HCTR][08:43:32.698][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:43:32.771][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:43:32.809][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:43:32.950][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:43:33.023][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:43:33.131][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:43:33.169][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:43:33.212][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:43:33.292][INFO][RK0][main]: Evaluation, AverageLoss: 0.139397\n",
      "[HCTR][08:43:33.292][INFO][RK0][main]: Eval Time for 70 iters: 2.52409s\n",
      "[HCTR][08:43:41.361][INFO][RK0][main]: Iter: 900 Time(100 iters): 10.5237s Loss: 0.141716 lr:0.5\n",
      "[HCTR][08:43:43.361][DEBUG][RK0][tid #140394662721280]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:43:43.399][DEBUG][RK0][tid #140394654328576]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:43:43.436][DEBUG][RK0][tid #140394645935872]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:43:43.474][DEBUG][RK0][tid #140394528503552]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:43:43.518][DEBUG][RK0][tid #140394520110848]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:43:43.555][DEBUG][RK0][tid #140394511718144]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:43:43.589][DEBUG][RK0][tid #140394394285824]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:43:43.626][DEBUG][RK0][tid #140394385893120]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:43:43.867][INFO][RK0][main]: Evaluation, AverageLoss: 0.141604\n",
      "[HCTR][08:43:43.867][INFO][RK0][main]: Eval Time for 70 iters: 2.50584s\n",
      "[HCTR][08:43:51.826][INFO][RK0][main]: Finish 1000 iterations with batchsize: 65536 in 103.76s.\n"
     ]
    }
   ],
   "source": [
    "!python3 dlrm_train.py ./dp_and_localized_plan.json"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "03ddef90",
   "metadata": {},
   "source": [
    "### Embedding Table Placement Strategy: Distributed\n",
    "\n",
    "The `generate_distributed_plan()` function shows how to distribute all tables across all GPUs\n",
    "This strategy is similar to `hugectr.DistributedHashEmbedding`.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "a64116e8",
   "metadata": {},
   "outputs": [],
   "source": [
    "def generate_distributed_plan(slot_size_array, gpu_count, plan_file):\n",
    "    # Place the table across all GPUs.\n",
    "    plan = []\n",
    "    for gpu_id in range(gpu_count):\n",
    "        distributed_plan = {\n",
    "            \"local_embedding_list\": [\n",
    "                table_id for table_id in range(len(slot_size_array))\n",
    "            ],\n",
    "            \"table_placement_strategy\": \"mp\",\n",
    "            \"shard_id\": gpu_id,\n",
    "            \"shards_count\": gpu_count,\n",
    "        }\n",
    "        plan.append([distributed_plan])\n",
    "\n",
    "    # Generate the global view of table placement.\n",
    "    distributed_global_embedding_list = []\n",
    "    for single_gpu_plan in plan:\n",
    "        distributed_global_embedding_list.append(\n",
    "            single_gpu_plan[0][\"local_embedding_list\"]\n",
    "        )\n",
    "    for single_gpu_plan in plan:\n",
    "        single_gpu_plan[0][\"global_embedding_list\"] = distributed_global_embedding_list\n",
    "    print_plan(plan)\n",
    "\n",
    "    # Write the plan file to disk.\n",
    "    import json\n",
    "    with open(plan_file, \"w\") as f:\n",
    "        json.dump(plan, f, indent=4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "f572c884",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "single_gpu_plan index = 0\n",
      "\tlocal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\ttable_placement_strategy:mp\n",
      "\tshard_id:0\n",
      "\tshards_count:8\n",
      "\tglobal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "single_gpu_plan index = 1\n",
      "\tlocal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\ttable_placement_strategy:mp\n",
      "\tshard_id:1\n",
      "\tshards_count:8\n",
      "\tglobal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "single_gpu_plan index = 2\n",
      "\tlocal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\ttable_placement_strategy:mp\n",
      "\tshard_id:2\n",
      "\tshards_count:8\n",
      "\tglobal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "single_gpu_plan index = 3\n",
      "\tlocal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\ttable_placement_strategy:mp\n",
      "\tshard_id:3\n",
      "\tshards_count:8\n",
      "\tglobal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "single_gpu_plan index = 4\n",
      "\tlocal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\ttable_placement_strategy:mp\n",
      "\tshard_id:4\n",
      "\tshards_count:8\n",
      "\tglobal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "single_gpu_plan index = 5\n",
      "\tlocal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\ttable_placement_strategy:mp\n",
      "\tshard_id:5\n",
      "\tshards_count:8\n",
      "\tglobal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "single_gpu_plan index = 6\n",
      "\tlocal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\ttable_placement_strategy:mp\n",
      "\tshard_id:6\n",
      "\tshards_count:8\n",
      "\tglobal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "single_gpu_plan index = 7\n",
      "\tlocal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\ttable_placement_strategy:mp\n",
      "\tshard_id:7\n",
      "\tshards_count:8\n",
      "\tglobal_embedding_list:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n",
      "\t                     :[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]\n"
     ]
    }
   ],
   "source": [
    "slot_size_array = [\n",
    "    203931,\n",
    "    18598,\n",
    "    14092,\n",
    "    7012,\n",
    "    18977,\n",
    "    4,\n",
    "    6385,\n",
    "    1245,\n",
    "    49,\n",
    "    186213,\n",
    "    71328,\n",
    "    67288,\n",
    "    11,\n",
    "    2168,\n",
    "    7338,\n",
    "    61,\n",
    "    4,\n",
    "    932,\n",
    "    15,\n",
    "    204515,\n",
    "    141526,\n",
    "    199433,\n",
    "    60919,\n",
    "    9137,\n",
    "    71,\n",
    "    34,\n",
    "]\n",
    "\n",
    "generate_distributed_plan(\n",
    "    slot_size_array=slot_size_array,\n",
    "    gpu_count=8,\n",
    "    plan_file=\"./distributed_plan.json\"\n",
    ")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "d06fbf0d",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "HugeCTR Version: 3.7\n",
      "====================================================Model Init=====================================================\n",
      "[HCTR][08:44:05.384][WARNING][RK0][main]: The model name is not specified when creating the solver.\n",
      "[HCTR][08:44:05.384][INFO][RK0][main]: Global seed is 1510630763\n",
      "[HCTR][08:44:05.843][INFO][RK0][main]: Device to NUMA mapping:\n",
      "  GPU 0 ->  node 0\n",
      "  GPU 1 ->  node 0\n",
      "  GPU 2 ->  node 0\n",
      "  GPU 3 ->  node 0\n",
      "  GPU 4 ->  node 1\n",
      "  GPU 5 ->  node 1\n",
      "  GPU 6 ->  node 1\n",
      "  GPU 7 ->  node 1\n",
      "[HCTR][08:44:17.340][WARNING][RK0][main]: Peer-to-peer access cannot be fully enabled.\n",
      "[HCTR][08:44:17.341][INFO][RK0][main]: Start all2all warmup\n",
      "[HCTR][08:44:17.532][INFO][RK0][main]: End all2all warmup\n",
      "[HCTR][08:44:17.544][INFO][RK0][main]: Using All-reduce algorithm: NCCL\n",
      "[HCTR][08:44:17.545][INFO][RK0][main]: Device 0: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:44:17.546][INFO][RK0][main]: Device 1: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:44:17.547][INFO][RK0][main]: Device 2: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:44:17.548][INFO][RK0][main]: Device 3: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:44:17.548][INFO][RK0][main]: Device 4: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:44:17.549][INFO][RK0][main]: Device 5: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:44:17.550][INFO][RK0][main]: Device 6: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:44:17.551][INFO][RK0][main]: Device 7: Tesla V100-SXM2-16GB\n",
      "[HCTR][08:44:17.552][INFO][RK0][main]: num of DataReader workers: 8\n",
      "[HCTR][08:44:17.578][DEBUG][RK0][tid #139614253741824]: file_name_ deepfm_data_nvt/train/0.1738817c5c5c47dba75a428d0837cbc3.parquet file_total_rows_ 4586722\n",
      "[HCTR][08:44:17.578][DEBUG][RK0][tid #139614119524096]: file_name_ deepfm_data_nvt/train/6.92133f3ee3664684854969202958122f.parquet file_total_rows_ 4581782\n",
      "[HCTR][08:44:17.579][DEBUG][RK0][tid #139614371174144]: file_name_ deepfm_data_nvt/train/1.c7b6f2423fec47ff97a09ec95f6346f9.parquet file_total_rows_ 4585117\n",
      "[HCTR][08:44:17.579][DEBUG][RK0][tid #139618506761984]: file_name_ deepfm_data_nvt/train/2.6b134d3f8f0a4f0d9453f1d7c08f74d5.parquet file_total_rows_ 4584304\n",
      "[HCTR][08:44:17.579][DEBUG][RK0][tid #139614505387776]: file_name_ deepfm_data_nvt/train/3.4b192542e2ad4cc8b745feb142d1878a.parquet file_total_rows_ 4581022\n",
      "[HCTR][08:44:17.579][DEBUG][RK0][tid #139614387959552]: file_name_ deepfm_data_nvt/train/4.4f7e95ed8f9b4bcc9b63c5f3278e6905.parquet file_total_rows_ 4580476\n",
      "[HCTR][08:44:17.579][DEBUG][RK0][tid #139614111131392]: file_name_ deepfm_data_nvt/train/7.9345ade3421b40a5803f518c48ae436f.parquet file_total_rows_ 4589169\n",
      "[HCTR][08:44:17.583][INFO][RK0][main]: Vocabulary size: 1221286\n",
      "[HCTR][08:44:17.583][DEBUG][RK0][tid #139614379566848]: file_name_ deepfm_data_nvt/train/5.c5b89db1e82d4842998d560796eab838.parquet file_total_rows_ 4583901\n",
      "[HCTR][08:44:17.583][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:44:17.583][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:44:17.583][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:44:17.583][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:44:17.583][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:44:17.583][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:44:17.584][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:44:17.584][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:44:18.246][INFO][RK0][main]: Graph analysis to resolve tensor dependency\n",
      "===================================================Model Compile===================================================\n",
      "===================================================Model Summary===================================================\n",
      "[HCTR][08:44:55.511][INFO][RK0][main]: label                                   Dense                         Sparse                        \n",
      "label                                   dense                          data0,data1,data2,data3,data4,data5,data6,data7,data8,data9,data10,data11,data12,data13,data14,data15,data16,data17,data18,data19,data20,data21,data22,data23,data24,data25\n",
      "(None, 1)                               (None, 13)                              \n",
      "——————————————————————————————————————————————————————————————————————————————————————————————————————————————————\n",
      "Layer Type                              Input Name                    Output Name                   Output Shape                  \n",
      "——————————————————————————————————————————————————————————————————————————————————————————————————————————————————\n",
      "EmbeddingCollection                     data0                         emb_vec0                      (None, 1, 128)                \n",
      "                                        data1                         emb_vec1                      (None, 1, 128)                \n",
      "                                        data2                         emb_vec2                      (None, 1, 128)                \n",
      "                                        data3                         emb_vec3                      (None, 1, 128)                \n",
      "                                        data4                         emb_vec4                      (None, 1, 128)                \n",
      "                                        data5                         emb_vec5                      (None, 1, 128)                \n",
      "                                        data6                         emb_vec6                      (None, 1, 128)                \n",
      "                                        data7                         emb_vec7                      (None, 1, 128)                \n",
      "                                        data8                         emb_vec8                      (None, 1, 128)                \n",
      "                                        data9                         emb_vec9                      (None, 1, 128)                \n",
      "                                        data10                        emb_vec10                     (None, 1, 128)                \n",
      "                                        data11                        emb_vec11                     (None, 1, 128)                \n",
      "                                        data12                        emb_vec12                     (None, 1, 128)                \n",
      "                                        data13                        emb_vec13                     (None, 1, 128)                \n",
      "                                        data14                        emb_vec14                     (None, 1, 128)                \n",
      "                                        data15                        emb_vec15                     (None, 1, 128)                \n",
      "                                        data16                        emb_vec16                     (None, 1, 128)                \n",
      "                                        data17                        emb_vec17                     (None, 1, 128)                \n",
      "                                        data18                        emb_vec18                     (None, 1, 128)                \n",
      "                                        data19                        emb_vec19                     (None, 1, 128)                \n",
      "                                        data20                        emb_vec20                     (None, 1, 128)                \n",
      "                                        data21                        emb_vec21                     (None, 1, 128)                \n",
      "                                        data22                        emb_vec22                     (None, 1, 128)                \n",
      "                                        data23                        emb_vec23                     (None, 1, 128)                \n",
      "                                        data24                        emb_vec24                     (None, 1, 128)                \n",
      "                                        data25                        emb_vec25                     (None, 1, 128)                \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "Concat                                  emb_vec0                      sparse_embedding1             (None, 26, 128)               \n",
      "                                        emb_vec1                                                                                  \n",
      "                                        emb_vec2                                                                                  \n",
      "                                        emb_vec3                                                                                  \n",
      "                                        emb_vec4                                                                                  \n",
      "                                        emb_vec5                                                                                  \n",
      "                                        emb_vec6                                                                                  \n",
      "                                        emb_vec7                                                                                  \n",
      "                                        emb_vec8                                                                                  \n",
      "                                        emb_vec9                                                                                  \n",
      "                                        emb_vec10                                                                                 \n",
      "                                        emb_vec11                                                                                 \n",
      "                                        emb_vec12                                                                                 \n",
      "                                        emb_vec13                                                                                 \n",
      "                                        emb_vec14                                                                                 \n",
      "                                        emb_vec15                                                                                 \n",
      "                                        emb_vec16                                                                                 \n",
      "                                        emb_vec17                                                                                 \n",
      "                                        emb_vec18                                                                                 \n",
      "                                        emb_vec19                                                                                 \n",
      "                                        emb_vec20                                                                                 \n",
      "                                        emb_vec21                                                                                 \n",
      "                                        emb_vec22                                                                                 \n",
      "                                        emb_vec23                                                                                 \n",
      "                                        emb_vec24                                                                                 \n",
      "                                        emb_vec25                                                                                 \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            dense                         fc1                           (None, 512)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc1                           relu1                         (None, 512)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu1                         fc2                           (None, 256)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc2                           relu2                         (None, 256)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu2                         fc3                           (None, 128)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc3                           relu3                         (None, 128)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "Interaction                             relu3                         interaction1                  (None, 480)                   \n",
      "                                        sparse_embedding1                                                                         \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            interaction1                  fc4                           (None, 1024)                  \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc4                           relu4                         (None, 1024)                  \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu4                         fc5                           (None, 1024)                  \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc5                           relu5                         (None, 1024)                  \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu5                         fc6                           (None, 512)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc6                           relu6                         (None, 512)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu6                         fc7                           (None, 256)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "ReLU                                    fc7                           relu7                         (None, 256)                   \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "InnerProduct                            relu7                         fc8                           (None, 1)                     \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "BinaryCrossEntropyLoss                  fc8                           loss                                                        \n",
      "                                        label                                                                                     \n",
      "------------------------------------------------------------------------------------------------------------------\n",
      "=====================================================Model Fit=====================================================\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: Use non-epoch mode with number of iterations: 1000\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: Training batchsize: 65536, evaluation batchsize: 65536\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: Evaluation interval: 100, snapshot interval: 10000000\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: Dense network trainable: True\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: Use mixed precision: False, scaler: 1.000000, use cuda graph: True\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: lr: 0.500000, warmup_steps: 300, end_lr: 0.000000\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: decay_start: 0, decay_steps: 1, decay_power: 2.000000\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: Training source file: ./deepfm_data_nvt/train/_file_list.txt\n",
      "[HCTR][08:44:55.512][INFO][RK0][main]: Evaluation source file: ./deepfm_data_nvt/val/_file_list.txt\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[HCTR][08:45:11.057][INFO][RK0][main]: Iter: 100 Time(100 iters): 15.3926s Loss: 0.144649 lr:0.168333\n",
      "[HCTR][08:45:14.328][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:45:14.386][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:45:14.444][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:45:14.503][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:45:14.562][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:45:14.620][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:45:14.677][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:45:14.736][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:45:15.139][INFO][RK0][main]: Evaluation, AverageLoss: 0.146034\n",
      "[HCTR][08:45:15.139][INFO][RK0][main]: Eval Time for 70 iters: 4.08247s\n",
      "[HCTR][08:45:30.553][INFO][RK0][main]: Iter: 200 Time(100 iters): 19.4961s Loss: 0.149704 lr:0.335\n",
      "[HCTR][08:45:33.943][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:45:34.001][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:45:34.060][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:45:34.118][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:45:34.177][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:45:34.235][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:45:34.292][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:45:34.350][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:45:34.645][INFO][RK0][main]: Evaluation, AverageLoss: 0.146364\n",
      "[HCTR][08:45:34.645][INFO][RK0][main]: Eval Time for 70 iters: 4.09159s\n",
      "[HCTR][08:45:50.040][INFO][RK0][main]: Iter: 300 Time(100 iters): 19.3843s Loss: 0.158335 lr:0.5\n",
      "[HCTR][08:45:53.544][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:45:53.603][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:45:53.660][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:45:53.720][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:45:53.778][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:45:53.836][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:45:53.894][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:45:53.953][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:45:54.121][INFO][RK0][main]: Evaluation, AverageLoss: 0.148422\n",
      "[HCTR][08:45:54.121][INFO][RK0][main]: Eval Time for 70 iters: 4.08104s\n",
      "[HCTR][08:46:09.558][INFO][RK0][main]: Iter: 400 Time(100 iters): 19.5178s Loss: 0.139716 lr:0.5\n",
      "[HCTR][08:46:12.751][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:46:12.868][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:46:12.926][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:46:13.164][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:46:13.280][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:46:13.457][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:46:13.514][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:46:13.574][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:46:13.683][INFO][RK0][main]: Evaluation, AverageLoss: 0.139018\n",
      "[HCTR][08:46:13.683][INFO][RK0][main]: Eval Time for 70 iters: 4.12495s\n",
      "[HCTR][08:46:29.073][INFO][RK0][main]: Iter: 500 Time(100 iters): 19.4974s Loss: 0.139979 lr:0.5\n",
      "[HCTR][08:46:32.347][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:46:32.403][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:46:32.462][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:46:32.521][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:46:32.579][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:46:32.637][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:46:32.696][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:46:32.754][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:46:33.157][INFO][RK0][main]: Evaluation, AverageLoss: 0.138041\n",
      "[HCTR][08:46:33.157][INFO][RK0][main]: Eval Time for 70 iters: 4.08385s\n",
      "[HCTR][08:46:39.671][DEBUG][RK0][tid #139614253741824]: file_name_ deepfm_data_nvt/train/0.1738817c5c5c47dba75a428d0837cbc3.parquet file_total_rows_ 4586722\n",
      "[HCTR][08:46:39.823][DEBUG][RK0][tid #139614371174144]: file_name_ deepfm_data_nvt/train/1.c7b6f2423fec47ff97a09ec95f6346f9.parquet file_total_rows_ 4585117\n",
      "[HCTR][08:46:39.973][DEBUG][RK0][tid #139618506761984]: file_name_ deepfm_data_nvt/train/2.6b134d3f8f0a4f0d9453f1d7c08f74d5.parquet file_total_rows_ 4584304\n",
      "[HCTR][08:46:40.125][DEBUG][RK0][tid #139614505387776]: file_name_ deepfm_data_nvt/train/3.4b192542e2ad4cc8b745feb142d1878a.parquet file_total_rows_ 4581022\n",
      "[HCTR][08:46:40.284][DEBUG][RK0][tid #139614387959552]: file_name_ deepfm_data_nvt/train/4.4f7e95ed8f9b4bcc9b63c5f3278e6905.parquet file_total_rows_ 4580476\n",
      "[HCTR][08:46:40.431][DEBUG][RK0][tid #139614379566848]: file_name_ deepfm_data_nvt/train/5.c5b89db1e82d4842998d560796eab838.parquet file_total_rows_ 4583901\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[HCTR][08:46:40.586][DEBUG][RK0][tid #139614119524096]: file_name_ deepfm_data_nvt/train/6.92133f3ee3664684854969202958122f.parquet file_total_rows_ 4581782\n",
      "[HCTR][08:46:41.968][DEBUG][RK0][tid #139614111131392]: file_name_ deepfm_data_nvt/train/7.9345ade3421b40a5803f518c48ae436f.parquet file_total_rows_ 4589169\n",
      "[HCTR][08:46:48.555][INFO][RK0][main]: Iter: 600 Time(100 iters): 19.4819s Loss: 0.134819 lr:0.5\n",
      "[HCTR][08:46:51.959][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:46:52.017][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:46:52.075][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:46:52.134][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:46:52.193][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:46:52.253][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:46:52.313][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:46:52.372][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:46:52.663][INFO][RK0][main]: Evaluation, AverageLoss: 0.137611\n",
      "[HCTR][08:46:52.663][INFO][RK0][main]: Eval Time for 70 iters: 4.1073s\n",
      "[HCTR][08:47:08.048][INFO][RK0][main]: Iter: 700 Time(100 iters): 19.4769s Loss: 0.140394 lr:0.5\n",
      "[HCTR][08:47:11.590][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:47:11.647][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:47:11.706][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:47:11.765][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:47:11.824][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:47:11.881][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:47:11.940][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:47:11.998][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:47:12.171][INFO][RK0][main]: Evaluation, AverageLoss: 0.138108\n",
      "[HCTR][08:47:12.171][INFO][RK0][main]: Eval Time for 70 iters: 4.1189s\n",
      "[HCTR][08:47:27.578][INFO][RK0][main]: Iter: 800 Time(100 iters): 19.5118s Loss: 0.141259 lr:0.5\n",
      "[HCTR][08:47:30.764][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:47:30.880][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:47:30.938][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:47:31.175][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:47:31.292][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:47:31.467][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:47:31.525][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:47:31.584][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:47:31.692][INFO][RK0][main]: Evaluation, AverageLoss: 0.137271\n",
      "[HCTR][08:47:31.692][INFO][RK0][main]: Eval Time for 70 iters: 4.11364s\n",
      "[HCTR][08:47:47.105][INFO][RK0][main]: Iter: 900 Time(100 iters): 19.3756s Loss: 0.13619 lr:0.5\n",
      "[HCTR][08:47:50.398][DEBUG][RK0][tid #139614102738688]: file_name_ deepfm_data_nvt/val/0.35ab81b16b4a409ba42a1baf89dcba52.parquet file_total_rows_ 571942\n",
      "[HCTR][08:47:50.455][DEBUG][RK0][tid #139609623230208]: file_name_ deepfm_data_nvt/val/1.01854d707a564342aef3af44b814de1c.parquet file_total_rows_ 573919\n",
      "[HCTR][08:47:50.513][DEBUG][RK0][tid #139609614837504]: file_name_ deepfm_data_nvt/val/2.7d7593c16af64625973ed246f68af624.parquet file_total_rows_ 572137\n",
      "[HCTR][08:47:50.573][DEBUG][RK0][tid #139609606444800]: file_name_ deepfm_data_nvt/val/3.eec657484d40418cbf2648541592d09e.parquet file_total_rows_ 572545\n",
      "[HCTR][08:47:50.631][DEBUG][RK0][tid #139609220577024]: file_name_ deepfm_data_nvt/val/4.e60c2f9421d84490bbc4de5f15ec5a0f.parquet file_total_rows_ 573664\n",
      "[HCTR][08:47:50.690][DEBUG][RK0][tid #139609212184320]: file_name_ deepfm_data_nvt/val/5.883be83fecd74c1fbac00321911f2787.parquet file_total_rows_ 573448\n",
      "[HCTR][08:47:50.747][DEBUG][RK0][tid #139609203791616]: file_name_ deepfm_data_nvt/val/6.0f6ed30e74dc49668d1e1011e819e9e3.parquet file_total_rows_ 573727\n",
      "[HCTR][08:47:50.805][DEBUG][RK0][tid #139609086359296]: file_name_ deepfm_data_nvt/val/7.9e48c14d9bde498a8ef5d840d636d276.parquet file_total_rows_ 572680\n",
      "[HCTR][08:47:51.207][INFO][RK0][main]: Evaluation, AverageLoss: 0.137273\n",
      "[HCTR][08:47:51.207][INFO][RK0][main]: Eval Time for 70 iters: 4.1011s\n",
      "[HCTR][08:48:06.342][INFO][RK0][main]: Finish 1000 iterations with batchsize: 65536 in 190.83s.\n"
     ]
    }
   ],
   "source": [
    "!python3 dlrm_train.py ./distributed_plan.json"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c87071e6",
   "metadata": {},
   "source": [
    "### Performance Comparison for the Different ETPS\n",
    "\n",
    "The iteration duration for the data parallel and model parallel strategy is `103.45s`.\n",
    "For the distributed strategy, the duration is `190.85s`.\n",
    "This comparison shows how different ETPS can greatly affect the performance of embedding.\n",
    "The results show that performance is better if you configure the embedding table as data parallel or localized when the table can fit on a single GPU."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.10"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
